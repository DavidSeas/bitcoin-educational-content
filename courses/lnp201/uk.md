---
name: Теоретичне введення в Мережу Блискавки
goal: Вивчення Мережі Блискавки з технічної точки зору
objectives:
  - Розуміння принципу роботи каналів мережі.
  - Знайомство з термінами, такими як HTLC, LNURL та UTXO.
  - Засвоєння управління ліквідністю та комісіями в LNN.
  - Визнання Мережі Блискавки як мережі.
  - Розуміння теоретичного використання Мережі Блискавки.
---

# Подорож до другого рівня Bitcoin

Цей курс є теоретичним уроком про технічне функціонування Мережі Блискавки.

Ласкаво просимо до захоплюючого світу Мережі Блискавки, другого рівня Bitcoin, який є одночасно складним і повним потенціалу. Ми збираємося зануритися в технічні глибини цієї технології, не зосереджуючись на конкретних підручниках або сценаріях використання. Для максимальної користі з цього курсу важливе глибоке розуміння Bitcoin. Це досвід, який вимагає серйозного та зосередженого підходу. Ви також можете розглянути можливість паралельного проходження курсу LN 202, який пропонує більш практичний аспект цього дослідження. Готуйтеся до подорожі, яка може змінити ваше сприйняття екосистеми Bitcoin.

Насолоджуйтесь відкриттям!

+++

# Основи
<partId>32647d62-102b-509f-a3ba-ad1d6a4345f1</partId>

## Розуміння Мережі Блискавки
<chapterId>df6230ae-ff35-56ea-8651-8e65580730a8</chapterId>

![відео en](https://youtu.be/QDQ8NG0l3hk)

Мережа Блискавки - це інфраструктура платежів другого рівня, побудована на мережі Bitcoin, яка дозволяє здійснювати швидкі та недорогі транзакції. Для повного розуміння того, як працює Мережа Блискавки, важливо зрозуміти, що таке платіжні канали та як вони функціонують.

Платіжний канал Мережі Блискавки - це свого роду "приватна доріжка" між двома користувачами, яка дозволяє здійснювати швидкі та повторювані транзакції Bitcoin. Коли канал відкривається, йому присвоюється фіксована ємність, яка заздалегідь визначається користувачами. Ця ємність представляє максимальну кількість Bitcoin, яка може бути передана в каналі в будь-який момент часу.

Платіжні канали є двонаправленими, що означає, що вони мають дві "сторони". Наприклад, якщо Аліса та Боб відкривають платіжний канал, Аліса може надсилати Bitcoin Бобу, а Боб може надсилати Bitcoin Алісі. Транзакції всередині каналу не змінюють загальну ємність каналу, але вони змінюють розподіл цієї ємності між Алісою та Бобом.

![пояснення](assets/chapitre1/0.webp)

Для можливості транзакції в платіжному каналі Мережі Блискавки користувач, який надсилає кошти, повинен мати достатньо Bitcoin на своїй стороні каналу. Якщо Аліса хоче надіслати 1 Bitcoin Бобу через їх канал, вона повинна мати принаймні 1 Bitcoin на своїй стороні каналу.
Ліміти та Функціонування Платіжних Каналів в Мережі Блискавки.
Незважаючи на те, що ємність платіжного каналу Мережі Блискавки є фіксованою, це не обмежує загальну кількість транзакцій або загальний обсяг Bitcoin, який може бути переданий через канал. Наприклад, якщо Аліса та Боб мають канал з ємністю 1 Bitcoin, вони можуть здійснити сотні транзакцій по 0.01 Bitcoin або тисячі транзакцій по 0.001 Bitcoin, доки загальна ємність каналу не буде перевищена в будь-який момент часу.

Незважаючи на ці обмеження, платіжні канали Мережі Блискавки є ефективним способом здійснення швидких та недорогих транзакцій Bitcoin. Вони дозволяють користувачам надсилати та отримувати Bitcoin без необхідності платити високі комісії за транзакції або чекати довгих періодів підтвердження на мережі Bitcoin.
Підсумовуючи, канали Lightning пропонують потужне рішення для тих, хто хоче здійснювати швидкі та недорогі транзакції в Bitcoin. Однак, важливо розуміти їхню роботу та обмеження, щоб повною мірою скористатися їхніми перевагами.
![пояснення](assets/chapitre1/1.webp)

Приклад:

- У Аліси є 100,000 SAT
- У Боба є 30,000 SAT

Це поточний стан каналу. Під час транзакції Аліса вирішує відправити 40,000 SAT Бобу. Вона може це зробити, тому що 40,000 < 100,000.

Новий стан каналу, отже:

- Аліса 60,000 SAT
- Боб 70,000 SAT

```
Початковий стан каналу:
Аліса (100,000 SAT) ============== Боб (30,000 SAT)

Після переказу Алісою 40,000 SAT Бобу:
Аліса (60,000 SAT) ============== Боб (70,000 SAT)

```
![пояснення](assets/chapitre1/2.webp)

Тепер Боб хоче відправити 80,000 SAT Алісі. Не маючи достатньої ліквідності, він не може цього зробити. Максимальна ємність каналу становить 130,000 SAT, з можливим витратом до 60,000 SAT для Аліси та 70,000 SAT для Боба.

![пояснення](assets/chapitre1/3.webp)

## Bitcoin, адреси, UTXO та транзакції
<chapterId>0cfb7e6b-96f0-508b-9210-90bc1e28649d</chapterId>

![відео](https://youtu.be/U9l5IVriCss)

У цьому другому розділі ми приділяємо час вивченню того, як насправді працюють транзакції в Bitcoin, що буде дуже корисним для розуміння Lightning. Ми також коротко обговорюємо концепцію адрес мультипідпису, яка є критично важливою для розуміння наступного розділу про відкриття каналів у мережі Lightning.

- Приватний ключ > Публічний ключ > Адреса: Під час транзакції Аліса відправляє гроші Бобу. Останній надає адресу, отриману від його публічного ключа. Аліса, яка сама отримала гроші на адресу через свій публічний ключ, тепер використовує свій приватний ключ для підписання транзакції та таким чином розблокує біткоїни з адреси.
- У транзакції Bitcoin всі біткоїни мають рухатися. Названі UTXO (Unspend Transaction Output), шматочки біткоїна всі покидають лише для того, щоб потім повернутися до власника.
  У Аліси є 0.002 BTC, у Боба 0 BTC. Аліса вирішує відправити 0.0015 BTC Бобу. Вона підпише транзакцію на 0.002 BTC, де 0.0015 підуть Бобу, а 0.0005 повернуться до її гаманця.

![пояснення](assets/chapitre2/0.webp)

Тут, з одного UTXO (у Аліси є 0.0002 BTC на адресі), ми створили 2 UTXO (у Боба є 0.0015 і у Аліси новий UTXO (незалежний від попереднього) 0.0005 BTC).

```
Аліса (0.002 BTC)
  |
  V
Транзакція Bitcoin (0.002 BTC)
  |
  |----> Боб (0.0015 BTC)
  |
  V
Аліса (новий UTXO: 0.0005 BTC)
```
У Lightning Network використовуються мультипідписи. Тому для розблокування коштів потрібні 2 підписи, тобто два приватні ключі для переміщення грошей. Це можуть бути Аліса та Боб, які разом мають домовитися про розблокування коштів (UTXO). Конкретно в LN це транзакції 2/2, тому обидва підписи абсолютно необхідні, на відміну від мультипідписів 2/3 або 3/5, де потрібна лише комбінація повної кількості ключів.
![пояснення](assets/chapitre2/1.webp)

# Відкриття та закриття каналів
<partId>900b5b6b-ccd0-5b2f-9424-4b191d0e935d</partId>

## Відкриття каналу
<chapterId>96243eb0-f6b5-5b68-af1f-fffa0cc16bfe</chapterId>

![відео](https://youtu.be/Ty80WuN5X-g)

Тепер ми детальніше розглянемо, як відбувається відкриття каналу через біткойн-транзакцію.

Lightning Network має різні рівні комунікації:

- P2P комунікація (протокол Lightning Network)
- Платіжний канал (протокол Lightning Network)
- Біткойн-транзакція (протокол Bitcoin)

![пояснення](assets/chapitre3/0.webp)

Для відкриття каналу два учасники спілкуються через комунікаційний канал:

- Аліса: "Привіт, я хочу відкрити канал!"
- Боб: "Окей, ось моя публічна адреса."

![пояснення](assets/chapitre3/1.webp)

Тепер у Аліси є 2 публічні адреси для створення мультипідписної адреси 2/2. Вона може здійснити біткойн-транзакцію, щоб відправити гроші на неї.

Припустимо, у Аліси є UTXO на 0.002 BTC, і вона хоче відкрити канал з Бобом на 0.0013 BTC. Вона створить транзакцію з 2 UTXO як вихід:

- UTXO на 0.0013 до мультипідписної адреси 2/2
- UTXO на 0.0007 на одну з її адрес здачі (повернення UTXO).

Ця транзакція ще не публічна, тому що на цьому етапі вона довіряє Бобу, що він зможе розблокувати гроші з мультипідпису.

Але як тоді діяти?

Аліса створює другу транзакцію, названу "транзакцією зняття", перш ніж публікувати депозит коштів у мультипідпис.

![пояснення](assets/chapitre3/2.webp)

Транзакція зняття витрачає кошти з мультипідписної адреси на адресу Аліси (це робиться до публікації всього).
Як тільки обидві транзакції побудовані, Аліса повідомляє Бобу, що все готово, і просить його підписати своїм публічним ключем, пояснюючи, що таким чином вона може відновити свої кошти, якщо щось піде не так. Боб погоджується, бо він не нечесний.

Тепер Аліса може самостійно відновити кошти, оскільки вона вже має підпис Боба. Вона публікує транзакції. Канал тепер відкритий з 0.0013 BTC (130,000 SAT) на стороні Аліси.

![пояснення](assets/chapitre3/3.webp)

## Транзакція Lightning & Транзакція зобов'язань
<chapterId>7d3fd135-129d-5c5a-b306-d5f2f1e63340</chapterId>

![відео](https://youtu.be/dzPMGiR_JSE)

![обкладинка](assets/chapitre4/1.webp)
Тепер вивчимо, що насправді відбувається за лаштунками під час переказу коштів з одного боку на інший каналу в мережі Lightning, з урахуванням поняття транзакції зобов'язання. Транзакція виведення коштів/закриття каналу в блокчейні представляє стан каналу, гарантуючи, кому належать кошти після кожного переказу. Таким чином, після переказу в мережі Lightning відбувається оновлення цієї транзакції/контракту, яке не виконується між двома учасниками, Алісою та Бобом, які створюють однакову транзакцію з поточним станом каналу у випадку закриття:
- Аліса відкриває канал з Бобом з 130,000 SAT на своєму боці. Транзакція виведення коштів, прийнята обома у випадку закриття, стверджує, що 130,000 SAT перейдуть до Аліси при закритті, і Боб погоджується, бо це справедливо.

![cover](assets/chapitre4/2.webp)

- Аліса відправляє 30,000 SAT Бобу. Тепер існує нова транзакція виведення коштів, яка стверджує, що у випадку закриття Аліса отримає 100,000 SAT, а Боб - 30,000 SAT. Обидва погоджуються, бо це справедливо.

![cover](assets/chapitre4/3.webp)

- Аліса відправляє 10,000 SAT Бобу, і створюється нова транзакція виведення коштів, яка стверджує, що Аліса отримає 90,000 SAT, а Боб - 40,000 SAT у випадку закриття. Обидва погоджуються, бо це справедливо.

![cover](assets/chapitre4/4.webp)

```
Початковий стан каналу:
Аліса (130,000 SAT) =============== Боб (0 SAT)

Після першого переказу:
Аліса (100,000 SAT) =============== Боб (30,000 SAT)

Після другого переказу:
Аліса (90,000 SAT) =============== Боб (40,000 SAT)

```

Гроші насправді не переміщуються, але кінцевий баланс оновлюється через підписану, але не опубліковану транзакцію в блокчейні. Таким чином, транзакція виведення коштів є транзакцією зобов'язання. Перекази сатоші є іншою, більш новою транзакцією зобов'язання, яка оновлює баланс.

## Транзакції зобов'язання
<chapterId>f2f61e5b-badb-5947-9a81-7aa530b44e59</chapterId>

![video](https://youtu.be/veCs39uVFUk)

Якщо транзакції зобов'язання визначають стан каналу з ліквідністю на момент X, чи можемо ми обдурити, опублікувавши старий стан? Відповідь - так, оскільки ми вже маємо попередній підпис обох учасників у неопублікованій транзакції.

![instruction](assets/Chapitre5/0.webp)

Щоб вирішити цю проблему, ми додамо складності:

- Timelock = кошти заблоковані до блоку N
- Revocation key = секрет Аліси та секрет Боба'

Ці два елементи додаються до транзакції зобов'язання. В результаті, Алісі доведеться чекати закінчення Timelock, і будь-хто, хто має revocation key, може перемістити кошти, не чекаючи закінчення Timelock. Якщо Аліса спробує обдурити, Боб використовує revocation key, щоб вкрасти і покарати Алісу.

![instruction](assets/Chapitre5/1.webp)
Зараз (і насправді) транзакція зобов'язання не є однаковою для Аліси та Боба, вони симетричні, але кожна має різні обмеження, вони дають один одному свій секрет, щоб створити ключ анулювання попередньої транзакції зобов'язання. Таким чином, на момент створення, Аліса створює канал з Бобом, 130,000 SAT з її боку, вона має Timelock, який не дозволяє їй негайно отримати свої гроші назад, їй потрібно зачекати трохи. Ключ анулювання може розблокувати гроші, але тільки Аліса має його (транзакція зобов'язання Аліси). Як тільки відбувається переказ, Аліса надає свій старий секрет Бобу, і тому останній зможе спорожнити канал до попереднього стану у випадку, якщо Аліса спробує обдурити (Аліса, отже, покарана).

![instruction](assets/Chapitre5/2.webp)

Аналогічно, Боб надає свій секрет Алісі. Таким чином, якщо він спробує обдурити, Аліса може покарати його. Операція повторюється для кожної нової транзакції зобов'язання. Вирішується новий секрет і новий ключ анулювання. Таким чином, для кожної нової транзакції попередня транзакція зобов'язання має бути знищена, надавши секрет анулювання. Таким чином, якщо Аліса або Боб спробують обдурити, інший може діяти раніше (завдяки Timelock) і таким чином уникнути обману. Під час транзакції №3 секрет транзакції №2, отже, надається, щоб дозволити Алісі та Бобу захиститися від Аліси або Боба.

![instruction](assets/Chapitre5/3.webp)

Особа, яка створює транзакцію з Timelock (та, яка відправляє гроші), може використовувати ключ анулювання тільки після Timelock. Однак, особа, яка отримує гроші, може використовувати його до Timelock у випадку обману з одного боку на інший каналу в мережі Lightning. Зокрема, ми детально розглядаємо механізми, які дозволяють нам захиститися від можливого обману з боку свого партнера всередині каналу.

## Закриття каналу
<chapterId>29a72223-2249-5400-96f0-3756b1629bc2</chapterId>

![video](https://youtu.be/zmAa2fj_V7w)

Ми зацікавлені в закритті каналу через транзакцію Bitcoin, яка може приймати різні форми залежно від випадку. Існує 3 типи закриття каналу:

- Добре: кооперативне закриття
- Грубе: примусове закриття (некооперативне)
- Обман: закриття шахраєм

![instruction](assets/chapitre6/1.webp)
![instruction](assets/chapitre6/0.webp)


### Добре

Дві сторони спілкуються і домовляються про закриття каналу. Вони припиняють усі транзакції і валідують остаточний стан каналу. Вони домовляються про мережеві збори (особа, яка відкрила канал, платить збори за закриття). Тепер вони створюють транзакцію закриття. Це транзакція закриття, відрізняється від транзакцій зобов'язання, тому що немає Timelock і ключа анулювання. Транзакція потім публікується, і Аліса та Боб отримують свої відповідні баланси. Цей тип закриття швидкий (тому що немає Timelock) і зазвичай недорогий.

![instruction](assets/chapitre6/3.webp)


### Грубе
Аліса хоче закрити канал, але Боб не відповідає, оскільки він не в мережі (відсутність інтернету або відключення електроенергії). Тоді Аліса публікує найновішу транзакцію зобов'язань (останню). Транзакція публікується, і активується Timelock. Потім, комісії були визначені, коли ця транзакція була створена X часу тому! MemPool - це мережа, яка змінилася з того часу, тому протокол за замовчуванням встановлює комісії в 5 разів вищі, ніж поточні на момент створення транзакції. Комісія за створення 10 SAT, тому транзакція розглядається як 50 SAT. У момент примусового закриття, мережа є:
- 1 SAT = переплачено на 50\*
- 100 SAT = недоплачено на 2\*

Це робить примусове закриття довшим (Timelock) і особливо ризикованим з точки зору комісій та можливої валідації майнерами.

![instruction](assets/chapitre6/4.webp)

### Шахрай

Аліса намагається обдурити, публікуючи стару транзакцію зобов'язань. Але Боб моніторить MemPool і стежить за транзакціями, які намагаються опублікувати старі. Якщо він знаходить такі, він використовує ключ скасування, щоб покарати Алісу і забрати всі SAT з каналу.

![instruction](assets/chapitre6/5.webp)

На завершення, закриття каналу в Lightning Network є критично важливим кроком, який може приймати різні форми. При співпрацюючому закритті обидві сторони спілкуються і домовляються про остаточний стан каналу. Це найшвидший і найменш витратний варіант. З іншого боку, примусове закриття відбувається, коли одна зі сторін не реагує. Це більш дорогий і тривалий процес через непередбачувані комісії за транзакції та активацію Timelock. Нарешті, якщо учасник намагається обдурити, публікуючи стару транзакцію зобов'язань, шахрай, він може бути покараний втратою всіх SAT з каналу. Тому критично важливо розуміти ці механізми для ефективного і справедливого використання Lightning Network.

# Мережа ліквідності
<partId>a873f1cb-751f-5f4a-9ed7-25092bfdef11</partId>

## Lightning Network
<chapterId>45a7252c-fa4f-554b-b8bb-47449532918e</chapterId>

![video](https://youtu.be/44oBdNdXtEQ)

У цьому сьомому розділі ми вивчаємо, як Lightning працює як мережа каналів і як платежі маршрутизуються від їх джерела до місця призначення.

![cover](assets/Chapitre7/0.webp)
![cover](assets/Chapitre7/1.webp)

Lightning - це мережа платіжних каналів. Тисячі учасників з власними каналами ліквідності з'єднані один з одним, і таким чином самодостатньо здійснюють транзакції між не з'єднаними учасниками. Ліквідність цих каналів не може бути передана до інших каналів ліквідності.

Alice -> Eden - > Bob`. Сатоші не перемістилися з `Alice -> Bob`, а з `Alice -> Eden` і з `Eden -> Bob`.

Таким чином, кожна особа та канал мають різну ліквідність. Для здійснення платежів потрібно знайти маршрут у мережі з достатньою ліквідністю. Якщо її недостатньо, платіж не пройде.

Розглянемо наступну мережу:

```
Початковий стан мережі:
Alice (130 SAT) ==== (0 SAT) Susie (90 SAT) ==== (200 SAT) Eden (150 SAT) ==== (100 SAT) Bob
```
![cover](assets/Chapitre7/2.webp)

Якщо Алісі потрібно перевести 40 SAT Бобу, то ліквідність буде перерозподілена вздовж маршруту між двома сторонами.

```
Після того, як Аліса переводить 40 SAT Бобу:
Аліса (90 SAT) ==== (40 SAT) Сюзі (50 SAT) ==== (240 SAT) Еден (110 SAT) ==== (140 SAT) Боб

![cover](assets/Chapitre7/4.webp)

Однак, у початковому стані, Боб не може відправити 40 SAT Алісі, оскільки Сюзі не має жодної ліквідності з Алісою для відправлення 40 SAT, тому платіж через цей маршрут неможливий. Тому нам потрібен інший маршрут, де транзакція можлива.

У першому прикладі очевидно, що Сюзі та Еден нічого не втратили і не отримали. Вузли Lightning Network стягують плату за згоду використовувати їх для маршрутизації транзакції!

Існують різні плати залежно від місцезнаходження ліквідності

Аліса - Боб

- Плата Аліси = Аліса -> Боб
- Плата Боба = Боб -> Аліса

![cover](assets/Chapitre7/5.webp)

Існують два типи плати:

- фіксована плата незалежно від суми: 1 SAT (за замовчуванням, але може бути змінена)
- змінна плата (0.01% за замовчуванням)

Приклад плати:

- Аліса - Сюзі; 1/1 (1 фіксована плата і 1 змінна плата)
- Сюзі - Еден; 0/200
- Еден - Боб; 1/1

Отже:

- Плата 1: (сплачена Алісою самій собі) 1 + (40,000\*0.000001)
- Плата 2: 0 + 40,000 \* 0.0002 = 8 SAT
- Плата 3: 1 + 40,000\* 0.000001 = 1.04 SAT

![cover](assets/Chapitre7/6.webp)

Відправлення:

1. Відправлення 40,009.04 Аліса -> Сюзі; Аліса платить свої витрати, тому це не враховується
2. Сюзі робить Едену послугу, відправляючи 40 001.04; вона бере цю комісію 8 SAT
3. Еден робить послугу, відправляючи 40,000 Бобу, він бере свою плату 1.04 SAT.

Аліса заплатила плату 9.04 SAT, а Боб отримав 40,000 SAT.

![cover](assets/Chapitre7/7.webp)

У Lightning Network вузол Аліси вирішує маршрут перед відправленням платежу. Тому відбувається пошук найкращого маршруту, і тільки Аліса знає маршрут і ціну. Платіж відправляється, але Сюзі не має інформації.

![cover](assets/Chapitre7/9.webp)

Для Сюзі або Едена: вони не знають, хто є остаточним отримувачем, ні хто відправляє платіж. Це маршрутизація через цибулю. Вузол повинен зберігати план мережі, щоб знайти свій маршрут, але жоден з посередників не має інформації.

## HTLC - Hashed Time Locked Contract
<chapterId>4369b85a-1365-55d8-99e1-509088210116</chapterId>

![video](https://youtu.be/jI4nM297aHA)

У традиційній системі маршрутизації, як можемо ми гарантувати, що Еден не обмане і виконає свою частину контракту?

HTLC - це платіжний контракт, який може бути розблокований лише за допомогою секрету. Якщо він не розкритий, то контракт закінчується. Таким чином, це умовний платіж. Як вони використовуються?

![instruction](assets/chapitre8/0.webp)

Розглянемо наступну ситуацію:
Alice (100,000 SAT) ==== (30,000 SAT) Susie (250,000 SAT) ==== (0 SAT) Bob
- Боб генерує секрет S (попереднє зображення) і розраховує хеш r = hash(s)
- Боб висилає рахунок-фактуру Алісі з включеним "r"
- Аліса відправляє HTLC на 40,000 SAT Сюзі з умовою розкриття "s'", так що hash(s') = r
- Сюзі відправляє подібний HTLC Бобу
- Боб розблокує HTLC Сюзі, показавши їй "s"
- Сюзі розблокує HTLC Аліси, показавши їй "S"

Якщо Боб не в мережі і ніколи не отримує секрет, який дає йому легітимність отримати гроші, то HTLC закінчиться після певної кількості блоків.

![інструкція](assets/chapitre8/1.webp)

HTLC закінчуються в зворотному порядку: спочатку закінчення Сюзі-Боб, потім Аліса-Сюзі. Таким чином, якщо Боб повертається, це нічого не змінює. В іншому випадку, якщо Аліса скасовує, поки Боб повертається, це буде плутанина і люди можуть працювати даремно.

Отже, що відбувається у випадку закриття? Насправді, наші транзакції зобов'язань ще більш складні. Нам потрібно представити проміжний баланс, якщо канал закритий.

Таким чином, в транзакції зобов'язань є HTLC-out на 40,000 сатоші (з обмеженнями, зазначеними раніше) через вихід #3.

![інструкція](assets/chapitre8/2.webp)

В транзакції зобов'язань Аліси є:

- Вихід #1: 60,000 SAT для Аліси через Timelock і ключ відкликання (що залишається для неї)
- Вихід #2: 30,000, які вже належать Сюзі
- Вихід #3: 40,000 в HTLC

Транзакція зобов'язань Аліси є з HTLC-out, тому що вона відправляє HTLC-in одержувачу, Сюзі.

![інструкція](assets/chapitre8/3.webp)

Таким чином, якщо ми публікуємо цю транзакцію зобов'язань, Сюзі може отримати гроші HTCL з "s" зображенням. Якщо вона не має попереднього зображення, Аліса отримує гроші, як тільки HTCL закінчується. Думайте про виходи (UTXO) як про різні платежі з різними умовами.
Як тільки платіж здійснено (закінчення або виконання), стан каналу змінюється, і транзакція з HTCL більше не існує. Ми повертаємося до чогось класичного.
У випадку кооперативного закриття: ми зупиняємо платежі і тому чекаємо на виконання переказів/HTCL, транзакція легка, тому менш дорога, оскільки є максимум 1 або 2 виходи.
Якщо примусове закриття: ми публікуємо з усіма HTLC, що тривають, тому це стає дуже важким і дуже дорогим. І це плутанина.

Підсумовуючи, система маршрутизації Lightning Network використовує Hash Time-Locked Contracts (HTLC) для забезпечення безпечних і перевірених платежів. HTLC дозволяють умовні платежі, де гроші можуть бути розблоковані лише за допомогою секрету, таким чином забезпечуючи виконання зобов'язань учасниками.
У представленому прикладі, Аліса хоче відправити SAT Бобу через Сюзі. Боб генерує секрет, створює хеш з нього і передає його Алісі. Аліса та Сюзі налаштовують HTLC на основі цього хешу. Як тільки Боб розблокує HTLC Сюзі, показавши їй секрет, Сюзі може потім розблокувати HTLC Аліси.
У випадку, якщо Боб не розкриває секрет протягом певного періоду часу, HTLC закінчується. Закінчення відбувається в зворотному порядку, забезпечуючи, що якщо Боб повертається в мережу, небажаних наслідків не виникає.
При закритті каналу, якщо це співпрацююче закриття, платежі перериваються, а HTLC вирішуються, що, як правило, є менш витратним. Якщо закриття є примусовим, всі поточні транзакції HTLC публікуються, що може стати дуже дорогим і заплутаним. Підсумовуючи, механізм HTLC додає додатковий рівень безпеки до Lightning Network, забезпечуючи правильне виконання платежів та виконання користувачами своїх зобов'язань.

## Знаходження свого шляху
<chapterId>7e2ae959-c2a1-512e-b5d6-8fd962e819da</chapterId>

![відео](https://youtu.be/CqetCElRjUQ)

Єдина публічна дана - це загальна місткість каналу (Аліса + Боб), але ми не знаємо, де розташована ліквідність.
Щоб отримати більше інформації, наш вузол слухає комунікаційний канал LN для оголошень про нові канали та оновлення комісій за канал. Ваш вузол також дивиться на блокчейн для закриття каналів.

Оскільки ми не маємо всієї інформації, ми повинні шукати граф/маршрут з інформацією, яку маємо (максимальна місткість каналу, а не де розташована ліквідність).

Критерії:

- Ймовірність успіху - Комісії
- Час закінчення HTLC
- Кількість проміжних вузлів
- Випадковість

![граф](assets/chapitre9/1.webp)

Отже, якщо є 3 можливі маршрути:

- Аліса > 1 > 2 > 5 > Боб
- Аліса > 1 > 2 > 4 > 5 > Боб
- Аліса 1 > 2 > 3 > Боб

Ми шукаємо найкращий маршрут теоретично з найнижчими комісіями та найвищою шансом на успіх: максимальна ліквідність та найменша кількість стрибків.

Наприклад, якщо 2-3 має лише місткість 130,000 SAT, відправлення 100,000 є дуже малоймовірним, тому варіант №3 не має шансів на успіх.

![граф](assets/chapitre9/2.webp)

Тепер алгоритм зробив свої 3 вибори і спробує перший:

Вибір 1:

- Аліса відправляє HTLC на 100,000 SAT до 1;
- 1 робить HTLC на 100,000 SAT до 2;
- 2 робить HTLC на 100,000 SAT до 5, але 5 не може це зробити, тому оголошує про це.

Інформація відправляється назад, тому Аліса вирішує спробувати другий маршрут:

- Аліса відправляє HTLC на 100,000 до 1;
- 1 робить HTLC на 100,000 до 2;
- 2 робить HTLC на 100,000 до 4;
- 4 робить HTLC на 100,000 до Боба. У Боба є ліквідність, тому все добре.
- Боб використовує preimage (хеш) HTLC і таким чином використовує секрет, щоб отримати 100,000 SAT
- 5 тепер має секрет HTLC, щоб отримати заблокований HTLC від 4
- 4 тепер має секрет HTLC, щоб отримати заблокований HTLC від 2
- 2 тепер має секрет HTLC, щоб отримати заблокований HTLC від 1
- 1 тепер має секрет HTLC, щоб отримати заблокований HTLC від Аліси

Аліса не бачила невдачі маршруту 1, вона просто чекала одну секунду довше. Невдача платежу відбувається, коли немає можливого маршруту. Щоб полегшити пошук маршруту, Боб може надати інформацію Алісі, щоб допомогти з її рахунком:

- Сума
- Його адреса
- Хеш preimage, щоб Аліса могла створити HTLC
- Вказівки щодо каналів Боба
Боб знає про ліквідність каналів 5 та 3, оскільки він безпосередньо до них підключений, він може повідомити про це Алісі. Він попереджає Алісу, що вузол 3 є непотрібним, що запобігає потенційному створенню Алісою свого маршруту.
Іншим елементом можуть бути приватні канали (отже, не опубліковані в мережі), які може мати Боб. Якщо у Боба є приватний канал з 1, він може сказати Алісі використати його, і це дало би Алісі > 1 > Боб'.

![граф](assets/chapitre9/3.webp)

На завершення, маршрутизація транзакцій у Lightning Network є складним процесом, який вимагає врахування різних факторів. Хоча загальна ємність каналів є публічною, точний розподіл ліквідності не є безпосередньо доступним. Це змушує вузли оцінювати найбільш ймовірні успішні маршрути, враховуючи критерії, такі як комісії, час закінчення HTLC, кількість проміжних вузлів та фактор випадковості. Коли можливі кілька маршрутів, вузли прагнуть мінімізувати комісії та максимізувати шанси на успіх, обираючи канали з достатньою ліквідністю та мінімальною кількістю переходів. Якщо спроба транзакції зазнає невдачі через недостатню ліквідність, спроба іншого маршруту триває до здійснення успішної транзакції.

Крім того, для полегшення пошуку маршрутів, одержувач може надати додаткову інформацію, таку як адреса, сума, хеш попереднього зображення та вказівки щодо своїх каналів. Це може допомогти ідентифікувати канали з достатньою ліквідністю та уникнути непотрібних спроб транзакцій. Врешті-решт, система маршрутизації Lightning Network розроблена для оптимізації швидкості, безпеки та ефективності транзакцій, зберігаючи при цьому конфіденційність користувачів.

# Інструменти Lightning Network
<partId>74d6c334-ec5d-55d9-8598-f05694703bf6</partId>

## Рахунок-фактура, LNURL, Keysend
<chapterId>e34c7ecd-2327-52e3-b61e-c837d9e5e8b0</chapterId>

![відео](https://youtu.be/XANzf1Qqp9I)

![обкладинка](assets/chapitre10/0.webp)

Рахунок-фактура LN (або рахунок-фактура) є довгим і не дуже приємним для читання, але він дозволяє щільно представити запит на оплату.

Приклад:
lnbc1m1pskuawzpp5qeuuva2txazy5g483tuv9pznn9ft8l5e49s5dndj2pqq0ptyn8msdqqcqzpgxqrrsssp5v4s00u579atm0em6eqm9nr7d0vr64z5j2sm5s33x3r9m4lgfdueq9qyyssqxkjzzgx5ef7ez3dks0laxayx4grrw7j22ppgzyhpydtv6hmc39skf9hjxn5yd3kvv7zpjdxd2s7crcnemh2fz26mnr6zu83w0a2fwxcqnvujl3

- lnbc1m = читабельна частина
- 1 = розділ від решти
- Далі йде решта
- Bc1 = кодування Bech32 (база 32), тобто використовується 32 символи.
- 10 = 1.2.3.4.5.6.7.8.9.0
- 26 = abcdefghijklmnopqrstuvwxyz
- 32 = не "b-i-o" та не "1"

### lnbc1m

- ln = Lightning
- Bc = bitcoin (основна мережа)
- 1 = сума
- M = мілі (10^-3) / u = мікро (10^-6) / n = нано (10^-9) / p = піко (10^-12). Тут 1m = 1 * 0.001btc = 100,000 SAT
  "Будь ласка, сплатіть 100,000 SAT у мережі Lightning основної мережі Bitcoin за адресою pskuawzpp5qeuuva2txazy5g483tuv9pznn9ft8l5e49s5dndj2pqq0ptyn8msdqqcqzpgxqrrsssp5v4s00u579atm0em6eqm9nr7d0vr64z5j2sm5s33x3r9m4lgfdueq9qyyssqxkjzzgx5ef7ez3dks0laxayx4grrw7j22ppgzyhpydtv6hmc39skf9hjxn5yd3kvv7zpjdxd2s7crcnemh2fz26mnr6zu83w0a2fwxcqnvujl3"

### Час створення (коли було створено)

Воно містить 0 або більше додаткових частин:

- Хеш попереднього зображення
- Секрет платежу (маршрутизація через цибулю)
- Довільні дані
- Публічний ключ LN одержувача
- Час закінчення дії (за замовчуванням 1 година)
- Підказки для маршрутизації
- Підпис всього

Існують інші типи рахунків-фактур. Метапротокол LNURL дозволяє надавати пряму кількість сатоші замість створення запиту. Це дуже гнучко і дозволяє значно покращити користувацький досвід.

![обкладинка](assets/chapitre10/2.webp)

Keysend дозволяє Алісі відправити гроші Бобу без запиту від Боба. Аліса отримує ID Боба, створює попереднє зображення без запиту від Боба і включає його у свій платіж. Таким чином, Боб отримає несподіваний запит, де він може розблокувати гроші, оскільки Аліса вже виконала роботу.

![обкладинка](assets/chapitre10/3.webp)

Підсумовуючи, рахунок-фактура мережі Lightning, хоча на перший погляд і здається складним, ефективно кодує запит на платіж. Кожен розділ рахунку-фактури містить ключову інформацію, включаючи суму до сплати, одержувача, час створення та потенційно іншу інформацію, таку як хеш попереднього зображення, секрет платежу, підказки для маршрутизації та час закінчення дії. Протоколи, такі як LNURL та Keysend, пропонують значні покращення з точки зору гнучкості та користувацького досвіду, дозволяючи, наприклад, відправляти кошти без попереднього запиту з іншої сторони. Ці технології роблять процес платежу більш гладким та ефективним у мережі Lightning.

## Управління ліквідністю
<chapterId>cc76d0c4-d958-57f5-84bf-177e21393f48</chapterId>

![відео](https://youtu.be/MIbej28La7Y)

![інструкція](assets/chapitre11/0.webp)

Ми надаємо деякі загальні рекомендації для відповіді на вічне питання управління ліквідністю в Lightning.

У LN є 3 типи людей:

- Покупці: вони мають вихідну ліквідність, що є найпростішим, оскільки їм просто потрібно відкривати канали
- Торговці: це складніше, оскільки їм потрібна вхідна ліквідність від інших вузлів та акторів. Вони повинні мати людей, підключених до них
- Маршрутизаційні вузли: вони хочуть бути збалансованими з ліквідністю з обох сторін і мати хороше з'єднання з багатьма вузлами, щоб їх використовували якомога більше

Отже, якщо вам потрібна вхідна ліквідність, ви можете купити її у сервісів.
![інструкція](assets/chapitre11/1.webp)
Еліс купує канал у Сьюзі на 1 мільйон сатоші, тому вона відкриває канал зразу з 1,000,000 SAT на вхідній стороні. Після цього вона може приймати платежі до 1 мільйона SAT від клієнтів, які підключені через Сьюзі (яка має хороші зв'язки).

Іншим рішенням було б здійснення платежів; ви платите 100,000 за якусь причину, тепер ви можете отримати 100,000.

![інструкція](assets/chapitre11/2.webp)

### Рішення Loop Out: Атомарний своп LN - BTC

Еліс 2 мільйони - Сьюзі 0

![інструкція](assets/chapitre11/3.webp)

Еліс хоче відправити ліквідність Сьюзі, тому вона використовує Loop out (спеціальний вузол, який пропонує професійну послугу для перебалансування LN/BTC).
Еліс відправляє 1 мільйон до Loop через вузол Сьюзі, таким чином Сьюзі отримує ліквідність, а Loop відправляє баланс на ланцюгу назад до вузла Еліс.

![інструкція](assets/chapitre11/4.webp)

Отже, 1 мільйон йде до Сьюзі, Сьюзі відправляє 1 мільйон до Loop, Loop відправляє 1 мільйон до Еліс. Таким чином, Еліс перемістила ліквідність до Сьюзі, заплативши деякі комісії Loop за послугу.

Найскладніше в LN - зберегти ліквідність.

![інструкція](assets/chapitre11/5.webp)

На завершення, управління ліквідністю в мережі Lightning є ключовим питанням, яке залежить від типу користувача: покупець, торговець або маршрутизаційний вузол. Покупцям, яким потрібна вихідна ліквідність, завдання найпростіше: вони просто відкривають канали. Торговцям, яким потрібна вхідна ліквідність, необхідно бути підключеними до інших вузлів та учасників. Маршрутизаційні вузли, з іншого боку, прагнуть підтримувати баланс ліквідності з обох сторін. Існує кілька рішень для управління ліквідністю, такі як купівля каналів або оплата для збільшення приймальної спроможності. Опція "Loop Out", що дозволяє атомарний своп між LN і BTC, пропонує цікаве рішення для перебалансування ліквідності. Незважаючи на ці стратегії, підтримання ліквідності в мережі Lightning залишається складним викликом.

# Дізнатися більше
<partId>6bbf107d-a224-5916-9f0c-2b4d30dd0b17</partId>

## Підсумок курсу
<chapterId>a65a571c-561b-5e1c-87bf-494644653c22</chapterId>

![відео](https://youtu.be/coaskEGRjiU)

Наша мета полягала в тому, щоб пояснити, як працює мережа Lightning і як вона покладається на Bitcoin для своєї роботи.

Мережа Lightning - це мережа платіжних каналів. Ми розглянули, як працює платіжний канал між двома сторонами, але також розширили наш погляд на всю мережу, на поняття мережі платіжних каналів.

![інструкція](assets/chapitre12/0.webp)

Канали відкриваються через транзакцію Bitcoin і можуть вміщати стільки транзакцій, скільки потрібно. Стан каналу представлений транзакцією зобов'язання, яка відправляє кожній стороні те, що вони мають на своїй стороні каналу. Коли в каналі відбувається транзакція, сторони зобов'язуються до нового стану, відмовляючись від старого стану і створюючи нову транзакцію зобов'язання.

![інструкція](assets/chapitre12/1.webp)

Пари захищають себе від шахрайства за допомогою ключів відкликання та часового замку. Для закриття каналу віддається перевага закриттю за взаємною згодою. У випадку примусового закриття публікується остання транзакція зобов'язання.

![інструкція](assets/chapitre12/3.webp)
Платежі можуть позичати канали від інших проміжних вузлів. Умовні платежі на основі хеш-часового замка (HTLC) дозволяють заблокувати кошти до повного вирішення платежу. У мережі Lightning використовується маршрутизація через цибулю. Проміжні вузли не знають кінцевого пункту призначення платежів. Алісі потрібно розрахувати маршрут платежу, але вона не має всієї інформації про ліквідність у проміжних каналах.
![інструкція](assets/chapitre12/4.webp)

При відправленні платежу через мережу Lightning існує компонент ймовірності.

![інструкція](assets/chapitre12/5.webp)

Для отримання платежів потрібно управління ліквідністю в каналах, що можна зробити, попросивши інших відкрити канали до нас, відкривши канали самостійно та використовуючи інструменти, як-от Loop, або купуючи/орендуючи канали на маркетплейсах.

## Інтерв'ю з Фанісом
<chapterId>077cb5f5-1626-5da5-9964-e67b1de503bf</chapterId>

Ось короткий зміст інтерв'ю:

Мережа Lightning - це ультрашвидке рішення для платежів на Bitcoin, яке дозволяє обійти обмеження, пов'язані зі масштабованістю мережі. Однак, біткоїни в мережі Lightning не такі безпечні, як на блокчейні Bitcoin, оскільки пріоритет надається децентралізації та безпеці, а не масштабованості.

Надмірне збільшення розміру блоку не є хорошим рішенням, оскільки це ставить під загрозу вузли та ємність даних. Натомість мережа Lightning дозволяє створювати платіжні канали між двома користувачами Bitcoin без відображення транзакцій на блокчейні, економлячи місце в блоках та дозволяючи Bitcoin масштабуватися сьогодні.

Однак існують критики щодо масштабованості та централізації мережі Lightning, з потенційними проблемами, пов'язаними з закриттям каналів та високими комісіями за транзакції. Для вирішення цих проблем рекомендується уникати відкриття маленьких каналів, щоб уникнути майбутніх проблем, та збільшувати комісії за транзакції за допомогою Child Pay for Parent.

Розглядаються рішення для майбутнього мережі Lightning, такі як групування та створення каналів групами для зменшення комісій за транзакції, а також збільшення розміру блоку в довгостроковій перспективі. Однак важливо зазначити, що біткоїни в мережі Lightning не такі безпечні, як біткоїни на блокчейні Bitcoin.

Приватність на Bitcoin та Lightning пов'язані, з маршрутизацією через цибулю, що забезпечує певний рівень приватності для транзакцій. Однак на Bitcoin все прозоро за замовчуванням, з використанням евристик для відстеження біткоїнів від адреси до адреси на блокчейні Bitcoin.

Купівля біткоїнів з KYC дозволяє біржі знати транзакції зняття коштів, тоді як круглі суми та адреси здачі дозволяють знати, яка частина транзакції призначена для іншої особи, а яка - для себе.

Для покращення приватності спільні дії та coinjoins дозволяють порушувати розрахунки ймовірності, роблячи транзакції, де кілька людей роблять транзакцію разом. Компаніям з аналізу ланцюгів важче визначити, що ви робите з вашими біткоїнами, слідкуючи.

На Lightning лише дві людини знають про транзакцію, і вона конфіденційніша, ніж Bitcoin. Маршрутизація через цибулю означає, що проміжний вузол не знає відправника та отримувача платежу.

Для використання мережі Lightning рекомендується пройти навчання на вашому YouTube каналі або безпосередньо на вебсайті discover Bitcoin, або використовувати навчання на Umbrell. Також можливо відправляти довільний текст під час платежу в Lightning, використовуючи спеціальне поле для цього, що може бути корисним для донатів або повідомлень.
Однак важливо зазначити, що маршрутизуючі вузли Lightning можуть бути регульовані в майбутньому, деякі держави намагаються регулювати маршрутизуючі вузли. Для торговців необхідно управляти ліквідністю для прийняття платежів в мережі Lightning, з поточними обмеженнями, які можна подолати з відповідними рішеннями.

Нарешті, майбутнє Bitcoin обіцяє бути перспективним з можливою проекцією в один мільйон за п'ять років. Для забезпечення професіоналізації індустрії та створення альтернативної системи до існуючої банківської системи важливо вносити вклад у мережу та перестати довіряти.
## Дайте нам зворотній зв'язок про цей курс<chapterId>38814c99-eb7b-5772-af49-4386ee2ce9b0</chapterId>
<isCourseReview>true</isCourseReview>

## Подяки та продовжуйте заглиблюватися в кролячу нору
<chapterId>afc0d72b-4fbc-5893-90b2-e27fb519ad02</chapterId>

Вітаємо! 🎉
Ви завершили навчання LN 201 - Вступ до Мережі Lightning!
Ви можете пишатися собою, адже це не легко. Знайте, що небагато людей заглиблюються в Bitcoin так глибоко.

Перш за все, велике спасибі Фанісу Макалакісу за надання нам цього чудового безкоштовного курсу на більш етнічну тему Lightning. Не соромтеся слідкувати за ним у Twitter, на його блозі або через його роботу на ринку LN.

Потім, якщо ви хочете допомогти проекту, не соромтеся спонсорувати нас на Patreon. Ваші пожертви будуть використані для створення контенту для нових навчальних курсів і, звичайно, ви будете першими, хто дізнається про них (включаючи наступний курс Фаніса, над яким вже йде робота!).

Пригода Мережі Lightning продовжується з навчанням Umbrel та впровадженням вузла Мережі Lightning. Теорія закінчилася, і тепер час для практики з навчанням LN 202!

Цілую і до зустрічі незабаром!

Rogzy'