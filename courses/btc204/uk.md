---
name: Приватність у Bitcoin
goal: Зрозуміти та оволодіти принципами захисту приватності при використанні Bitcoin
objectives:
  - Визначити теоретичні поняття, необхідні для розуміння ставок захисту приватності
  - Знати, як ідентифікувати та зменшувати ризики, пов'язані з втратою приватності користувачів у Bitcoin
  - Використовувати методи та інструменти для захисту вашої приватності у Bitcoin
  - Розуміти методи аналізу ланцюгів та розробляти стратегії оборони
---
# Захистіть свою приватність у Bitcoin

У світі, де приватність фінансових транзакцій поступово стає розкішшю, розуміння та оволодіння принципами захисту приватності у вашому використанні Bitcoin є життєво важливим. Цей тренінг дає вам усі ключі, як теоретичні, так і практичні, для досягнення цього автономно.

Сьогодні, у Bitcoin, існують компанії, спеціалізовані на аналізі ланцюгів. Їх основна діяльність полягає саме у втручанні у ваш приватний простір, з метою компрометації конфіденційності ваших транзакцій. Насправді, "право на приватність" у Bitcoin не існує. Тому вам, користувачу, доводиться стверджувати свої природні права та захищати конфіденційність ваших транзакцій, адже ніхто інший цього за вас не зробить.

Цей тренінг представлений як повний та загальний курс. Кожне технічне поняття детально роз'яснене та підтримане пояснювальними діаграмами. Мета полягає в тому, щоб зробити знання доступними для всіх. BTC204 тому підходить для початківців та користувачів середнього рівня. Цей тренінг також пропонує додаткову цінність найбільш досвідченим біткойнерам, оскільки ми заглиблюємося в деякі технічні концепції, які часто залишаються невідомими.

Приєднуйтесь до нас, щоб трансформувати ваше використання Bitcoin та стати обізнаним користувачем, здатним розуміти питання, що оточують конфіденційність, та захищати вашу приватність.

+++

# Вступ
<partId>e17474a8-8899-4bdb-a7f8-bc52ddb01440</partId>

## Вступ до тренінгу
<chapterId>08ba1933-f393-4fb5-8279-777d874caedb</chapterId>

У світі, де приватність фінансових транзакцій поступово стає розкішшю, розуміння та оволодіння принципами захисту приватності у вашому використанні Bitcoin є життєво важливим. Цей тренінг дає вам усі ключі, як теоретичні, так і практичні, для досягнення цього автономно.
Сьогодні, у екосистемі Bitcoin, існують компанії, які спеціалізуються на аналізі ланцюгів. Їх основна діяльність полягає саме у втручанні у ваш приватний простір, компрометуючи конфіденційність ваших транзакцій. Насправді, "право на приватність" у Bitcoin не існує. Тому вам, користувачу, доводиться стверджувати свої природні права та захищати конфіденційність ваших транзакцій, адже ніхто інший цього за вас не зробить.

Bitcoin не лише існує для "Зростання Номерів" та збереження вартості заощаджень. Завдяки своїм унікальним характеристикам та історії, він перш за все є інструментом контр-економіки. Завдяки цьому видатному винаходу, ви можете вільно керувати своїми грошима, витрачати їх та накопичувати, без можливості когось вам завадити.

Bitcoin пропонує мирний вихід з-під ярма держав, дозволяючи вам повною мірою насолоджуватися своїми природними правами, які не можуть бути оскаржені встановленими законами. Завдяки винаходу Сатоші Накамото, у вас є сила змусити поважати вашу приватну власність та повернути свободу укладання контрактів.

Однак, Bitcoin за замовчуванням не є анонімним, що може становити ризик для осіб, які займаються контр-економікою, особливо в регіонах під деспотичними режимами. Але це не єдиний небезпека. Враховуючи, що bitcoin є цінним та нецензурованим активом, він може привернути увагу злодіїв. Таким чином, захист вашої приватності також стає питанням безпеки: це може допомогти вам запобігти кібератакам та фізичним нападам.
Як ми побачимо, хоча протокол пропонує певні внутрішні захисти конфіденційності, важливо використовувати додаткові інструменти для оптимізації та захисту цієї конфіденційності.
Цей тренінг розроблений як комплексний та загальний курс для розуміння ставок конфіденційності в Bitcoin. Кожне технічне поняття детально обговорюється та підкріплюється пояснювальними діаграмами. Мета полягає в тому, щоб зробити знання доступними для всіх, навіть для початківців та користувачів середнього рівня. Для більш досвідчених біткойнерів ми також розглядаємо дуже технічні та іноді менш відомі концепції протягом цього тренінгу, щоб поглибити розуміння кожної теми.

Мета цього тренінгу не полягає в тому, щоб зробити вас повністю анонімними у використанні Bitcoin, але надати вам необхідні інструменти для знання того, як захистити вашу конфіденційність відповідно до ваших особистих цілей. Ви матимете свободу вибору з концепцій та інструментів, представлених для розробки власних стратегій, адаптованих до ваших конкретних цілей та потреб.

### Розділ 1: Визначення та ключові концепції
Для початку ми разом розглянемо фундаментальні принципи, які керують роботою Bitcoin, щоб потім спокійно підійти до понять, пов'язаних з конфіденційністю. Важливо оволодіти кількома базовими концепціями, такими як UTXOs, адреси отримання або скрипти, перш ніж зможете повністю зрозуміти концепції, які ми розглянемо в наступних розділах. Ми також представимо загальну модель конфіденційності Bitcoin, як це бачив Сатоші Накамото, що дозволить нам зрозуміти ставки та ризики, пов'язані з цим.
![BTC204](assets/en/11/1.webp)

### Розділ 2: Розуміння аналізу ланцюгів та як захиститися від нього

У другому розділі ми вивчаємо техніки, які використовують компанії з аналізу ланцюгів, щоб відстежувати вашу активність в Bitcoin. Розуміння цих методів є критично важливим для посилення захисту вашої конфіденційності. Ця частина має на меті розглянути стратегії атакуючих, щоб краще зрозуміти ризики та покласти основу для технік, які ми вивчатимемо в наступних розділах. Ми проаналізуємо шаблони транзакцій, внутрішні та зовнішні евристики, а також можливі тлумачення цих шаблонів. Крім теоретичної складової, ми навчимося використовувати блок-експлорер для виконання аналізу ланцюгів, через практичні приклади та вправи.

![BTC204](assets/notext/11/2.webp)

### Розділ 3: Оволодіння найкращими практиками для захисту вашої конфіденційності

У третьому розділі нашого тренінгу ми переходимо до суті справи: практики! Мета полягає в тому, щоб оволодіти всіма необхідними найкращими практиками, які повинні стати природними рефлексами для будь-якого користувача Bitcoin. Ми розглянемо використання свіжих адрес, маркування, консолідацію, використання повних вузлів, а також методи KYC та придбання. Мета полягає в тому, щоб надати вам повний огляд пасток, яких слід уникати, щоб закласти міцні основи в нашому прагненні захисту конфіденційності. Для деяких з цих практик ви будете направлені до конкретного навчального посібника для їх впровадження.

![BTC204](assets/en/11/3.webp)

### Розділ 4: Розуміння транзакцій Coinjoin

Як можна говорити про конфіденційність в Bitcoin, не обговорюючи coinjoins? У розділі 4 ви дізнаєтеся все, що потрібно знати про цей метод міксування. Ви дізнаєтеся, що таке coinjoin, його історію та цілі, а також різні типи coinjoins, які існують. Нарешті, для більш досвідчених користувачів, ми дізнаємося, що таке anonsets та ентропія, і як розрахувати ці показники.

![BTC204](assets/en/11/4.webp)

### Розділ 5: Розуміння ставок інших передових технік конфіденційності
У п'ятому розділі ми надамо огляд усіх інших існуючих методів захисту вашої конфіденційності в Bitcoin, окрім coinjoin. Протягом років розробники продемонстрували надзвичайну креативність у створенні інструментів, присвячених конфіденційності. Ми розглянемо всі ці методи, такі як payjoin, спільні транзакції, Coin Swap та Atomic Swap, детально описуючи їхню роботу, цілі та потенційні слабкі місця.
Ми також займемося конфіденційністю на рівні мережі вузлів та поширенням транзакцій. Обговоримо різні протоколи, які були запропоновані протягом років для підвищення конфіденційності користувачів в Bitcoin, включаючи протоколи зі статичною адресою.

![BTC204](assets/notext/11/5.webp)

# Визначення та ключові поняття
<partId>b9bbbde3-34c0-4851-83e8-e2ffb029cf31</partId>


## Модель UTXO в Bitcoin
<chapterId>8d6b50c5-bf74-44f4-922b-25204991cb75</chapterId>

Bitcoin, перш за все, є валютою, але чи знаєте ви конкретно, як BTC представлені в протоколі?

### Що таке Bitcoin UTXO?

У протоколі Bitcoin управління грошовими одиницями здійснюється за допомогою моделі UTXO, абревіатура для "_Unspent Transaction Output_" (невитрачений вихід транзакції).

Ця модель кардинально відрізняється від традиційних банківських систем, які покладаються на механізм рахунків та балансів для відстеження фінансових потоків. Насправді, у банківській системі індивідуальні баланси підтримуються на рахунках, прив'язаних до особи. Наприклад, коли ви купуєте багет у пекаря, ваш банк просто списує суму покупки з вашого рахунку, тим самим зменшуючи ваш баланс, тоді як рахунок пекаря кредитується на ту ж суму, збільшуючи його баланс. У цій системі немає поняття зв'язку між грошима, що надходять на ваш рахунок, і грошима, що залишають його, окрім записів про транзакції.

![BTC204](assets/en/21/1.webp)
У Bitcoin все працює інакше. Поняття рахунку не існує, а грошові одиниці управляються через UTXO. UTXO представляє певну кількість біткойнів, які ще не були витрачені, таким чином формуючи "шматок біткойна", який може бути великим або малим. Наприклад, UTXO може бути вартістю `500 BTC` або просто `700 SATS`.
**> Нагадування:** Сатоші, часто скорочено як sat, є найменшою одиницею Bitcoin, порівнянною з центом у фіатних валютах.

```plaintext
1 BTC = 100,000,000 SATS
```

Теоретично, UTXO може представляти будь-яку вартість у біткойнах, від одного сатоші до теоретичного максимуму приблизно 21 мільйон BTC. Однак, логічно неможливо володіти всіма 21 мільйоном біткойнів, і існує нижній економічний поріг, званий "пилом", нижче якого UTXO вважається економічно невигідним для витрати.

**> Чи знали ви?** Найбільший UTXO, коли-небудь створений на Bitcoin, був оцінений у `500,000 BTC`. Він був створений платформою MtGox під час операції консолідації у листопаді 2011 року: [29a3efd3ef04f9153d47a990bd7b048a4b2d213daaa5fb8ed670fb85f13bdbcf](https://mempool.space/fr/tx/29a3efd3ef04f9153d47a990bd7b048a4b2d213daaa5fb8ed670fb85f13bdbcf)

### UTXO та Умови Витрати
UTXO є інструментами обміну в Bitcoin. Кожна транзакція призводить до використання UTXO як вхідних даних та створення нових UTXO як вихідних даних. Коли здійснюється транзакція, використані UTXO вважаються "витраченими", а нові UTXO генеруються та розподіляються між одержувачами, вказаними у вихідних даних транзакції. Таким чином, UTXO просто представляє невитрачений вихід транзакції, а отже, певну кількість біткойнів, що належать користувачу на даний момент.
![BTC204](assets/en/21/2.webp)
Всі UTXO захищені скриптами, які визначають умови, за яких вони можуть бути витрачені. Щоб використати UTXO, користувач має довести мережі, що він відповідає умовам, встановленим скриптом, який захищає цей UTXO. Загалом, UTXO захищені публічним ключем (або адресою отримувача, яка представляє цей публічний ключ). Щоб витратити UTXO, асоційований з цим публічним ключем, користувач має довести, що він володіє відповідним приватним ключем, надаючи цифровий підпис, створений за допомогою цього ключа. Саме тому кажуть, що ваш гаманець Bitcoin насправді не містить біткойнів, а зберігає ваші приватні ключі, які, в свою чергу, дають вам доступ до ваших UTXO і, відповідно, до біткойнів, які вони представляють.
![BTC204](assets/en/21/3.webp)

Оскільки в Bitcoin відсутнє поняття рахунку, баланс гаманця просто відповідає сумі значень усіх UTXO, які він може витратити. Наприклад, якщо ваш Bitcoin гаманець може витратити наступні 4 UTXO:

```plaintext
- 2 BTC
- 8 BTC
- 5 BTC
- 2 BTC
```

Загальний баланс вашого гаманця буде `17 BTC`.

![BTC204](assets/en/21/4.webp)

## Структура Bitcoin транзакцій
<chapterId>29d3aaab-de2e-4746-ab40-c9748898850c</chapterId>

### Входи та виходи транзакції

Bitcoin транзакція - це операція, записана в блокчейні, яка дозволяє передати право власності на біткойни від однієї особи до іншої. Більш конкретно, оскільки ми працюємо на моделі UTXO і відсутні рахунки, транзакція задовольняє умови витрат, які захищали один або кілька UTXO, споживає їх і еквівалентно створює нові UTXO з новими умовами витрат. Коротше кажучи, транзакція переміщує біткойни зі скрипта, який задовольняється, до нового скрипта, призначеного для їх захисту.

![BTC204](assets/en/22/1.webp)

Таким чином, кожна Bitcoin транзакція складається з одного або кількох входів та одного або кількох виходів. Входи - це UTXO, які витрачаються транзакцією для генерації виходів. Виходи - це нові UTXO, які будуть використовуватися як входи для майбутніх транзакцій.

![BTC204](assets/en/22/2.webp)

**> Цікаво знати?** Теоретично, Bitcoin транзакція може мати нескінченну кількість входів та виходів. Лише максимальний розмір блоку обмежує цю кількість.
Кожен вхід у Bitcoin транзакції посилається на попередній, невитрачений UTXO (Unspent Transaction Output). Щоб використати UTXO як вхід, його власник має довести, що він є законним власником, валідуючи скрипт, асоційований з ним, тобто, відповідаючи встановленій умові витрати. Загалом, це включає надання цифрового підпису, створеного за допомогою приватного ключа, що відповідає публічному ключу, який спочатку захищав цей UTXO. Таким чином, скрипт перевіряє, що підпис відповідає публічному ключу, використаному при отриманні коштів.
![BTC204](assets/en/22/3.webp)
Кожен вихід, з іншого боку, вказує кількість біткоїнів, які мають бути переведені, а також одержувача. Останній визначається новим скриптом, який, зазвичай, блокує новостворений UTXO за допомогою адреси отримувача або нового публічного ключа.
Для того, щоб транзакція вважалася дійсною згідно з правилами консенсусу, загальна сума виходів має бути меншою або рівною загальній сумі входів. Іншими словами, сума нових UTXO, створених транзакцією, не має перевищувати ту, що була використана як входи. Цей принцип є логічним: якщо у вас є лише сума `500,000 SATS`, ви не можете здійснити покупку на `700,000 SATS`.

### Здача та Консолідація в Біткоїн Транзакції

Дія біткоїн транзакції на UTXO може бути порівняна з переплавкою золотої монети. Дійсно, UTXO не є ділимим, а лише об'єднуваним. Це означає, що користувач не може просто поділити UTXO, який представляє певну кількість біткоїнів, на кілька менших UTXO. Вони повинні повністю використати його в транзакції, щоб створити один або кілька нових UTXO довільних значень у виходах, які мають бути меншими або рівними початковій вартості.

Цей механізм схожий на той, що використовується з золотою монетою. Уявіть, що у вас є монета вагою 2 унції, і ви хочете зробити платіж на 1 унцію, припускаючи, що продавець не може дати вам решту. Вам потрібно буде переплавити вашу монету і відлити 2 нові по 1 унції кожна.
На Біткоїні операція схожа. Уявімо, що у Аліси є UTXO на `10,000 SATS` і вона хоче купити багет, який коштує `4,000 SATS`. Аліса здійснить транзакцію з входом 1 UTXO на `10,000 SATS`, який вона повністю використає, і на виході вона створить 2 UTXO на `4,000 SATS` і `6,000 SATS`. UTXO на `4,000 SATS` буде відправлено пекарю як оплата за багет, тоді як UTXO на `6,000 SATS` повернеться до Аліси як здача. Цей UTXO, який повертається до початкового відправника транзакції, називається "здачею" в жаргоні Біткоїна.
![BTC204](assets/en/22/4.webp)

Тепер уявіть, що у Аліси не один UTXO на `10,000 SATS`, а два UTXO по `3,000 SATS` кожен. У цій ситуації жоден з окремих UTXO не достатній для покриття `4,000 SATS` за багет. Тому Алісі потрібно використати обидва UTXO на `3,000 SATS` як входи для своєї транзакції одночасно. Таким чином, загальна сума входів досягне `6,000 SATS`, дозволяючи їй покрити платіж `4,000 SATS` пекарю. Цей метод, який передбачає групування кількох UTXO у входах транзакції, часто називають терміном "консолідація".
![BTC204](assets/en/22/5.webp)

### Комісії за Транзакції
Інтуїтивно можна подумати, що комісійні збори також є виходом транзакції. Але насправді це не так. Комісійні збори транзакції представляють різницю між загальною сумою входів та загальною сумою виходів. Це означає, що після використання частини вартості входів для покриття бажаних виходів у транзакції, певна сума входів залишається невикористаною. Ця залишкова сума становить комісійні збори транзакції.
```plaintext
Комісійні = загальні входи - загальні виходи
```

Повернімося до прикладу з Алісою, яка має UTXO на `10,000 SATS` і хоче купити багет за `4,000 SATS`. Аліса створює транзакцію зі своїм UTXO на `10,000 SATS` як вхід. Потім вона генерує вихід на `4,000 SATS`, призначений для пекаря за оплату багета. Щоб заохотити майнерів включити її транзакцію в блок, Аліса виділяє `200 SATS` як комісійні. Таким чином, вона створює другий вихід, решту, яка повернеться їй, на суму `5,800 SATS`.

![BTC204](assets/en/22/6.webp)

Застосовуючи формулу комісійних, ми дійсно бачимо, що залишається `200 SATS` для майнерів:
```plaintext
Комісійні = загальні входи - загальні виходи
Витрати = 10,000 - (4,000 + 5,800)
Витрати = 10,000 - 9,800
Витрати = 200
```

Коли майнер успішно валідує блок, він має право зібрати ці комісійні за всі транзакції, включені в його блок, через так звану "coinbase" транзакцію.

### Створення UTXO на Bitcoin

Якщо ви уважно слідкували за попередніми абзацами, то тепер ви знаєте, що UTXO можуть бути створені лише шляхом використання інших існуючих UTXO. Таким чином, монети на Bitcoin формують безперервний ланцюг. Однак, ви можете замислитися, як з'явилися перші UTXO в цьому ланцюзі. Це породжує проблему, схожу на проблему курки та яйця: звідки взялися ці оригінальні UTXO?

Відповідь лежить у **coinbase транзакції**.

Coinbase - це специфічний тип транзакції Bitcoin, унікальний для кожного блоку та завжди перший у них. Він дозволяє майнеру, який знайшов дійсний доказ роботи, отримати свою винагороду за блок. Ця винагорода складається з двох елементів: **субсидії блоку** та **комісійних зборів**, про які ми говорили в попередній частині.

Унікальною особливістю coinbase транзакції є те, що вона єдина може створювати біткоїни з повітря, без необхідності використовувати входи для генерації своїх виходів. Ці новостворені біткоїни становлять те, що можна було б назвати "оригінальними UTXO".

![BTC204](assets/en/22/7.webp)

Біткоїни з субсидії блоку є новими BTC, створеними з нічого, згідно з попередньо встановленим графіком випуску в правилах консенсусу. Субсидія блоку зменшується вдвічі кожні 210,000 блоків, що становить приблизно кожні чотири роки, в процесі, який називається "halving". Спочатку з кожною субсидією створювалося 50 біткоїнів, але ця кількість поступово зменшувалася; наразі це 3.125 біткоїнів за блок.
Що стосується частини, пов'язаної з комісіями за транзакції, хоча вона також представляє новостворені BTC, вони не повинні перевищувати різницю між загальними входами та виходами всіх транзакцій у блоку. Ми раніше бачили, що ці комісії представляють частину входів, яка не використовується у виходах транзакцій. Технічно ця частина "втрачається" під час транзакції, і майнер має право відтворити цю вартість у формі одного або декількох нових UTXO. Таким чином, це передача вартості від відправника транзакції до майнера, який додає її до блокчейну.
**> Чи знали ви?** Біткоїни, згенеровані транзакцією coinbase, підлягають періоду зрілості у 100 блоків, протягом яких майнер не може ними скористатися. Це правило призначене для уникнення ускладнень, пов'язаних з використанням новостворених біткоїнів на ланцюжку, який пізніше може стати застарілим.

### Наслідки моделі UTXO

По-перше, модель UTXO безпосередньо впливає на комісії за транзакції в Bitcoin. Оскільки ємність кожного блоку обмежена, майнери віддають перевагу транзакціям, які пропонують найкращі комісії відносно простору, який вони займуть у блоку. Дійсно, чим більше UTXO включено в транзакцію як входи та виходи, тим вона важча, і, отже, вимагає вищих комісій. Це одна з причин, чому часто докладають зусиль для зменшення кількості UTXO у нашому гаманці, що також може вплинути на приватність, тему, яку ми детально розглянемо у третій частині цього навчання.

Далі, як згадувалося у попередніх частинах, монети в Bitcoin по суті є ланцюгом UTXO. Кожна транзакція таким чином створює зв'язок між минулим UTXO та майбутнім UTXO. Таким чином, UTXO дозволяють явно відстежувати шлях біткоїнів від їх створення до їх поточного витрачання. Ця прозорість може розглядатися позитивно, оскільки вона дозволяє кожному користувачеві переконатися в автентичності отриманих біткоїнів. Однак, саме на цьому принципі простежуваності та аудиту базується аналіз ланцюжків, практика, спрямована на порушення вашої приватності. Ми детально вивчимо цю практику у другій частині навчання.

## Модель приватності Bitcoin
<chapterId>769d8963-3ed5-4094-b21d-9203c7d9e465</chapterId>

### Валюта: Автентичність, Цілісність та Подвійне Витрачання

Одна з функцій валюти полягає у вирішенні проблеми подвійного збігу бажань. У системі, заснованій на бартері, здійснення обміну вимагає не лише знайти особу, яка пропонує товар, що задовольняє мою потребу, але й надати їм товар еквівалентної вартості, який задовольняє їхню власну потребу. Знайти цю рівновагу виявляється складним.

![BTC204](assets/notext/23/1.webp)

Саме тому ми вдаємося до валюти, яка дозволяє передавати вартість як у просторі, так і в часі.

![BTC204](assets/notext/23/2.webp)

Для того, щоб валюта вирішувала цю проблему, важливо, щоб сторона, яка надає товар або послугу, була переконана у своїй здатності витратити цю суму пізніше. Таким чином, будь-яка раціональна особа, яка бажає прийняти валюту, незалежно від того, цифрова вона чи фізична, переконається, що вона відповідає двом основним критеріям:
- **Монета повинна бути цілісною та автентичною;**
- **і вона не повинна бути подвійно витрачена.**
При використанні фізичної валюти перша характеристика є найскладнішою для підтвердження. Протягом різних періодів в історії цілісність металевих монет часто піддавалася підриву через такі практики, як обрізання або свердління. Наприклад, у стародавньому Римі було поширено, що громадяни скоблили краї золотих монет, щоб зібрати трохи дорогоцінного металу, при цьому зберігаючи їх для майбутніх транзакцій. Таким чином, внутрішня вартість монети знижувалася, але її номінальна вартість залишалася тією ж. Саме тому згодом на краю монет почали карбувати ребра.

Автентичність також є складною характеристикою для перевірки з фізичними грошовими засобами. На сьогоднішній день техніки боротьби з підробкою стають все складнішими, змушуючи торговців інвестувати в дорогі системи верифікації.

З іншого боку, через їхню природу, подвійне витрачання не є проблемою для фізичних валют. Якщо я даю вам купюру в 10 євро, вона безповоротно залишає моє володіння, щоб увійти в ваше, природно виключаючи будь-яку можливість кілька разів витратити ті ж грошові одиниці. Коротше кажучи, я не зможу знову витратити цю купюру в 10 євро.

![BTC204](assets/notext/23/3.webp)

Для цифрової валюти складність інша. Забезпечення автентичності та цілісності монети часто простіше. Як ми бачили в попередньому розділі, модель UTXO Bitcoin дозволяє відстежити монету до її походження, тим самим перевіряючи, що вона дійсно була створена відповідно до правил консенсусу майнером.

Однак, забезпечення відсутності подвійного витрачання є складнішим, оскільки будь-який цифровий товар по суті є інформацією. На відміну від фізичних товарів, інформація не ділиться під час обмінів, але поширюється, множачись. Наприклад, якщо я надсилаю вам документ електронною поштою, він потім дублюється. З вашого боку ви не можете з упевненістю перевірити, що я видалив оригінальний документ.

![BTC204](assets/notext/23/4.webp)

### Попередження подвійного витрачання на Bitcoin

Єдиний спосіб уникнути дублювання цифрового товару - бути в курсі всіх обмінів у системі. Таким чином, можна знати, хто що володіє, і оновлювати володіння кожного на основі здійснених транзакцій. Саме так робиться, наприклад, з безготівковими грошима в банківській системі. Коли ви платите 10 євро торговцю кредитною карткою, банк фіксує цей обмін і оновлює реєстр.
На Bitcoin запобігання подвійному витрачанню досягається таким же чином. Мета полягає в підтвердженні відсутності транзакції, яка вже витратила вказані монети. Якщо ці монети ніколи не використовувалися, тоді ми можемо бути впевнені, що подвійного витрачання не відбудеться. Цей принцип був описаний Сатоші Накамото у Білому папері з цією відомою фразою:

**"*Єдиний спосіб підтвердити відсутність транзакції - бути в курсі всіх транзакцій.*"**

Однак, на відміну від банківської моделі, на Bitcoin немає бажання довіряти центральній сутності. Необхідно, щоб всі користувачі могли підтвердити цю відсутність подвійного витрачання, не покладаючись на третю сторону. Таким чином, всі повинні бути в курсі всіх транзакцій Bitcoin. Саме тому транзакції Bitcoin публічно транслюються через всі вузли мережі та записуються відкрито в блокчейні.

Саме ця публічна розповсюдження інформації ускладнює захист приватності на Bitcoin. У традиційній банківській системі, теоретично, лише фінансова установа знає про здійснені транзакції. З іншого боку, на Bitcoin, всі користувачі інформовані про всі транзакції через їхні відповідні вузли.

### Модель приватності: банківська система проти Bitcoin
У традиційній системі ваш банківський рахунок пов'язаний з вашою особистістю. Банкір може знати, який банківський рахунок належить якому клієнту, та які транзакції з ним асоційовані. Однак, цей потік інформації переривається між банком та публічним доменом. Іншими словами, неможливо знати баланс та транзакції банківського рахунку, який належить іншій особі. Тільки банк має доступ до цієї інформації.
Наприклад, ваш банкір знає, що ви купуєте вашу багету кожного ранку в сусідній пекарні, але ваш сусід не знає про цю транзакцію. Таким чином, потік інформації доступний зацікавленим сторонам, зокрема банку, але залишається недоступним для сторонніх.

Через обмеження публічного поширення транзакцій, яке ми бачили в попередній частині, модель конфіденційності Bitcoin не може слідувати моделі банківської системи. У випадку з Bitcoin, оскільки потік інформації не може бути перерваний між транзакціями та публічним доменом, **модель конфіденційності ґрунтується на розділенні між особистістю користувача та самими транзакціями**.
Наприклад, якщо ви купуєте багет у пекаря, платячи в BTC, ваш сусід, який має власний повний вузол, може бачити вашу транзакцію, так само як він може бачити всі інші транзакції в системі. Однак, якщо принципи конфіденційності дотримуються, він не повинен мати можливості пов'язати цю конкретну транзакцію з вашою особистістю.
![BTC204](assets/en/23/9.webp)

Але оскільки транзакції Bitcoin стають публічними, все ж таки стає можливим встановити зв'язки між ними, щоб вивести інформацію про залучені сторони. Ця діяльність навіть становить спеціалізацію сама по собі, яка називається "аналіз ланцюга". У наступній частині навчання я запрошую вас дослідити основи аналізу ланцюга, щоб зрозуміти, як відстежуються ваші біткоїни, та дізнатися, як краще захистити себе від цього.

# Розуміння аналізу ланцюга та як захистити себе
<partId>4739371e-9fef-45b0-bcaa-b7a4df6b4470</partId>

## Що таке аналіз ланцюга на Bitcoin?
<chapterId>7d198ba6-4af2-4f24-86cb-3c79cb25627e</chapterId>

### Визначення та Операція

Аналіз ланцюга - це практика, яка охоплює всі методи, використовувані для відстеження потоку біткоїнів на блокчейні. Загалом, аналіз ланцюга ґрунтується на спостереженні характеристик у зразках попередніх транзакцій. Потім він включає ідентифікацію цих самих характеристик у транзакції, яку хочуть проаналізувати, та виведення правдоподібних інтерпретацій. Цей метод вирішення проблем з практичного підходу, щоб знайти достатньо хороше рішення, називається "евристика".

Для спрощення, аналіз ланцюга виконується в трьох основних кроках:
1. **Спостереження за блокчейном;**
2. **Ідентифікація відомих характеристик;**
3. **Виведення гіпотез.**

![BTC204](assets/en/31/1.webp)

Аналіз ланцюга може виконувати будь-хто. Достатньо мати доступ до публічної інформації блокчейну через повний вузол, щоб спостерігати за рухами транзакцій та робити гіпотези. Існують також безкоштовні інструменти, які полегшують цей аналіз, як сайт [OXT.me](https://oxt.me/), який ми детально розглянемо в останніх двох розділах цієї частини. Однак, основний ризик для конфіденційності походить від компаній, спеціалізованих на аналізі ланцюга. Ці компанії довели аналіз ланцюга до промислового масштабу та продають свої послуги фінансовим установам або урядам. Серед цих компаній, Chainalysis, ймовірно, найвідоміша.

### Цілі аналізу ланцюга
Однією з цілей аналізу ланцюга є групування різних активностей в Bitcoin з метою визначення унікальності користувача, який їх здійснив. Після цього можна буде спробувати пов'язати цей пучок активностей з реальною ідентичністю. ![BTC204](assets/notext/31/2.webp)

Пам'ятайте попередній розділ. Я пояснив, чому модель приватності Bitcoin спочатку покладалася на відокремлення ідентичності користувача від їх транзакцій. Тому може здатися, що аналіз ланцюга непотрібен, оскільки навіть якщо вдасться згрупувати активності в ланцюгу, їх не можна асоціювати з реальною ідентичністю.

Теоретично це твердження точне. У першій частині цього навчання ми бачили, що криптографічні пари ключів використовуються для встановлення умов на UTXO. По суті, ці пари ключів не розкривають жодної інформації про ідентичність їх власників. Таким чином, навіть якщо вдасться згрупувати активності, асоційовані з різними парами ключів, це не говорить нам нічого про сутність за цими активностями.

![BTC204](assets/notext/31/3.webp)

Однак практична реальність набагато складніша. Існує безліч поведінок, які ризикують пов'язати реальну ідентичність з активністю в ланцюгу. В аналізі це називається точкою входу, і їх багато.

Найпоширенішою, звичайно, є KYC (*Know Your Customer* - Знай свого клієнта). Якщо ви виводите свої біткоїни з регульованої платформи на одну з ваших особистих адрес прийому, то деякі люди можуть пов'язати вашу ідентичність з цією адресою. У ширшому сенсі, точкою входу може бути будь-яка форма взаємодії між вашим реальним життям і транзакцією в Bitcoin. Наприклад, якщо ви публікуєте адресу прийому у своїх соціальних мережах, це може бути точкою входу для аналізу. Якщо ви робите платіж в біткоїнах своєму пекарю, він може асоціювати ваше обличчя (яке є частиною вашої ідентичності) з адресою Bitcoin.

Ці точки входу майже неминучі при використанні Bitcoin. Хоча можна намагатися обмежити їх обсяг, вони залишаться присутніми. Тому критично важливо поєднувати методи, спрямовані на збереження вашої приватності. Хоча підтримання розділення між вашою реальною ідентичністю та вашими транзакціями є цікавим підходом, сьогодні воно залишається недостатнім. Дійсно, якщо всі ваші активності в ланцюгу можна згрупувати, то найменша точка входу, ймовірно, поставить під загрозу єдиний шар приватності, який ви встановили.

![BTC204](assets/notext/31/4.webp)

### Захист від аналізу ланцюга
Таким чином, також необхідно вміти протистояти аналізу блокчейна у нашому використанні Bitcoin. Діючи таким чином, ми можемо мінімізувати агрегацію наших активностей і обмежити вплив точки входу на нашу приватність.
![BTC204](assets/notext/31/5.webp)

Дійсно, для кращого протистояння аналізу блокчейна, що може бути кращим підходом, ніж ознайомлення з методами, які використовуються в аналізі блокчейна? Якщо ви хочете знати, як покращити свою приватність в Bitcoin, вам потрібно зрозуміти ці методи. Це дозволить вам краще зрозуміти техніки, такі як [coinjoin](https://planb.network/fr/tutorials/privacy/coinjoin-samourai-wallet) або [payjoin](https://planb.network/fr/tutorials/privacy/payjoin) (техніки, які ми вивчимо в останніх частинах навчання), і зменшити помилки, які ви могли б зробити.
У цьому ми можемо провести аналогію з криптографією та криптоаналізом. Добрий криптограф насамперед є хорошим криптоаналітиком. Щоб уявити новий алгоритм шифрування, потрібно знати, з якими атаками він зіткнеться, а також вивчити, чому попередні алгоритми були зламані. Той самий принцип застосовується до приватності в Bitcoin. Розуміння методів аналізу блокчейну є ключем до захисту від нього. Саме тому я пропоную цілий розділ про аналіз блокчейну в цьому навчанні.
### Методи аналізу блокчейну

Важливо розуміти, що аналіз блокчейну не є точною наукою. Він покладається на евристики, виведені з попередніх спостережень або логічних інтерпретацій. Ці правила дозволяють отримувати досить надійні результати, але ніколи з абсолютною точністю. Іншими словами, **аналіз блокчейну завжди включає елемент ймовірності у висновках**. Наприклад, можна з більшою чи меншою впевненістю оцінити, що дві адреси належать одній сутності, але повна впевненість завжди буде недосяжною.

Ціла мета аналізу блокчейну полягає саме в агрегації різних евристик з метою мінімізації ризику помилки. Це, по суті, накопичення доказів, яке дозволяє нам наблизитися до реальності.

Ці відомі евристики можна згрупувати на різні категорії, які ми детально розглянемо разом:
- **Моделі транзакцій (або шаблони транзакцій);**
- **Евристики, внутрішні для транзакції;**
- **Евристики, зовнішні для транзакції.**

### Сатоші Накамото та аналіз блокчейну
Варто зазначити, що перші дві евристики для аналізу ланцюга були відкриті самим Сатоші Накамото. Він обговорює їх у частині 10 Білого паперу Bitcoin. Це:
- евристика спільного володіння входами (CIOH);
- та повторне використання адреси.

![BTC204](assets/notext/31/6.webp)

Джерело: С. Накамото, "Bitcoin: Електронна пірингова система готівкових розрахунків", https://bitcoin.org/bitcoin.pdf, 2009.

У наступних розділах ми дослідимо, що вони собою представляють, але вже зараз цікаво відзначити, що ці дві евристики досі зберігають пріоритетність у аналізі ланцюга сьогодні.

## Моделі транзакцій
<chapterId>d365a101-2d37-46a5-bfb9-3c51e37bf96b</chapterId>

Модель транзакції - це просто модель або загальна структура типової транзакції, яку можна знайти в блокчейні, чия інтерпретація, ймовірно, відома. Вивчаючи шаблони, ми зосередимося на одній транзакції, яку ми проаналізуємо на високому рівні.

Іншими словами, ми будемо дивитися лише на кількість UTXO в інпутах та кількість UTXO в аутпутах, не зупиняючись на більш специфічних деталях або середовищі транзакції. З спостережуваної моделі ми зможемо інтерпретувати природу транзакції. Потім ми шукатимемо характеристики в її структурі та робитимемо висновок.

![BTC204](assets/en/32/01.webp)

У цій частині ми разом відкриємо основні моделі транзакцій, які можна зустріти в аналізі ланцюга, і для кожної моделі я дам вам ймовірну інтерпретацію цієї структури разом з конкретним прикладом.

### Проста відправка (або Простий платіж)

Ми починаємо з дуже поширеного шаблону, оскільки він з'являється в більшості платежів біткоїнів. Модель простого платежу характеризується споживанням одного або декількох UTXO на входах та виробництвом 2 UTXO на виходах. Таким чином, ця модель виглядатиме так:

![BTC204](assets/en/32/02.webp)
Коли ми помічаємо цю структуру транзакції на блокчейні, ми вже можемо зробити висновок. Як випливає з назви, ця модель вказує на те, що ми маємо справу з транзакцією відправлення або платежу. Користувач використав свої власні UTXO у входах, щоб задовольнити у виходах платіжний UTXO та UTXO решти (гроші повертаються тому ж користувачу).
Отже, ми знаємо, що спостережуваний користувач, ймовірно, більше не володіє одним з двох UTXO на виходах (платіжним), але все ще володіє іншим UTXO (рештою).
Наразі нам неможливо вказати, який вихід представляє який UTXO, оскільки це не є метою вивчення моделей. Ми досягнемо цього, спираючись на евристику, яку ми вивчатимемо в наступних частинах. На цьому етапі наша мета обмежена ідентифікацією природи зазначеної транзакції, яка в цьому випадку є простим відправленням.

Наприклад, ось транзакція Bitcoin, яка використовує модель простого відправлення:

```plaintext
b6cc79f45fd2d7669ff94db5cb14c45f1f879ea0ba4c6e3d16ad53a18c34b769
```

![BTC204](assets/en/32/03.webp)

Джерело: [Mempool.space](https://mempool.space/fr/tx/b6cc79f45fd2d7669ff94db5cb14c45f1f879ea0ba4c6e3d16ad53a18c34b769)

Після цього першого прикладу ви повинні краще зрозуміти, що означає вивчення "моделі транзакції". Ми аналізуємо транзакцію, зосереджуючись лише на її структурі, не враховуючи її оточення або специфічні деталі транзакції. Ми спостерігаємо її лише в глобальному масштабі на цьому першому етапі.

Тепер, коли ви розумієте, що таке модель, давайте перейдемо до інших існуючих моделей.

### Sweeping

Ця друга модель характеризується використанням одного UTXO як входу та створенням одного UTXO як виходу.

![BTC204](assets/en/32/04.webp)

Інтерпретація цієї моделі полягає в тому, що ми маємо справу з самопереказом. Користувач перевів свої біткоїни самому собі, на іншу адресу, якою він володіє. Оскільки у транзакції немає решти, дуже малоймовірно, що ми маємо справу з платежем. Дійсно, коли здійснюється платіж, майже неможливо, щоб платник мав UTXO, який точно відповідає сумі, потрібній продавцю, плюс комісія за транзакцію. Загалом, платник тому змушений створити вихід для решти.

Тоді ми знаємо, що спостережуваний користувач, ймовірно, все ще володіє цим UTXO. У контексті аналізу ланцюга, якщо ми знаємо, що UTXO, використаний як вхід у транзакції, належить Алісі, ми можемо припустити, що UTXO на виході також належить їй. Цікавим пізніше стане знаходження внутрішніх евристик транзакції, які могли б підсилити це припущення (ми вивчимо ці евристики в розділі 3.3).

Наприклад, ось транзакція Bitcoin, яка використовує модель sweeping:

```plaintext
35f1072a0fda5ae106efb4fda871ab40e1f8023c6c47f396441ad4b995ea693d
```

![BTC204](assets/en/32/05.webp)
Джерело: [Mempool.space](https://mempool.space/fr/tx/35f1072a0fda5ae106efb4fda871ab40e1f8023c6c47f396441ad4b995ea693d) Однак, цей тип шаблону також може вказувати на самопереказ на рахунок платформи обміну криптовалют. Це буде дослідження відомих адрес та контексту транзакції, яке дозволить нам знати, чи це переказ до гаманця самообслуговування, чи виведення на платформу. Дійсно, адреси платформ обміну часто легко ідентифікувати.

Повернімося до прикладу з Алісою: якщо переказ веде до відомої адреси платформи (наприклад, Binance), це може означати, що біткоїни були переведені з безпосереднього володіння Аліси, ймовірно, з наміром продати їх або зберігати на цій платформі. З іншого боку, якщо адреса призначення невідома, є розумно припустити, що це просто інший гаманець, який все ще належить Алісі. Але цей тип дослідження більше входить до категорії евристик, а не дослідження шаблонів.

### Консолідація

Ця модель характеризується споживанням кількох UTXO як вхідних даних та виробництвом одного UTXO як вихідного.

![BTC204](assets/en/32/06.webp)

Інтерпретація цієї моделі полягає в тому, що ми маємо справу з консолідацією. Це поширена практика серед користувачів Bitcoin, яка має на меті об'єднати кілька UTXO в очікуванні можливого зростання комісій за транзакції. Виконуючи цю операцію в період, коли комісії низькі, можна заощадити на майбутніх комісіях. Про цю практику ми поговоримо більше в розділі 4.3.

Ми можемо зробити висновок, що користувач, який стоїть за цією моделлю транзакції, ймовірно, володів усіма UTXO на входах і все ще володіє UTXO на виході. Це, безумовно, самопереказ.

Так само, як і при переказі, цей тип шаблону також може вказувати на самопереказ на рахунок платформи обміну. Це буде дослідження відомих адрес та контексту транзакції, яке дозволить нам знати, чи це консолідація до гаманця самообслуговування, чи виведення на платформу.

Наприклад, ось транзакція Bitcoin, яка використовує шаблон консолідації:

```plaintext
77c16914211e237a9bd51a7ce0b1a7368631caed515fe51b081d220590589e94
```

![BTC204](assets/en/32/07.webp)

Джерело: [Mempool.space](https://mempool.space/fr/tx/77c16914211e237a9bd51a7ce0b1a7368631caed515fe51b081d220590589e94)
У контексті аналізу ланцюга, ця модель може виявити багато інформації. Наприклад, якщо ми знаємо, що один з входів належить Алісі, ми можемо припустити, що всі інші входи та вихід цієї транзакції також належать їй. Це припущення дозволить нам прослідкувати через попередні ланцюги транзакцій, щоб відкрити та проаналізувати інші транзакції, ймовірно, асоційовані з Алісою.
![BTC204](assets/en/32/08.webp)

### Групові Витрати

Ця модель характеризується споживанням кількох UTXO як вхідних даних (часто лише одного) та виробництвом численних UTXO як вихідних.

![BTC204](assets/en/32/09.webp)
Інтерпретація цієї моделі полягає в тому, що ми маємо справу з груповими витратами. Це практика, яка, ймовірно, вказує на значну економічну активність, наприклад, на платформі обміну. Групові витрати дозволяють цим суб'єктам економити на комісіях, об'єднуючи свої витрати в одну транзакцію.
Ми можемо зробити висновок з цієї моделі, що вхід UTXO походить від компанії з значною економічною активністю, і що виходи UTXO будуть розсіюватися. Багато з них належатимуть клієнтам компанії, які вивели біткойни з платформи. Інші можуть піти до партнерських компаній. Нарешті, безсумнівно, буде одна або кілька обмінів, які повернуться до випускаючої компанії.

Наприклад, ось транзакція Bitcoin, яка використовує модель групових витрат (ймовірно, це транзакція, випущена платформою Bybit):

```plaintext
8a7288758b6e5d550897beedd13c70bcbaba8709af01a7dbcc1f574b89176b43
```

![BTC204](assets/en/32/10.webp)

Джерело: [Mempool.space](https://mempool.space/fr/tx/8a7288758b6e5d550897beedd13c70bcbaba8709af01a7dbcc1f574b89176b43)

### Транзакції, специфічні для протоколу

Серед моделей транзакцій ми також можемо ідентифікувати моделі, які вказують на використання конкретного протоколу. Наприклад, Whirlpool coinjoins (про які ми поговоримо в частині 5) матимуть легко ідентифіковану структуру, яка дозволяє їх відрізнити від інших більш традиційних транзакцій.

![BTC204](assets/en/32/11.webp)

Аналіз цієї моделі натякає на те, що ми, ймовірно, маємо справу з колаборативною транзакцією. Також можливо спостерігати coinjoin. Якщо ця остання гіпотеза виявиться точною, то кількість виходів може надати нам приблизну оцінку кількості учасників у coinjoin.

Наприклад, ось транзакція Bitcoin, яка використовує модель колаборативної транзакції типу coinjoin:

```plaintext
00601af905bede31086d9b1b79ee8399bd60c97e9c5bba197bdebeee028b9bea
```

![BTC204](assets/en/32/12.webp)

Джерело: [Mempool.space](https://mempool.space/fr/tx/00601af905bede31086d9b1b79ee8399bd60c97e9c5bba197bdebeee028b9bea)

Існує багато інших протоколів, які мають свої специфічні структури. Таким чином, ми могли б відрізнити транзакції типу Wabisabi, транзакції Stamps, або навіть Runes, наприклад.

Завдяки цим моделям транзакцій, ми вже можемо інтерпретувати низку інформації про дану транзакцію. Але структура транзакції не є єдиним джерелом інформації для аналізу. Ми також можемо вивчати її деталі. Ці деталі, внутрішні для транзакції, є тим, що я люблю називати "внутрішніми евристиками", і ми вивчимо їх у наступному розділі.

## Внутрішні евристики
<chapterId>c54b5abe-872f-40f4-a0d0-c59faff228ba</chapterId>

Внутрішня евристика - це конкретна характеристика, ідентифікована в самій транзакції, без необхідності аналізувати її оточення, яка дозволяє нам робити висновки. На відміну від моделей, які зосереджені на загальній структурі транзакції на високому рівні, внутрішні евристики базуються на наборі даних, які можна витягти. Це включає:
- Обсяги різних UTXO, як вхідних, так і вихідних;
- Все, що стосується скриптів: адреси отримувачів, версіонування, часи блокування...

Загалом, цей тип евристики дозволяє нам ідентифікувати зміну в конкретній транзакції. Роблячи це, ми можемо продовжувати відстежувати сутність через кілька різних транзакцій. Дійсно, якщо ми ідентифікуємо UTXO, що належить користувачу, за яким ми хочемо слідкувати, критично важливо визначити, коли вони здійснюють транзакцію, який вихід був переданий іншому користувачу, а який вихід представляє зміну, отже, залишається у їхньому володінні.

![BTC204](assets/en/33/01.webp)

Ще раз нагадую, що ці евристики не абсолютно точні. Взяті окремо, вони дозволяють нам ідентифікувати лише ймовірні сценарії. Це накопичення кількох евристик, яке допомагає зменшити невизначеність, ніколи повністю її не усуваючи.

### Внутрішні Схожості

Ця евристика передбачає вивчення схожостей між входами та виходами однієї транзакції. Якщо ми спостерігаємо однакову характеристику на входах і лише на одному з виходів транзакції, то ймовірно, що цей вихід є зміною.

Найбільш очевидною характеристикою є повторне використання адреси отримувача в одній і тій же транзакції.

![BTC204](assets/en/33/02.webp)
Ця евристика залишає мало місця для сумнівів. Якщо приватний ключ не був зламаний, та сама адреса отримувача неминуче виявляє активність одного користувача. Висновок, що слідує з цього, полягає в тому, що зміна з транзакції є виходом з тією ж адресою, що й вхід. Це дозволяє продовжувати відстеження особи на основі цієї зміни.
Наприклад, ось транзакція, на якій цю евристику можна розумно застосувати:

```plaintext
54364146665bfc453a55eae4bfb8fdf7c721d02cb96aadc480c8b16bdeb8d6d0
```

![BTC204](assets/notext/33/03.webp)

Джерело: [Mempool.space](https://mempool.space/tx/54364146665bfc453a55eae4bfb8fdf7c721d02cb96aadc480c8b16bdeb8d6d0)

Ці схожості між входами та виходами не обмежуються повторним використанням адрес. Будь-яка схожість у використанні скриптів може дозволити застосувати евристику. Наприклад, іноді можна спостерігати однакове версіонування між входом і одним з виходів транзакції.

![BTC204](assets/en/33/04.webp)

На цій діаграмі ми бачимо, що вхід №0 розблокує скрипт P2WPKH (SegWit V0, що починається з `bc1q`). Вихід №0 використовує той самий тип скрипту. Однак, вихід №1 використовує скрипт P2TR (SegWit V1, що починається з `bc1p`). Інтерпретація цієї характеристики полягає в тому, що ймовірно адреса з тим самим версіонуванням, що й вхід, є адресою зміни. Отже, вона все ще належала б тому самому користувачу.

Ось транзакція, на якій цю евристику можна розумно застосувати:

```plaintext
db07516288771ce5d0a06b275962ec4af1b74500739f168e5800cbcb0e9dd578
```

![BTC204](assets/notext/33/05.webp)

Джерело: [Mempool.space](https://mempool.space/tx/db07516288771ce5d0a06b275962ec4af1b74500739f168e5800cbcb0e9dd578)
У цьому випадку ми бачимо, що вхід № 0 та вихід № 1 використовують скрипти P2WPKH (SegWit V0), тоді як вихід № 0 використовує інший тип скрипта, P2PKH (Legacy). На початку 2010-х років ця евристика, заснована на версіонуванні скриптів, була відносно малокорисною через обмеження типів доступних скриптів. Однак, з часом та з послідовними оновленнями Bitcoin, було введено все більшу різноманітність типів скриптів. Ця евристика стає все більш та більш актуальною, оскільки, з ширшим діапазоном типів скриптів, користувачі поділяються на менші групи, таким чином збільшуючи шанси застосування цієї евристики повторного використання внутрішньої версії. З цієї причини, лише з точки зору конфіденційності, рекомендується вибирати найбільш поширений тип скрипта. Наприклад, на момент написання цих рядків, скрипти Taproot (`bc1p`) використовуються рідше, ніж скрипти SegWit V0 (`bc1q`). Хоча перші пропонують економічні та конфіденційні переваги в певних конкретних контекстах, для більш традиційних використань з одним підписом, може бути розумно дотримуватися старішого стандарту з міркувань конфіденційності, доки новий стандарт не стане ширше прийнятим.

### Платежі Круглими Сумами

Інша внутрішня евристика, яка може допомогти нам ідентифікувати решту, - це евристика круглих сум. Зазвичай, коли ми маємо справу з простим шаблоном платежу (1 вхід і 2 виходи), якщо один з виходів витрачає круглу суму, то він представляє платіж.

![BTC204](assets/en/33/06.webp)

Виходячи з видалення, якщо один вихід представляє платіж, інший представляє решту. Таким чином, можна зробити висновок, що ймовірно користувач, який вводить транзакцію, все ще володіє виходом, ідентифікованим як решта.

Слід зазначити, що ця евристика не завжди застосовна, оскільки більшість платежів все ще здійснюється в одиницях фіатної валюти. Дійсно, коли торговець у Франції приймає біткойни, зазвичай, вони не встановлюють стабільні ціни в сатах. Вони воліли б обмін між ціною в євро та сумою в біткойнах, яка має бути сплачена. Тому в виході транзакції не повинно бути круглої суми.

Однак аналітик міг би спробувати зробити цей обмін, враховуючи курс обміну, що діяв у момент трансляції транзакції в мережі. Візьмемо для прикладу транзакцію з входом `97,552 сатс` і двома виходами, один з `31,085 сатс` і інший з `64,152 сатс`. На перший погляд, ця транзакція не здається залученою круглими сумами. Однак, застосувавши курс обміну €64,339 на момент транзакції, ми отримуємо конверсію в євро, яка виглядає наступним чином:
- Вхід на €62.76;
- Вихід на €20;
- Вихід на €41.27.
Після конвертації в фіатну валюту, ця транзакція дозволяє застосувати евристику платежів круглими сумами. Вихід на €20, ймовірно, був призначений для торговця, або принаймні змінив власника. Виходячи з видалення, вихід на €41.27, ймовірно, залишився у володінні оригінального користувача.
![BTC204](assets/en/33/07.webp)

Якщо одного дня Bitcoin стане переважною одиницею обліку в наших транзакціях, ця евристика може стати ще кориснішою для аналізу.

Наприклад, ось транзакція, де цю евристику, ймовірно, можна застосувати:

```plaintext
2bcb42fab7fba17ac1b176060e7d7d7730a7b807d470815f5034d52e96d2828a
```

![BTC204](assets/notext/33/08.webp)
Джерело: [Mempool.space](https://mempool.space/tx/2bcb42fab7fba17ac1b176060e7d7d7730a7b807d470815f5034d52e96d2828a)
### Найбільший Вихід

Коли помічається достатньо велика різниця між двома виходами транзакції в простій моделі платежу, можна припустити, що більший вихід, ймовірно, є рештою.

![BTC204](assets/en/33/09.webp)

Ця евристика найбільшого виходу, ймовірно, є найменш точною з усіх. Якщо вона ідентифікована сама по собі, вона досить слабка. Однак, цю характеристику можна поєднати з іншими евристиками, щоб зменшити невизначеність нашого тлумачення.

Наприклад, якщо ми розглядаємо транзакцію, яка представляє вихід з круглою сумою та інший вихід з більшою сумою, спільне застосування евристики круглих платежів та тієї, що стосується найбільшого виходу, дозволяє нам зменшити наш рівень невизначеності.

Наприклад, ось транзакція, де цю евристику, ймовірно, можна застосувати:

```plaintext
b79d8f8e4756d34bbb26c659ab88314c220834c7a8b781c047a3916b56d14dcf
```

![BTC204](assets/notext/33/10.webp)

Джерело: [Mempool.space](https://mempool.space/tx/b79d8f8e4756d34bbb26c659ab88314c220834c7a8b781c047a3916b56d14dcf)

## Зовнішні Евристики
<chapterId>4a170e3b-200d-431a-8285-18a23ff617ba</chapterId>

Вивчення зовнішніх евристик включає аналіз схожостей, шаблонів та характеристик певних елементів, які не є властивими самій транзакції. Іншими словами, якщо раніше ми обмежувалися використанням елементів, властивих транзакції з внутрішніми евристиками, тепер ми розширюємо наше поле аналізу до середовища транзакції завдяки зовнішнім евристикам.

### Повторне Використання Адреси

Це одна з найвідоміших евристик серед ентузіастів Bitcoin. Повторне використання адреси дозволяє встановити зв'язок між різними транзакціями та різними UTXO. Це спостерігається, коли адреса для отримання Bitcoin використовується кілька разів.

Таким чином, можливо використовувати повторне використання адреси в межах тієї ж транзакції як внутрішню евристику для ідентифікації решти (як ми бачили в попередньому розділі). Однак, повторне використання адреси також може слугувати зовнішньою евристикою для визнання унікальності сутності за кількома транзакціями.

Тлумачення повторного використання адреси полягає в тому, що всі UTXO, заблоковані на цій адресі, належать (або належали) одній і тій же сутності. Ця евристика залишає мало місця для невизначеності. Коли її можливо ідентифікувати, тлумачення, що слідує, з великою ймовірністю відповідає дійсності. Таким чином, вона дозволяє групувати різні ончейн активності.

![BTC204](assets/en/34/01.webp)

Як пояснено в уведенні до цієї частини 3, цю евристику відкрив сам Сатоші Накамото. У Білому Папері він конкретно згадує рішення для користувачів, щоб уникнути її виробництва, яке полягає просто у використанні нової адреси для кожної нової транзакції:

"_Як додатковий захист, нова пара ключів могла б бути використана для кожної транзакції, щоб вони не були пов'язані з загальним власником._"

![BTC204](assets/notext/34/02.webp)

Джерело: С. Накамото, "Bitcoin: Електронна готівка однорангової мережі", https://bitcoin.org/bitcoin.pdf, 2009.

Наприклад, ось адреса, яка використовувалася в кількох транзакціях:

```plaintext
bc1qqtmeu0eyvem9a85l3sghuhral8tk0ar7m4a0a0

![BTC204](assets/notext/34/03.webp)

Джерело: [Mempool.space](https://mempool.space/address/bc1qqtmeu0eyvem9a85l3sghuhral8tk0ar7m4a0a0)

### Схожість скриптів та відбитки гаманців

Окрім повторного використання адрес, існує багато інших евристик, які дозволяють пов'язувати дії з одним гаманцем або з кластером адрес.
Перш за все, аналітик може скористатися схожістю у використанні скриптів. Наприклад, певні менш поширені скрипти, як multisig, можуть бути легше ідентифіковані, ніж скрипти SegWit V0. Чим більша група, в якій ми ховаємося, тим важче нас помітити. Саме тому, у хороших протоколах Coinjoin, всі учасники використовують абсолютно однаковий тип скрипта.
Більш широко, аналітик також може зосередитися на характерних відбитках гаманця. Це специфічні процеси, пов'язані з використанням, які можна намагатися ідентифікувати з метою їх використання як евристик для відстеження. Іншими словами, якщо спостерігається накопичення однакових внутрішніх характеристик у транзакціях, приписаних до відстежуваної сутності, можна спробувати ідентифікувати ці самі характеристики на інших транзакціях.

Наприклад, можна ідентифікувати, що відстежуваний користувач систематично відправляє свою решту на адреси P2TR (`bc1p…`). Якщо цей процес повторюється, його можна використовувати як евристику для продовження нашого аналізу. Інші відбитки також можуть бути використані, такі як порядок UTXO, розміщення решти у виходах, сигналізація RBF (Replace-by-Fee), або навіть номер версії, поле `nSequence` та поле `nLockTime`.

![BTC204](assets/en/34/04.webp)

Як уточнює [@LaurentMT](https://twitter.com/LaurentMT) у [Space Kek #19](https://podcasters.spotify.com/pod/show/decouvrebitcoin/episodes/SpaceKek-19---Analyse-de-chane--anonsets-et-entropie-e1vfuji) (франкомовний подкаст), користь від відбитків гаманців у аналізі блокчейна значно зростає з часом. Дійсно, зростаюча кількість типів скриптів та все більш поступове впровадження цих нових функцій програмним забезпеченням гаманців підкреслює відмінності. Навіть може статися, що можна точно ідентифікувати програмне забезпечення, використане відстежуваною сутністю. Тому важливо розуміти, що вивчення відбитка гаманця є особливо актуальним для недавніх транзакцій, більше ніж для тих, що були ініційовані на початку 2010-х.

Підсумовуючи, відбиток може бути будь-якою конкретною практикою, яку автоматично виконує гаманець або вручну користувач, яку можна знайти в інших транзакціях, щоб допомогти нам у нашому аналізі.

### Евристика спільного володіння вхідними даними (CIOH)

CIOH, або "Евристика спільного володіння вхідними даними" англійською, є евристикою, яка стверджує, що коли транзакція включає кілька входів, ці входи, ймовірно, всі належать одній сутності. Отже, їх володіння є спільним.
Щоб застосувати Евристику Спільного Володіння Входами (CIOH), спочатку ми спостерігаємо за транзакцією, яка має кілька входів. Це може бути як мінімум 2 входи або ж до 30 входів. Як тільки ця характеристика виявлена, ми перевіряємо, чи не вписується транзакція в відомі моделі транзакцій. Наприклад, якщо вона має 5 входів з приблизно однаковою сумою та 5 виходів з точно такою ж сумою, ми знаємо, що це структура coinjoin. Тому ми не можемо застосувати CIOH.
Однак, якщо транзакція не вписується в жодну відому модель колаборативної транзакції, тоді ми можемо припустити, що всі входи, ймовірно, належать одній і тій же сутності. Це може бути дуже корисним для розширення відомого кластера або для продовження трасування.

CIOH була відкрита Сатоші Накамото. Він обговорює її в частині 10 Білого Паперу:

"_[...] зв'язок неминучий з транзакціями з кількома входами, які обов'язково виявляють, що їхні входи належали одному власнику. Ризик полягає в тому, що якщо власник ключа буде розкритий, зв'язки можуть виявити інші транзакції, які належали тому ж власнику._"

Особливо захоплює те, що Сатоші Накамото, навіть до офіційного запуску Bitcoin, вже визначив дві основні вразливості з точки зору приватності користувачів, а саме CIOH та повторне використання адрес. Таке передбачення є досить видатним, оскільки ці дві евристики залишаються, навіть сьогодні, найбільш корисними в аналізі ланцюгів.

Щоб дати вам приклад, ось транзакція, до якої ми, ймовірно, можемо застосувати CIOH:

```plaintext
20618e63b6eed056263fa52a2282c8897ab2ee71604c7faccfe748e1a202d712
```

Джерело: [Mempool.space](https://mempool.space/tx/20618e63b6eed056263fa52a2282c8897ab2ee71604c7faccfe748e1a202d712)

### Дані поза ланцюгом

Очевидно, аналіз ланцюгів не обмежується виключно даними в ланцюгу. Будь-які дані з попередніх аналізів або доступні в інтернеті також можуть бути використані для уточнення аналізу.
Наприклад, якщо спостерігається, що відстежувані транзакції систематично транслюються з одного вузла Bitcoin і його IP-адресу можна ідентифікувати, можна виявити інші транзакції від тієї ж сутності, крім визначення частини ідентичності відправника. Хоча ця практика не є легко досяжною, оскільки вимагає експлуатації багатьох вузлів, можливо, деякі компанії, що спеціалізуються на аналізі ланцюгів, використовують її.

Аналітик також має можливість покладатися на аналізи, раніше зроблені відкритими, або на свої власні попередні аналізи. Можливо, хтось знайде вихід, який вказує на кластер адрес, який вже був ідентифікований. Іноді також можливо покладатися на виходи, які вказують на платформу обміну, адреси цих компаній зазвичай відомі.

Таким же чином, можна провести аналіз методом виключення. Наприклад, якщо під час аналізу транзакції з двома виходами один з них пов'язаний з вже відомим кластером адрес, але відмінним від відстежуваної сутності, тоді можна інтерпретувати, що інший вихід, ймовірно, представляє решту.

Аналіз ланцюгів також включає частину OSINT (*Open Source Intelligence*), яка є трохи більш загальною з пошуками в інтернеті. Саме тому не рекомендується публікувати отримувальні адреси безпосередньо в соціальних мережах або на вебсайті, чи то під псевдонімом, чи ні.

![BTC204](assets/notext/34/10.webp)

### Тимчасові Моделі
Менш відомо, але певні людські поведінки можна розпізнати в блокчейні. Найкориснішим у аналізі може бути ваш розпорядок сну! Так, коли ви спите, ви, ймовірно, не здійснюєте транзакції Bitcoin. Оскільки ви зазвичай спите приблизно в одні й ті ж години, поширеною практикою є використання часових аналізів у аналізі блокчейну. Це просто передбачає каталогізацію годин, у які транзакції даної сутності транслюються в мережу Bitcoin. Аналіз цих часових моделей дозволяє нам вивести багато інформації.

Перш за все, часовий аналіз іноді дозволяє ідентифікувати природу відстежуваної сутності. Якщо спостерігається, що транзакції транслюються послідовно протягом 24 годин, то це вказує на сильну економічну активність. Сутність за цими транзакціями, ймовірно, є компанією, потенційно міжнародною, і, можливо, з автоматизованими процедурами внутрішньо.

Наприклад, [я впізнав цю модель кілька місяців тому](https://twitter.com/Loic_Pandul/status/1701127409712452072), аналізуючи [транзакцію, яка помилково виділила 19 біткойнів у вигляді комісій](https://mempool.space/tx/d5392d474b4c436e1c9d1f4ff4be5f5f9bb0eb2e26b61d2781751474b7e870fd). Простий часовий аналіз дозволив мені припустити, що ми маємо справу з автоматизованою службою, а отже, ймовірно, з великою сутністю, як-от платформою обміну.

Дійсно, через кілька днів було виявлено, що кошти належали PayPal через платформу обміну Paxos.

Навпаки, якщо ми бачимо, що часовий візерунок розподілений скоріше протягом 16 дуже конкретних годин, то ми можемо оцінити, що маємо справу з індивідуальним користувачем, або, можливо, з місцевим бізнесом залежно від обсягів торгівлі.

Крім природи спостережуваної сутності, часовий візерунок також може дати нам приблизне місцезнаходження користувача завдяки часовим поясам. Таким чином, ми можемо зв'язати інші транзакції та використовувати часову мітку цих як додаткову евристику, яку можна додати до нашого аналізу.

Наприклад, на повторно використаній адресі, про яку я раніше говорив, ми можемо спостерігати, що транзакції, незалежно від того, вхідні вони чи вихідні, зосереджені протягом 13-годинного інтервалу.

```plaintext
bc1qqtmeu0eyvem9a85l3sghuhral8tk0ar7m4a0a0
```

![BTC204](assets/notext/34/11.webp)

Джерело: OXT.me

Цей інтервал, ймовірно, відповідає Європі, Африці або Близькому Сходу. Таким чином, ми можемо зробити висновок, що користувач за цими транзакціями живе там.

У іншому реєстрі, це також часовий аналіз цього типу, який дозволив припустити, що Сатоші Накамото не працював з Японії, а насправді зі Сполучених Штатів: [*Часові пояси Сатоші Накамото*](https://medium.com/@insearchofsatoshi/the-time-zones-of-satoshi-nakamoto-aa40f035178f)

## Практичне застосування з допомогою Block Explorer
<chapterId>6493cf2f-225c-405f-9375-c4304f1087ed</chapterId>

У цьому останньому розділі ми конкретно застосуємо концепції, які ми досі вивчали. Я представлю вам приклади реальних транзакцій Bitcoin, і вам потрібно буде витягти інформацію, яку я запитую.
Ідеально, для цих вправ використання професійного інструменту аналізу ланцюгів було б бажаним. Однак, після арешту творців Samourai Wallet, єдиний безкоштовний інструмент аналізу OXT.me більше не доступний. Тому ми виберемо класичний блок-експлорер для цих вправ. Я рекомендую використовувати [Mempool.space](https://mempool.space/) за його численні функції та набір інструментів аналізу ланцюгів, але ви також можете вибрати інший експлорер, наприклад, [Bitcoin Explorer](https://bitcoinexplorer.org/). Для початку я представлю вправи. Використовуйте ваш блок-експлорер, щоб виконати їх та запишіть ваші відповіді на шматку паперу. Потім, в кінці цього розділу, я надам відповіді, щоб ви могли перевірити та виправити свої результати.

*Транзакції, обрані для цих вправ, були вибрані виключно за їх характеристиками у дещо випадковому порядку. Цей розділ призначений виключно для освітніх та інформаційних цілей. Я хочу уточнити, що я не підтримую та не заохочую використання цих інструментів зі зловмисними намірами. Мета полягає в тому, щоб навчити вас захищатися від аналізу ланцюгів, а не проводити аналізи для розкриття приватної інформації інших.*

### Вправа 1

ID транзакції для аналізу:

```plaintext
3769d3b124e47ef4ffb5b52d11df64b0a3f0b82bb10fd6b98c0fd5111789bef7
```

Яка назва моделі цієї транзакції та які правдоподібні інтерпретації можна зробити, аналізуючи лише її модель, тобто структуру транзакції?

### Вправа 2

ID транзакції для аналізу:

```plaintext
baa228f6859ca63e6b8eea24ffad7e871713749d693ebd85343859173b8d5c20
```

Яка назва моделі цієї транзакції та які правдоподібні інтерпретації можна зробити, аналізуючи лише її модель, тобто структуру транзакції?

### Вправа 3

ID транзакції для аналізу:

```plaintext
3a9eb9ccc3517cc25d1860924c66109262a4b68f4ed2d847f079b084da0cd32b
```

Яка модель цієї транзакції?

Після ідентифікації її моделі, використовуючи внутрішні евристики транзакції, який вихід, ймовірно, представляє здачу?

### Вправа 4

ID транзакції для аналізу:

```plaintext
35f0b31c05503ebfdf7311df47f68a048e992e5cf4c97ec34aa2833cc0122a12
```

Яка модель цієї транзакції?
Після ідентифікації її моделі, використовуючи внутрішні евристики транзакції, який вихід, ймовірно, представляє здачу?
### Вправа 5

Уявіть, що Лоїк розмістив одну зі своїх Bitcoin приймальних адрес на соціальній мережі Twitter:

![BTC204](assets/notext/35/1.webp)

```plaintext
bc1qja0hycrv7g9ww00jcqanhfpqmzx7luqalum3vu
```

Використовуючи **лише евристику повторного використання адреси**, які Bitcoin транзакції ми можемо пов'язати з ідентичністю Лоїка?

*Очевидно, я не справжній власник цієї приймальної адреси і я не розміщував її в соціальних мережах. Це адреса, яку я випадково вибрав з блокчейну.*

### Вправа 6

Після Вправи 5, завдяки евристиці повторного використання адреси, ви змогли ідентифікувати кілька Bitcoin транзакцій, в яких, здається, брав участь Лоїк. Зазвичай, серед ідентифікованих транзакцій, ви повинні були помітити цю:
Ця транзакція є першою, яка відправляє кошти на адресу Лоїка. На вашу думку, звідки Лоїк отримав біткоїни через цю транзакцію?

### Вправа 7

Після вправи 5, завдяки евристиці повторного використання адреси, вам вдалося ідентифікувати кілька біткоїн-транзакцій, в яких, здається, бере участь Лоїк. Тепер ви хочете дізнатися, звідки Лоїк. На основі знайдених транзакцій проведіть темпоральний аналіз, щоб знайти ймовірний часовий пояс, яким користується Лоїк. З цього часового поясу визначте місце, де, здається, живе Лоїк (країна, штат/регіон, місто...).

![BTC204](assets/notext/35/2.webp)

### Вправа 8

Ось біткоїн-транзакція для вивчення:

```plaintext
bb346dae645d09d32ed6eca1391d2ee97c57e11b4c31ae4325bcffdec40afd4f
```

Спостерігаючи лише за цією транзакцією, яку інформацію ми можемо інтерпретувати?

### Рішення до вправ

***Вправа 1:***
Модель цієї транзакції є моделлю простого платежу. Якщо ми аналізуємо лише її структуру, ми можемо інтерпретувати, що один вихід представляє решту, а інший вихід представляє справжній платіж. Таким чином, ми знаємо, що спостережуваний користувач, ймовірно, більше не володіє одним з двох UTXO на виходах (тим, що для платежу), але все ще володіє іншим UTXO (тим, що для решти).

***Вправа 2:***
Модель цієї транзакції є моделлю пакетного витрачання. Ця модель, ймовірно, вказує на значну економічну активність, наприклад, платформу обміну. Ми можемо зробити висновок, що UTXO на вході походить від компанії зі значною економічною активністю, і що UTXO на виходах будуть розподілені. Деякі належатимуть клієнтам компанії, які вивели свої біткоїни на гаманці для самостійного зберігання. Інші можуть піти до партнерських компаній. Нарешті, безсумнівно, буде решта, яка повернеться до випускаючої компанії.

***Вправа 3:***

Модель цієї транзакції є моделлю простого платежу. Тому ми можемо застосувати внутрішні евристики до транзакції, щоб спробувати ідентифікувати решту.

Я особисто ідентифікував принаймні дві внутрішні евристики, які підтримують одну і ту ж гіпотезу:
- Повторне використання того ж типу скрипта;
- Найбільший вихід.

Найбільш очевидна евристика - повторне використання того ж типу скрипта. Дійсно, вихід `0` є `P2SH`, що впізнається за його адресою, яка починається з `3`:

```plaintext
3Lcdauq6eqCWwQ3UzgNb4cu9bs88sz3mKD
```

Тоді як вихід `1` є `P2WPKH`, ідентифікований за його адресою, яка починається з `bc1q`:

```plaintext
bc1qya6sw6sta0mfr698n9jpd3j3nrkltdtwvelywa
```

UTXO, використаний на вході для цієї транзакції, також використовує скрипт `P2WPKH`:

```plaintext
bc1qyfuytw8pcvg5vx37kkgwjspg73rpt56l5mx89k
```

Таким чином, ми можемо припустити, що вихід `0` відповідає платежу, а вихід `1` є рештою транзакції, що означало б, що користувач на вході все ще володіє виходом `1`.
Для підтримки або спростування цієї гіпотези ми можемо шукати інші евристики, які або підтверджують нашу думку, або знижують ймовірність того, що наша гіпотеза вірна.
Я помітив принаймні одну іншу евристику. Це найбільший вихід. Вихід `0` має `123,689 сатоші`, тоді як вихід `1` має `505,839 сатоші`. Отже, між цими двома виходами є значна різниця. Евристика найбільшого виходу припускає, що найбільший за об'ємом вихід, ймовірно, є здачею. Таким чином, ця евристика додатково зміцнює нашу початкову гіпотезу.

Ймовірно, що користувач, який надав UTXO на вхід, все ще володіє виходом `1`, який, схоже, втілює здачу транзакції.

***Вправа 4:***
Модель цієї транзакції є моделлю простого платежу. Тому ми можемо застосувати внутрішні евристики до транзакції, щоб спробувати ідентифікувати здачу.
Я особисто ідентифікував принаймні дві внутрішні евристики, які підтримують ту саму гіпотезу:
- Повторне використання того самого типу скрипта;
- Вихід круглої суми.

Найбільш очевидна евристика - це повторне використання того самого типу скрипта. Дійсно, вихід `0` є `P2SH`, що впізнається за його адресою, яка починається з `3`:

```plaintext
3FSH5Mnq6S5FyQoKR9Yjakk3X4KCGxeaD4
```

Тоді як вихід `1` є `P2WPKH`, ідентифікований за адресою, що починається з `bc1q`:

```plaintext
bc1qvdywdcfsyavt4v8uxmmrdt6meu4vgeg439n7sg
```

UTXO, використаний як вхід для цієї транзакції, також використовує скрипт `P2WPKH`:

```plaintext
bc1qku3f2y294h3ks5eusv63dslcua2xnlzxx0k6kp
```

Отже, ми можемо припустити, що вихід `0` відповідає платежу, а вихід `1` є здачею транзакції, що означає, що користувач на вході все ще володіє виходом `1`.

Для підтримки або спростування цієї гіпотези ми можемо шукати інші евристики, які або підтверджують нашу думку, або знижують ймовірність того, що наша гіпотеза вірна.

Я помітив принаймні одну іншу евристику. Це вихід круглої суми. Вихід `0` має `70,000 сатоші`, тоді як вихід `1` має `22,962 сатоші`. Отже, ми маємо справу з виходом, який ідеально круглий у одиницях обліку BTC. Евристика круглого виходу припускає, що UTXO з круглою сумою, ймовірно, є платежем, і за виключенням, інший представляє здачу. Таким чином, ця евристика додатково зміцнює нашу початкову гіпотезу.

Однак, у цьому прикладі, інша евристика могла б поставити під сумнів нашу початкову гіпотезу. Дійсно, вихід `0` більший за вихід `1`. Якщо ми виходимо з евристики, що найбільший вихід, зазвичай, є здачею, ми могли б зробити висновок, що вихід `0` є здачею. Однак, ця контргіпотеза здається неправдоподібною, оскільки дві інші евристики здаються значно більш переконливими, ніж та, що стосується найбільшого виходу. Таким чином, здається розумним підтримувати нашу початкову гіпотезу, незважаючи на це очевидне протиріччя.
Отже, ймовірно, що користувач, який надав UTXO на вхід, все ще володіє виходом `1`, який, схоже, представляє здачу з транзакції.
***Вправа 5:***
Ми можемо побачити, що з ідентичністю Loïc можна асоціювати 8 транзакцій. Серед них, 4 включають отримання біткойнів:

```plaintext
***Вправа 6:***
Якщо ми розглянемо модель цієї транзакції, стає очевидним, що це груповий витрат. Дійсно, транзакція має один вхід і 51 вихід, що вказує на значну економічну активність. Тому ми можемо припустити, що Лоїк здійснив виведення біткойнів з платформи обміну.

Кілька елементів посилюють цю гіпотезу. По-перше, тип скрипта, що використовується для забезпечення UTXO на вході, є 2/3 multisig P2SH скриптом, що вказує на високий рівень безпеки, типовий для платформ обміну:

```plaintext
OP_PUSHNUM_2
OP_PUSHBYTES_33 03eae02975918af86577e1d8a257773118fd6ceaf43f1a543a4a04a410e9af4a59
OP_PUSHBYTES_33 03ba37b6c04aaf7099edc389e22eeb5eae643ce0ab89ac5afa4fb934f575f24b4e
OP_PUSHBYTES_33 03d95ef2dc0749859929f3ed4aa5668c7a95baa47133d3abec25896411321d2d2d
OP_PUSHNUM_3
OP_CHECKMULTISIG
```
Більше того, аналізована адреса `3PUv9tQMSDCEPSMsYSopA5wDW86pwRFbNF` використовується у понад 220,000 різних транзакціях, що часто є характерним для платформ обміну, які зазвичай не переймаються своєю конфіденційністю. Тимчасова евристика, застосована до цієї адреси, також показує регулярний розподіл транзакцій майже щодня протягом 3 місяців, з розширеними годинами протягом 24 годин, що свідчить про безперервну активність платформи обміну.

Нарешті, обсяги, оброблені цією сутністю, є величезними. Дійсно, адреса отримала та відправила 44 BTC під час 222,262 транзакцій між груднем 2022 року та березнем 2023 року. Ці значні обсяги додатково підтверджують ймовірну природу діяльності платформи обміну.

***Вправа 7:***
Аналізуючи час підтвердження транзакцій, можна відзначити наступні часи за UTC:
```plaintext
05:43
20:51
18:12
17:16
04:28
23:38
07:45
21:55
```

Аналізуючи ці часи, здається, що часові зони UTC-7 та UTC-8 відповідають діапазону звичайних людських активностей (між 08:00 та 23:00) для більшості часів:

```plaintext
05:43 UTC > 22:43 UTC-7
20:51 UTC > 13:51 UTC-7
18:12 UTC > 11:12 UTC-7
17:16 UTC > 10:16 UTC-7
04:28 UTC > 21:28 UTC-7
23:38 UTC > 16:38 UTC-7
07:45 UTC > 00:45 UTC-7
21:55 UTC > 14:55 UTC-7

05:43 UTC > 21:43 UTC-8
20:51 UTC > 12:51 UTC-8
18:12 UTC > 10:12 UTC-8
17:16 UTC > 09:16 UTC-8
04:28 UTC > 20:28 UTC-8
23:38 UTC > 15:38 UTC-8
07:45 UTC > 23:45 UTC-8
21:55 UTC > 13:55 UTC-8
```

![BTC204](assets/notext/35/2.webp)

Часова зона UTC-7 особливо актуальна влітку, оскільки вона включає такі штати та регіони, як:
- Каліфорнія (з містами, такими як Лос-Анджелес, Сан-Франциско та Сан-Дієго);
- Невада (з Лас-Вегасом);
- Орегон (з Портлендом);
- Вашингтон (з Сіетлом);
- Канадський регіон Британська Колумбія (з містами, такими як Ванкувер та Вікторія).

Ці дані дають підстави припустити, що Лоїк міг би мешкати на західному узбережжі Сполучених Штатів або Канади.

***Вправа 8:***
Аналіз цієї транзакції виявляє 5 входів та один вихід, що, здається, вказує на консолідацію. Застосування евристики CIOH припускає, що всі UTXO на входах належать одній сутності, і що UTXO на виході також належить цій сутності. Здається, що користувач вирішив консолідувати кілька UTXO, які він володів, в один UTXO на виході з метою консолідації своїх монет. Цей підхід, ймовірно, був мотивований бажанням скористатися низькими комісійними зборами в той час, щоб зменшити майбутні збори.
___

*При написанні цієї частини 3 про аналіз ланцюга я спирався на наступні ресурси:*
- *Серія з чотирьох статей під назвою: [Understanding Bitcoin Privacy with OXT](https://medium.com/oxt-research/understanding-bitcoin-privacy-with-oxt-part-1-4-8177a40a5923), створена Samourai Wallet у 2021 році;*
- *Різні звіти від [OXT Research](https://medium.com/oxt-research), а також їх безкоштовний інструмент для аналізу ланцюга (який наразі недоступний через арешт засновників Samourai Wallet);*
- *Більш широко, мої знання походять з різних твітів та контенту від [@LaurentMT](https://twitter.com/LaurentMT) та [@ErgoBTC](https://twitter.com/ErgoBTC);*
- *The [Space Kek #19](https://podcasters.spotify.com/pod/show/decouvrebitcoin/episodes/SpaceKek-19---Analyse-de-chane--anonsets-et-entropie-e1vfuji), у якому я брав участь разом з [@louneskmt](https://twitter.com/louneskmt), [@TheoPantamis](https://twitter.com/TheoPantamis), [@Sosthene___](https://twitter.com/Sosthene___), та [@LaurentMT](https://twitter.com/LaurentMT).*
*Я хотів би подякувати їхнім авторам, розробникам та продюсерам. Також спасибі рецензентам, які ретельно виправили статтю, що послужила основою для цієї частини 3, і надали мені свої експертні поради:*
- *[Gilles Cadignan](https://twitter.com/gillesCadignan);*
- *[Ludovic Lars](https://viresinnumeris.fr/).*

# Оволодіння найкращими практиками для захисту вашої конфіденційності
<partId>9bd04b63-f1af-4e50-9061-6bc90009df68</partId>

## Повторне використання адрес
<chapterId>f3e97645-3df3-41bc-a4ed-d2c740113d96</chapterId>
Після вивчення технік, які можуть порушити вашу конфіденційність на Bitcoin, у цій третій частині ми тепер розглянемо найкращі практики, які слід прийняти для захисту себе. Ця частина не має на меті досліджувати методи покращення конфіденційності, тема, яка буде розглянута пізніше, але радше зрозуміти, як правильно взаємодіяти з Bitcoin, щоб підтримувати конфіденційність, яку він природно пропонує, не вдаючись до додаткових технік.
Очевидно, що для початку цієї третьої частини ми поговоримо про повторне використання адрес. Це явище становить основну загрозу конфіденційності користувачів. Тому цей розділ, можливо, є найважливішим у всьому навчанні.

### Що таке адреса для отримання?

Адреса для отримання Bitcoin - це рядок символів або ідентифікатор, який використовується для отримання біткойнів у гаманці.

Технічно, адреса для отримання Bitcoin не "отримує" біткойни в буквальному сенсі, але визначає умови, за яких біткойни можуть бути витрачені. Зокрема, коли вам надсилається платіж, транзакція відправника створює новий UTXO, призначений для вас, у виході з UTXO, які він використав у входах. На цьому виході застосовується скрипт, який визначає, як цей UTXO може бути витрачений пізніше. Цей скрипт відомий як "*ScriptPubKey*" або "*Locking Script*". Ваша адреса для отримання, точніше її вантаж, інтегрована в цей скрипт. Для спрощення, цей скрипт по суті стверджує:

> "*Для витрати цього нового UTXO, має бути надано цифровий підпис за допомогою приватного ключа, асоційованого з цією адресою для отримання.*"

![BTC204](assets/notext/41/01.webp)

Адреси Bitcoin існують у різних типах залежно від використаного моделі скрипта. Перші моделі, відомі як "*Legacy*," включають `P2PKH` (*Pay-to-PubKey-Hash*) та `P2SH` (*Pay-to-Script-Hash*) адреси. Адреси P2PKH завжди починаються з `1`, а P2SH - з `3`. Хоча вони досі безпечні, ці формати зараз застарілі, оскільки вони призводять до вищих транзакційних комісій та пропонують меншу конфіденційність порівняно з новими стандартами.
Адреси SegWit V0 (`P2WPKH` та `P2WSH`) та Taproot / SegWit V1 (`P2TR`) представляють сучасні формати. Адреси SegWit починаються з `bc1q`, а адреси Taproot, введені в 2021 році, починаються з `bc1p`.
Наприклад, ось адреса для отримання Taproot:

```text
bc1ps5gd2ys8kllz9alpmcwxqegn7kl3elrpnnlegwkm3xpq2h8da07spxwtf5
```

Спосіб побудови ScriptPubKey залежить від використовуваного стандарту:
| Модель Скрипту | ScriptPubKey                                                || ---------------- | ----------------------------------------------------------- |
| P2PKH           | OP_DUP OP_HASH160 `<pubKeyHash>` OP_EQUALVERIFY OP_CHECKSIG |
| P2SH            | OP_HASH160 `<scriptHash>` OP_EQUAL                          |
| P2WPKH          | 0 `<pubKeyHash>`                                            |
| P2WSH           | 0 `<witnessScriptHash>`                                     |
| P2SH - P2WPKH   | OP_HASH160 `<redeemScriptHash>` OP_EQUAL                    |
| P2SH - P2WSH    | OP_HASH160 `<redeemScriptHash>` OP_EQUAL                    |
| P2TR            | 1 `<pubKey>`                                                |

Що стосується побудови адрес отримання, воно також залежить від обраної моделі скрипту:
- Для адрес `P2PKH` та `P2WPKH`, вантаж, тобто ядро адреси, представляє хеш публічного ключа;
- Для адрес `P2SH` та `P2WSH`, вантаж представляє хеш скрипта;
- Що стосується адрес `P2TR`, вантаж є модифікованим публічним ключем. Виходи `P2TR` поєднують аспекти _Pay-to-PubKey_ та _Pay-to-Script_. Модифікований публічний ключ є результатом додавання класичного публічного ключа витрат з "модифікацією", отриманою з кореня Меркла набору скриптів, які також можуть бути використані для витрати біткойнів.

![BTC204](assets/en/67/01.webp)

Адреси, що відображаються у вашому програмному забезпеченні гаманця, також включають HRP (*Human-Readable Part*), зазвичай `bc` для адрес після SegWit, роздільник `1` та номер версії `q` для SegWit V0 та `p` для Taproot/SegWit V1. Також додається контрольна сума для забезпечення цілісності та валідності адреси під час її передачі.

Нарешті, адреси приводяться до стандартного формату:
- Base58check для старих Legacy адрес;
- Bech32 для адрес SegWit;
- Bech32m для адрес Taproot.

Ось матриця додавання для форматів bech32 та bech32m (SegWit та Taproot) з бази 10:

| +   | 0   | 1   | 2   | 3   | 4   | 5   | 6   | 7   |
| --- | --- | --- | --- | --- | --- | --- | --- | --- |
| 0   | q   | p   | z   | r   | y   | 9   | x   | 8   |
| 8   | g   | f   | 2   | t   | v   | d   | w   | 0   |
| 16  | s   | 3   | j   | n   | 5   | 4   | k   | h   || 24  | c   | e   | 6   | m   | u   | a   | 7   | l   |
### Що таке Повторне Використання Адреси?

Повторне використання адреси відноситься до практики використання однієї та тієї ж адреси для отримання кількох різних UTXO.

Як ми бачили в попередньому розділі, кожен UTXO має свій власний ScriptPubKey, який його блокує і який має бути задоволений, щоб UTXO могло бути використане як вхід у новій транзакції. Саме в цьому ScriptPubKey інтегровані адреси отримувачів (payload).

Коли різні ScriptPubKeys містять одну й ту ж адресу отримувача, це відомо як повторне використання адреси. На практиці це означає, що користувач надав ту саму адресу кілька разів відправникам для отримання біткоїнів через кілька платежів. І справді, ця практика є катастрофічною для вашої конфіденційності.

### Чому Повторне Використання Адреси Є Проблемою?

Враховуючи, що блокчейн є публічним, легко побачити, які адреси блокують які UTXO і скільки біткоїнів. Якщо та сама адреса використовується для кількох транзакцій, стає можливим вивести, що всі біткоїни, асоційовані з цією адресою, належать одній особі. Ця практика компрометує конфіденційність користувача, дозволяючи створювати детерміновані зв'язки між різними транзакціями та відстежувати біткоїни в блокчейні. Сам Сатоші Накамото висвітлив цю проблему в Біткоїн Білому Папері:

> *Як додатковий захисний бар'єр, для кожної транзакції могла б використовуватися нова пара ключів, щоб вони не були пов'язані з загальним власником.*

![BTC204](assets/notext/34/02.webp)

Джерело: С. Накамото, "Bitcoin: A Peer-to-Peer Electronic Cash System", https://bitcoin.org/bitcoin.pdf, 2009.

Метою, яку переслідував Сатоші в цьому твердженні, було створення додаткового захисного бар'єру у випадку асоціації між ідентичністю користувача та парою ключів на Біткоїні, щоб уникнути публічного зв'язку всієї їхньої активності з їхньою ідентичністю. Сьогодні, з розширенням компаній аналізу ланцюгів та регуляцій KYC, використання унікальних адрес стало не "додатковим бар'єром", а необхідною практикою для будь-кого, хто бажає зберегти свою конфіденційність хоча б на мінімальному рівні.

Коли ви повторно використовуєте адресу, ви створюєте майже незаперечний зв'язок між усіма транзакціями, асоційованими з цією адресою. Хоча це не безпосередньо загрожує вашим коштам, оскільки криптографія на еліптичних кривих забезпечує безпеку ваших приватних ключів, це полегшує моніторинг вашої діяльності. Дійсно, будь-хто з вузлом може спостерігати за транзакціями та балансами адрес, повністю компрометуючи вашу анонімність.

![BTC204](assets/en/34/01.webp)
Щоб ілюструвати цю точку зору, візьмемо приклад Боба, користувача, який регулярно купує біткоїни невеликими сумами через DCA (Dollar Cost Averaging) і завжди відправляє їх на ту саму адресу. Після двох років на цій адресі накопичується значна кількість біткоїнів. Якщо Боб використовує цю адресу для здійснення платежу місцевому торговцю, останній може побачити всі асоційовані кошти та вивести багатство Боба. Це може призвести до ризиків для особистої безпеки, включаючи спроби крадіжки або вимагання. Якби Боб використовував нову адресу для отримання кожної періодичної покупки, він би розкрив набагато менше інформації своєму торговцю.

У аналізі ланцюгів ми розрізняємо 2 типи повторного використання адрес:
- Зовнішнє повторне використання;
- Внутрішнє повторне використання в межах транзакції.

Перше спостерігається, коли адреса повторно використовується в кількох різних Біткоїн-транзакціях. Це те, про що ми говорили раніше: ця евристика дозволяє нам вивести, що всі UTXO, які пройшли через цю адресу, належать одній сутності.
Внутрішнє повторне використання адрес спостерігається не тоді, коли воно відбувається між кількома транзакціями, а коли воно відбувається в межах однієї транзакції. Дійсно, якщо та сама адреса, яка була використана для блокування входу, використовується як вихід у транзакції, тоді ми можемо зробити висновок, що цей вихід все ще належить тому самому користувачу (решта), і що другий вихід представляє собою фактичний платіж. Ця інша евристика дозволяє відстежувати кошти через кілька транзакцій.
![BTC204](assets/en/33/02.webp)

Повторне використання адрес є справжнім бичем для Bitcoin. Згідно з веб-сайтом OXT.me (наразі недоступний), загальний рівень повторного використання адрес на Bitcoin становив близько 52% у 2022 році:

![BTC204](assets/notext/41/02.webp)

Цей рівень є величезним, але в основному він походить від платформ обміну, а не від індивідуальних користувачів.

### Як уникнути повторного використання адрес?

Уникнення повторного використання адрес досить просте: **просто використовуйте нову, свіжу адресу для кожного нового вхідного платежу до вашого гаманця**.

Завдяки BIP32, сучасні гаманці тепер є детермінованими та ієрархічними. Це означає, що користувач може генерувати велику кількість адрес з одного початкового шматка інформації: seed. Зберігаючи цю єдину інформацію, можливо відновити всі приватні ключі гаманця, отже, отримати доступ до коштів, захищених відповідними адресами.

![BTC204](assets/notext/41/03.webp)
Саме тому, коли ви натискаєте кнопку "*отримати*" у програмному забезпеченні вашого гаманця, вам кожного разу пропонується не використана адреса для отримання. Після отримання біткойнів на цю адресу, програмне забезпечення автоматично пропонує нову.
> *PS: Нещодавно деяке програмне забезпечення гаманців оголосило про намір припинити генерацію порожніх адрес, побоюючись, що це може бути сприйнято як форма відмивання грошей органами влади. Якщо ваше програмне забезпечення серед них, я настійно раджу вам негайно замінити його, оскільки це неприйнятно для користувача.*

Якщо вам потрібен статичний ідентифікатор для отримання платежів, наприклад, для отримання донатів, то використання класичної Bitcoin адреси не рекомендується через ризик повторного використання. Краще використовуйте Lightning адресу, або для статичного onchain ідентифікатора платежу, ви можете вибрати BIP47 або Silent Payments. Робота цих протоколів детально описана в частині 6 цього навчання.

## Маркування та контроль монет
<chapterId>fbdb07cd-c025-48f2-97b0-bd1bc21c68a8</chapterId>

Як ми виявили в частині про аналіз ланцюга, існує безліч евристик та шаблонів, які можуть бути використані для виведення інформації про транзакцію. Як користувач, важливо бути обізнаним з цими техніками, щоб краще захистити себе.

Це передбачає, зокрема, ретельне управління вашим гаманцем самообслуговування, яке включає знання походження ваших UTXO, а також обдуманий вибір UTXO для споживання під час платежів. Ефективне управління гаманцем ґрунтується на двох важливих функціях хороших Bitcoin гаманців: маркуванні та контролі монет.

У цьому розділі ми вивчимо ці функції та побачимо, як ви могли б розумно їх використовувати, не додаючи занадто багато роботи, щоб значно оптимізувати вашу приватність на Bitcoin.

### Що таке маркування?

Маркування - це практика, яка передбачає присвоєння анотації або мітки конкретному UTXO у гаманці Bitcoin. Ці анотації зберігаються локально програмним забезпеченням гаманця і ніколи не передаються через мережу Bitcoin. Таким чином, маркування є інструментом особистого управління.

Наприклад, якщо я володію UTXO з P2P покупки на Bisq з Чарльзом, я міг би присвоїти йому мітку "`Non-KYC Bisq Charles`".
Маркування є хорошою практикою, яка допомагає пам'ятати про походження або призначене місце використання UTXO, тим самим сприяючи управлінню коштами та оптимізації конфіденційності. Справді, ваш гаманець Bitcoin, ймовірно, забезпечує зберігання кількох UTXO. Якщо джерела цих UTXO різні, ви можете не захотіти об'єднувати ці UTXO в майбутньому, інакше ви могли б розкрити їх спільне володіння. Належне маркування всіх ваших монет забезпечує, що ви пам'ятатимете про їх походження, коли вам потрібно буде їх використати, навіть якщо це буде лише через кілька років.
### Що таке контроль монет?

Активне використання маркування стає ще більш цікавим, коли воно поєднується з опцією контролю монет у програмному забезпеченні вашого гаманця.

Контроль монет - це функція, присутня в хорошому програмному забезпеченні гаманця Bitcoin, яка дає вам можливість вручну вибирати конкретні UTXO для використання як вхідні дані для виконання транзакції. Справді, для задоволення платежу на виході необхідно спожити UTXO на вході у відповідь. З кількох причин, які ми побачимо пізніше, ви можете захотіти точно вибрати, які монети споживати на входах, щоб задовольнити певний платіж. Саме це і дозволяє робити контроль монет. Щоб дати вам аналогію, ця функція схожа на дію вибору конкретної монети у вашому гаманці, коли ви платите за вашу багету.

![BTC204](assets/notext/42/01.webp)

Використання програмного забезпечення гаманця з контролем монет, у поєднанні з маркуванням UTXO, дозволяє користувачам як розрізняти, так і точно вибирати UTXO для своїх транзакцій.

### Як правильно маркувати ваші UTXO?

Не існує універсального методу маркування UTXO, який підходив би всім. Вам належить визначити систему маркування так, щоб ви могли легко орієнтуватися у вашому гаманці. У будь-якому випадку, майте на увазі, що хороше маркування - це таке маркування, яке ви зможете зрозуміти, коли вам це буде потрібно. Якщо ваш Bitcoin гаманець переважно призначений для заощаджень, можливо, що мітки будуть корисні вам лише через кілька десятиліть. Тому переконайтеся, що вони чіткі, точні та всеосяжні.

Важливо, щоб ваші близькі могли легко ідентифікувати походження коштів, якщо одного дня їм потрібно буде отримати доступ до вашого гаманця. Це може допомогти їм з причин конфіденційності, так і для юридичних необхідностей, у випадку, якщо їм доведеться виправдовувати походження коштів перед органом влади.
Найважливішим аспектом маркування є зазначення джерела UTXO. Ви просто повинні вказати, як ця монета потрапила у ваш гаманець. Чи це з покупки на платформі обміну? Платіж від клієнта? Обмін між особами? Або це решта з покупки? Таким чином, ви могли б вказати:
- `Виведення Exchange.com`;
- `Платіж клієнта Давида`;
- `P2P Покупка Чарльза`;
- `Решта з покупки дивана`

![BTC204](assets/en/42/02.webp)

Щоб удосконалити ваше управління UTXO та дотримуватися стратегій сегрегації коштів у вашому гаманці, ви могли б збагатити ваші мітки додатковим індикатором, який відображає ці розділення. Якщо ваш гаманець містить дві категорії UTXO, які ви не бажаєте змішувати, ви могли б інтегрувати маркер у ваші мітки, щоб чітко розрізняти ці групи. Ці маркери розділення будуть залежати від ваших власних критеріїв, таких як розрізнення між UTXO з процесу придбання, який включає KYC, або між професійними та особистими коштами. Взявши до уваги раніше згадані приклади міток, це може бути перекладено як:
- `KYC - Виведення Exchange.com`;
- `KYC - Платіж клієнта Давида`;
- `БЕЗ KYC - P2P Покупка Чарльза`;
- `БЕЗ KYC - Решта з покупки дивана`

![BTC204](assets/en/42/03.webp)
Також рекомендується зберігати маркування монети протягом усіх транзакцій. Наприклад, при консолідації UTXO без KYC, переконайтеся, що ви маркуєте результуючий UTXO не просто як `консолідація`, а конкретно як `консолідація без KYC`, щоб зберегти чіткий слід походження монети.
Нарешті, не обов'язково ставити дату на мітку. Більшість програмного забезпечення для гаманців вже відображає дату транзакції, і завжди можна отримати цю інформацію в блок-експлорері, використовуючи його TXID.

### Як правильно вибрати свої монети?

Коли ви робите транзакцію, контроль монет дозволяє вам специфічно вибрати, які UTXO використовувати як входи для задоволення виходу платежу. При цьому виборі слід враховувати два аспекти:
- Можливість для одержувача платежу пов'язати частину вашої особистості з використаними UTXO як входами;
- Здатність зовнішнього спостерігача встановити зв'язки між усіма використаними UTXO як входами.
Щоб ілюструвати перший пункт, давайте розглянемо конкретний приклад. Припустимо, ви купуєте багет за біткоїни у свого місцевого пекаря. Ви використовуєте один або кілька UTXO, які ви володієте, як входи, щоб хоча б покрити ціну багета виходами, а також комісію за транзакцію. Тоді ваш пекар може потенційно асоціювати ваше обличчя або будь-яку іншу частину вашої особистості, яку він знає, з монетами, використаними як входи. Знаючи про існування цього зв'язку, ви можете віддати перевагу вибору конкретного UTXO перед іншим при здійсненні платежу.
![BTC204](assets/notext/42/04.webp)

Наприклад, якщо один з ваших UTXO походить з платформи обміну, і ви б хотіли, щоб пекар не знав про ваш рахунок на цій платформі, ви б уникнули використання цього UTXO для платежу. Якщо ви володієте UTXO високої вартості, який відкриває значну кількість біткоїнів, ви також можете вирішити не використовувати його, щоб пекар не знав про ваше багатство в BTC.

Вибір UTXO для використання з цього першого пункту, отже, базується на особистому рішенні, яке впливає на те, що ви готові або не готові розкрити. Мітки, які ви призначили своїм UTXO під час їх отримання, допоможуть вам вибрати ті, які, будучи витраченими, викривають лише інформацію, яку ви готові розкрити одержувачу.

Крім інформації, потенційно розкритої одержувачу, вибір входів також впливає на те, що ви розкриваєте всім спостерігачам блокчейна. Дійсно, використовуючи кілька UTXO як входи для вашої транзакції, ви розкриваєте, що вони належать одній і тій же особі, згідно з евристикою спільного володіння входами (CIOH).

![BTC204](assets/notext/42/05.webp)

Вибираючи свої монети, ви повинні бути свідомі, що транзакція, яку ви збираєтеся транслювати, створить зв'язок між усіма використаними UTXO. Цей зв'язок може бути проблематичним для вашої особистої конфіденційності, особливо якщо UTXO походять з різних джерел.

![BTC204](assets/notext/42/06.webp)

Повернімося до прикладу мого UTXO без KYC з Bisq; я хочу уникнути його комбінування з UTXO з, скажімо, регульованої платформи обміну, яка знає мою особистість. Дійсно, якщо я коли-небудь використаю ці 2 UTXO як входи в одній транзакції, регульована платформа зможе пов'язати мою особистість з UTXO, який я купив на Bisq, хоча до цього він не був пов'язаний з моєю особистістю.

![BTC204](assets/notext/42/07.webp)
Нарешті, щоб правильно вибрати, які UTXO використовувати як входи для транзакції, найважливіше - уникати використання кількох UTXO. Коли це можливо, вибирайте одну монету, яка достатньо велика, щоб покрити ваш платіж. Роблячи це, ви повністю уникаєте ризиків, пов'язаних з COINJOIN. Однак, якщо жоден окремий UTXO не достатній для платежу і вам потрібно використати кілька, переконайтеся, що вони походять з подібних джерел, щоб мінімізувати ризики небажаних зв'язків. Також майте на увазі, що одержувач може асоціювати інформацію, яку він має про вас, з історією монет, використаних як входи.
### Розуміння автоматичного вибору монет

У попередніх розділах ми обговорювали ручний вибір UTXO для транзакції. Але що відбувається, коли програмне забезпечення гаманця робить цей вибір автоматично? Існує кілька методів для визначення, які монети використовувати, і вибір UTXO є справжньою областю досліджень у Bitcoin. Основна мета цього автоматичного процесу часто полягає в мінімізації комісій за транзакції для користувача.

Методи вибору UTXO, такі як FIFO (*Перший прийшов - перший пішов*) і LIFO (*Останній прийшов - перший пішов*), є серед найпростіших, але також і найменш ефективних. З FIFO, спочатку використовуються найстаріші монети у гаманці. Цей підхід, як правило, неефективний як для мінімізації комісій за транзакції, так і для збереження приватності, крім випадків, коли використовуються відносні часові блокування, які потрібно регулярно оновлювати. Навпаки, LIFO віддає перевагу використанню найновіших UTXO. Хоча прості, ці два методи часто виявляються неефективними.

Більш передовим методом є *Розв'язувач рюкзака*. Це був метод, який використовувався у гаманці Bitcoin Core до версії 0.17. Він передбачає ітеративний і випадковий вибір UTXO з гаманця, їх сумування у підмножини та збереження рішення, яке зменшує вагу транзакції якомога більше, щоб зменшити комісії для користувача.
*Branch-and-Bound* (BNB), часто називаний "алгоритмом Мерча" на честь його винахідника, замінив *Розв'язувач рюкзака* у Bitcoin Core, починаючи з версії 0.17. Цей більш передовий метод прагне знайти набір UTXO, який точно відповідає необхідній сумі для задоволення виходів транзакції. Мета BNB полягає в мінімізації суми решти, а також комісій, шляхом зменшення так званого критерію відходів, який враховує як негайні витрати, так і майбутні витрати, очікувані для решти. Цей метод походить від оригінальної концепції *Branch-and-Bound*, розробленої в 1960 році Айлсою Ленд та Елісон Харкорт, і пропонує більш точну оптимізацію комісій порівняно з *Розв'язувачем рюкзака*.
Всі ці методи автоматичного вибору UTXO можуть бути ефективними для зменшення комісій за транзакції, але вони часто неефективні у збереженні приватності користувача. Дійсно, ці алгоритми можуть об'єднувати кілька UTXO у входи, таким чином розкриваючи спільне володіння цими UTXO через COH. Очевидно, ці методи не можуть враховувати мітки, прикріплені до UTXO, які є вирішальними для свідомого вибору монет, які потрібно розкрити одержувачу транзакції. Наразі єдиною можливістю оптимізувати приватність при виборі монет є робити це вручну.

### Посібник з маркування UTXO

Якщо ви хочете дізнатися, як маркувати свої UTXO, ми створили повний посібник з основного існуючого програмного забезпечення Bitcoin гаманця:

https://planb.network/tutorials/privacy/utxo-labelling


## KYC та ключова ідентифікація
<chapterId>cec6b9d9-0eed-4f85-bc4e-1e9aa59ca605</chapterId>
KYC означає "Know Your Customer" (Знай свого клієнта), що є регуляторною процедурою, впровадженою деякими компаніями, що працюють у секторі Bitcoin. Ця процедура має на меті верифікацію та запис ідентичності їхніх клієнтів з оголошеною метою боротьби з відмиванням грошей та фінансуванням тероризму.
Конкретно, KYC передбачає збір різноманітних особистих даних від клієнта, які можуть варіюватися залежно від юрисдикції, але загалом включають документ ідентифікації, фотографію та доказ місця проживання. Ця інформація потім перевіряється та зберігається для майбутнього використання.

Ця процедура стала обов'язковою для всіх регульованих платформ обміну у більшості західних країн. Це означає, що будь-хто, хто бажає обміняти фіатні валюти на біткоїни через ці платформи, повинен відповідати вимогам KYC.
Ця процедура несе в собі ризики для конфіденційності та безпеки користувачів. У цьому розділі ми детально розглянемо ці ризики та проаналізуємо специфічні впливи KYC та процесів ідентифікації на приватність користувачів Bitcoin.
### Сприяння відстеженню на ланцюгу

Перший ризик, пов'язаний з KYC, полягає в тому, що він надає привілейований вхідний пункт для аналізу ланцюгів. Як ми бачили у попередній частині, аналітики можуть групувати та відстежувати активності на блокчейні, використовуючи шаблони транзакцій та евристики. Як тільки вони змогли згрупувати активність користувача на ланцюгу, знаходження лише одного вхідного пункту серед усіх їхніх транзакцій та ключів достатньо, щоб повністю скомпрометувати їхню приватність.

![BTC204](assets/notext/43/1.webp)

Коли ви проходите KYC, ви надаєте дуже якісний вхідний пункт для аналізу ланцюгів, оскільки ви пов'язуєте свої адреси отримання, використовувані при виведенні ваших біткоїнів з платформи обміну, з вашою повною та верифікованою ідентичністю. Теоретично, ця інформація відома лише компанії, якій ви її надали, але, як ми побачимо пізніше, ризик витоку даних є реальним. Більше того, сам факт, що компанія володіє цією інформацією, може бути проблематичним, навіть якщо вона не ділиться нею.

Таким чином, якщо ви не вживете інших заходів для обмеження групування ваших активностей на блокчейні, будь-хто, хто знає про цей вхідний пункт, що є KYC, потенційно може пов'язати всю вашу активність на Bitcoin з вашою ідентичністю. З точки зору цієї компанії, ваше використання Bitcoin тому втрачає всю конфіденційність.

![BTC204](assets/notext/43/2.webp)

Щоб ілюструвати це порівнянням, це як якби ваш банкір з *Банку X* мав доступ не тільки до всіх ваших транзакцій, здійснених з *Банком X*, але також міг спостерігати за вашими транзакціями з *Банком Y* та всіма вашими готівковими транзакціями.

Пам'ятайте з першої частини цього навчання: модель приватності Bitcoin, як було задумано Сатоші Накамото, ґрунтується на розділенні між ідентичністю користувача та їхніми парами ключів. Хоча цей шар приватності сьогодні вже не є достатнім, все ж розумно обмежувати його деградацію наскільки це можливо.

### Виставлення державному спостереженню

Друга велика проблема з KYC полягає в тому, що вона розкриває державі, що ви колись володіли біткоїнами. Коли ви купуєте біткоїни через регульованого актора, стає можливим для держави дізнатися про це володіння. Наразі це може здатися незначним, але важливо пам'ятати, що політичне та економічне майбутнє вашої країни не в ваших руках.
Перш за все, держава може швидко прийняти авторитарну позицію. Історія повна прикладів, коли політики різко змінювалися. Сьогодні, в Європі, ентузіасти Bitcoin можуть писати статті про Bitcoin, брати участь у конференціях та керувати своїми гаманцями в самоопіці. Але хто може сказати, що буде завтра? Якщо Bitcoin раптом стане громадським ворогом номер один, асоціація з ним у державних записах може виявитися проблематичною.
Далі, у випадку серйозних економічних криз, держава може розглянути можливість конфіскації біткойнів, які належать громадянам. Можливо, завтра біткойнерів буде розглядати як тих, хто заробляє на кризі, і вони будуть піддані надмірному оподаткуванню через свої капітальні прибутки на тлі знецінення фіатних валют.
Ви можете подумати, що це не проблема, тому що ваші біткойни змішані і тому невідстежувані. Однак, проблема не в відстеженні. Справжня проблема в тому, що держава знає, що ви володіли біткойном. Ця проста інформація може бути достатньою, щоб вас звинуватити або вимагати звіту. Ви можете спробувати стверджувати, що витратили свої біткойни, але це має бути відображено у вашій податковій декларації, і вас можуть викрити. Ви також можете сказати, що втратили свої ключі під час катастрофи на човні, але, крім жарту на Twitter, чи справді ви думаєте, що цього буде достатньо для вашого виправдання?

Тому важливо враховувати ризик, пов'язаний з простим фактом, що держава може знати, що ви володіли BTC, навіть якщо цей ризик може здатися віддаленим сьогодні.

Інша проблема, яку становить KYC з точки зору державного нагляду, - це обов'язкове повідомлення регульованими платформами. Хоча я не знайомий з регуляціями в інших юрисдикціях, у Франції *Провайдери Послуг Цифрових Активів* (PSAN) зобов'язані повідомляти фінансовим органам нагляду про будь-які рухи коштів, які вони вважають підозрілими.

Таким чином, у Франції у 2023 році PSANs повідомили про 1,449 підозрілих дій. Наразі більшість цих дій пов'язані з кримінальністю. Однак, органи також просять регульовані платформи повідомляти про будь-яку підозрілу транзакцію з біткойнами, виходячи лише з її структури. Якщо ви виконуєте спільну транзакцію, або навіть просто транзакцію, яка представляє дещо нетиповий шаблон, і ця транзакція відбувається незабаром після виведення ваших біткойнів з цих платформ, ви можете опинитися в звіті до органів. Навіть за відсутності правопорушення та при законному здійсненні ваших прав, це повідомлення може призвести до посилення перевірок і нагляду, незручностей, яких ви могли б уникнути без KYC.

### Ризик витоку особистих даних
Інша проблема з KYC полягає в тому, що вона вимагає зберігання всіх ваших особистих даних на серверах приватної компанії. Нещодавні події нагадали нам, що ніхто не застрахований від збоїв, чи то фінансових, чи пов'язаних з ІТ. У 2022 році клієнти Celsius зазнали наслідків. Після банкрутства компанії імена кредиторів та сума їх активів були оприлюднені американською юстицією під час адміністративної процедури.

Трохи більше двох років тому провідна кібербезпекова сутність у сфері криптовалют зазнала крадіжки особистих даних своїх клієнтів. Хоча цей інцидент не був прямо пов'язаний з покупкою біткойнів, такий ризик також залишається для платформ обміну. Тому існує визначений ризик, пов'язаний з цими особистими даними.

Це правда, що ми вже довіряємо багато наших особистих даних приватним компаніям. Однак, ризик тут є двояким, оскільки ці дані не тільки дозволяють вас ідентифікувати, але також пов'язані з діяльністю на Bitcoin. Дійсно, коли хакер вдається отримати доступ до даних клієнтів платформи обміну, вони можуть розумно припустити, що ці клієнти володіють біткойнами. Таким чином, цей ризик посилюється тим фактом, що біткойн, як і будь-який інший цінний актив, привертає увагу злодіїв.

У випадку витоку даних, у кращому випадку, ви можете стати мішенню цілеспрямованих спроб фішингу. У гіршому випадку, ви можете опинитися в центрі фізичних загроз вашому дому.
Окрім специфічних ризиків, пов'язаних з Bitcoin, також необхідно враховувати небезпеки, асоційовані з передачею документів, що засвідчують особу. Дійсно, у випадку витоку даних, можливо стати жертвою крадіжки особистості. Таким чином, ставки не обмежуються лише захистом конфіденційності транзакцій, але також стосуються особистої безпеки кожної особи.

### Поширені помилкові уявлення про KYC

Важливо спростувати деякі поширені помилкові уявлення про KYC, які часто зустрічаються на Twitter або в наших дискусіях серед прихильників біткойна.
Перш за все, неправильно думати, що захист своєї приватності для біткойнів, отриманих через KYC (Know Your Customer - Знай свого клієнта), є марним. Інструменти та методи для приватності на Bitcoin різноманітні та служать різним цілям. Наприклад, використання транзакцій coinjoin на біткойнах з KYC не є поганою ідеєю. Звичайно, необхідно бути обережним з регульованими платформами обміну, щоб уникнути заморожування або блокування свого рахунку, але з чисто технічної точки зору, ці практики не є несумісними. Coinjoin має ефект розриву історії монети, що допомагає вам протистояти деяким ризикам аналізу ланцюга, пов'язаним з KYC. Хоча це не усуває всі ризики, воно вже представляє значну перевагу.
![BTC204](assets/notext/43/3.webp)

Приватність на Bitcoin не слід розглядати бінарно, як розрізнення між "анонімними" біткойнами та іншими, які не є такими. Володіння біткойнами, отриманими через KYC, не означає, що все втрачено; навпаки, використання інструментів приватності може виявитися ще більш корисним.

Навпаки, придбання біткойна через метод без KYC не гарантує ідеальної приватності та не звільняє вас від необхідності вживати інші захисні заходи. Якщо ви тримаєте біткойн без KYC, але використовуєте одні й ті ж адреси для отримання кілька разів, ваші транзакції можуть бути відстежені та згруповані. Найменший зв'язок зі світом поза Bitcoin може скомпрометувати єдиний шар приватності, який у вас був. Тому важливо розглядати всі інструменти та методи, які покращують приватність на Bitcoin, як доповнюючі. Кожна техніка адресує певний ризик і може додати додатковий шар захисту. Таким чином, володіння біткойном без KYC абсолютно не звільняє вас від необхідності вживати інші заходи обережності.

### Чи можна відмінити KYC?

Іноді мене питають, чи можливо "повернутися назад" після завершення KYC, і, як ви можете уявити з попередніх абзаців, відповідь нюансована. Щоб уникнути ризиків, пов'язаних з KYC, найпростіший метод - не використовувати його при придбанні біткойнів. Ми глибше зануримося в цю тему в наступному розділі. Однак, якщо KYC вже було проведено і біткойни були придбані, чи існують способи зменшити наявні ризики?

Що стосується ризику відстежуваності ваших транзакцій, використання coinjoin є рішенням. Ми обговоримо цей метод детальніше пізніше в навчанні, але будьте в курсі, що coinjoin може розірвати історію монети та запобігти її відстеженню від минулого до теперішнього і з теперішнього в минуле. Навіть для BTC, отриманих через регульовану платформу, ця техніка може запобігти їх відстежуваності.
Проте, coinjoin не усуває другий ризик, пов'язаний з KYC: факт того, що держава обізнана про ваші володіння біткоїнами. Дійсно, навіть якщо ваші монети більше не можна відстежити, держава, залежно від юрисдикції, може мати доступ до ваших декларацій про відчуження криптоактивів. Оскільки цей ризик не технічний, а адміністративний, не існує специфічних для Bitcoin рішень для його усунення, крім як не піддаватися KYC спочатку. Єдиний законний спосіб зменшити цей ризик - продати ваші біткоїни, отримані через регульовані платформи, на регульованих платформах, а потім знову придбати їх засобами без KYC. Продаючи та декларуючи відчуження, адміністрація повинна взяти до відома, що ви більше їх не володієте.
Що стосується ризику витоку ваших особистих даних та документів, що посвідчують особу, це небезпека, зовнішня по відношенню до Bitcoin, і не існує технічного рішення, щоб уникнути її. Як тільки ваші дані стають відомими, важко скасувати цю операцію. Ви можете спробувати закрити свій рахунок на платформі, але це не гарантує видалення ваших даних KYC, особливо коли верифікація особи здійснюється сторонніми організаціями. Перевірити повне видалення вашої інформації неможливо. Тому не існує рішення, щоб повністю запобігти цьому ризику та гарантувати, що він більше не існує.

### Різниця між KYC та ключовою ідентифікацією

Іноді деякі біткоїнери схильні розширювати термін "KYC" на будь-який обмін BTC, що включає переказ або платіж кредитною карткою, оскільки ці засоби також можуть розкрити походження платежу, як і KYC. Однак важливо не плутати KYC з ключовою ідентифікацією. Особисто я мушу визнати, що моє сприйняття цього питання з часом еволюціонувало.

KYC конкретно відноситься до регуляторної процедури, яку деякі компанії впроваджують для перевірки та запису ідентичності своїх клієнтів. Це бінарне поняття: придбаючи ваші біткоїни, ви або проходите KYC, або ні. Однак ключова ідентифікація, яка стосується зв'язування аспекту ідентичності користувача з ончейн активністю, не є такою бінарною, а скоріше представляє континуум. Дійсно, в контексті придбання або відчуження біткоїнів, ця ідентифікація завжди можлива до різних ступенів.
Наприклад, якщо ви купуєте біткоїни на регульованій платформі у Швейцарії, KYC (Know Your Customer) не потрібен. Однак, можлива ідентифікація ваших ключів, оскільки покупка була здійснена через ваш банківський рахунок. Ось де перші два ризики, пов'язані з KYC — сприяння відстеженню ончейн та виставлення державному нагляду — також можуть проявитися в обміні без KYC. Якщо швейцарська установа повідомляє про підозрілі транзакції владі вашої країни, вони можуть просто перевірити банківський рахунок, використаний для покупки, щоб виявити вашу особу. Таким чином, купівля без KYC на регульованих платформах є досить високою на шкалі ризику для ключової ідентифікації.

Проте, уникнення регульованих платформ та вибір методів придбання P2P (Peer-to-Peer) не повністю усуває ризик ключової ідентифікації, а лише зменшує його. Розглянемо приклад покупки на Bisq або іншій P2P платформі. Для розрахунку з вашим контрагентом, ймовірно, ви використаєте свій банківський рахунок. Якщо влада запитає у людини, з якою ви торгували, ваше ім'я, ми стикаємося з ризиками 1 і 2, згаданими раніше. Ці ризики, безумовно, набагато нижчі, ніж під час покупки без KYC на платформі, і ще більше знижені, ніж під час покупки з KYC, але вони все ще присутні в меншій мірі.
Нарешті, навіть якщо ви придбали свої біткойни через фізичний обмін готівкою, ви не залишаєтесь повністю анонімним. Особа, з якою ви торгували, бачила ваше обличчя, що є частиною вашої ідентичності. Хоча в цьому прикладі це мінімально, все ж існує можливість ключової ідентифікації.
![BTC204](assets/notext/43/6.webp)

Підсумовуючи, під час обміну біткойнів на інші активи, чи то покупка за фіатну валюту, чи продаж за реальний товар, завжди існує певна форма ключової ідентифікації. Залежно від обраного методу обміну, ця ідентифікація може варіюватися за інтенсивністю. Важливо не плутати цю ідентифікацію з KYC, який є добре визначеним регуляторним процесом. Однак, існує зв'язок між KYC та спектром ідентифікації, оскільки KYC знаходиться на верхньому кінці цього спектру, оскільки він систематично сприяє ідентифікації ключів користувача органами влади.

## Методи продажу та придбання
<chapterId>756598af-95aa-4c77-ac48-243c7ad89530</chapterId>
Прочитавши попередній розділ, ви, можливо, замислилися про способи купівлі або продажу біткойнів без необхідності проходження процесу верифікації особи, щоб уникнути ризиків, пов'язаних з KYC. Існує кілька методів проведення обмінів.

### Готівкові P2P обміни

Як ми вже бачили, найкращим методом з точки зору конфіденційності залишається P2P (один до одного) обмін з готівковим розрахунком. Цей метод дозволяє мінімізувати залишені сліди та значно зменшити можливість ключової ідентифікації, незалежно від того, чи є ви покупцем чи продавцем.

![BTC204](assets/notext/44/01.webp)

Однак, ця практика несе ризики для особистої безпеки. Основна небезпека полягає в тому, що під час обміну контрагент дізнається, що ви маєте значну суму, будь то готівкою або в біткойнах. Ця інформація може привернути увагу зловмисників. Загалом рекомендується зберігати в таємниці своє володіння біткойнами. Ця порада може бути застосована і до готівки. Однак, під час особистого обміну неминуче доведеться розкрити, що ви володієте біткойнами, що може викликати заздрість.

![BTC204](assets/notext/44/02.webp)

Щоб обмежити цей ризик, я раджу вам віддавати перевагу готівковим транзакціям з надійними особами, такими як члени сім'ї або близькі друзі. Як альтернативу, ви також можете розглянути можливість проведення обмінів на [місцевих зустрічах Bitcoin](https://btcmap.org/communities/map), після кількох відвідувань. Це дозволить вам краще познайомитися з іншими учасниками та не бути наодинці під час фізичного обміну. Однак, важливо визнати, що готівковий P2P обмін сам по собі несе ризики для вашої особистої безпеки, яких не існує при здійсненні покупок через регульовану платформу та ваш банківський рахунок.

Більше того, залежно від місця, де ви живете, носіння та зберігання великих сум грошей може становити ризики, чи то для біткойнів, чи для готівки.

Готівковий обмін також може нести юридичні ризики під час перевірок поліції чи інших. Хоча в більшості країн не існує обмежень на суму готівки, яку ви можете носити при собі, занадто великі суми можуть викликати підозри. Тому будьте обережні, особливо якщо вам доводиться подорожувати на далекі відстані, та уникайте здійснення занадто великих транзакцій за один раз, щоб не доводилося виправдовувати володіння значними сумами.
Нарешті, ще одним недоліком покупок P2P є те, що ціна часто вища, ніж та, що спостерігається на регульованих платформах. Продавці часто накладають націнку від 1% до іноді більше ніж 10%. Кілька причин пояснюють цю різницю в ціні. По-перше, це загальноприйнята практика серед продавців P2P, яка встановилася з часом. Далі, у продавців є комісійні збори, пов'язані з відправленням коштів покупцю. Також існує підвищений ризик крадіжки в P2P продажах порівняно з транзакціями на платформах, що виправдовує компенсацію за взятий на себе ризик. Нарешті, націнка може бути пов'язана з попитом та якістю обміну з точки зору конфіденційності. Як покупець, здобуток у конфіденційності має ціну, яка відображається в націнці, застосованій продавцем. Деякі біткойнери також вважають, що підвищена ціна BTC, купленого в P2P, відображає його справжню вартість, і стверджують, що нижчі ціни на регульованих платформах є результатом компромісу щодо конфіденційності ваших особистих даних.

### Обміни P2P через платформу для збігів

Менш ризикованою альтернативою з точки зору особистої безпеки є проведення обмінів P2P виключно онлайн, за допомогою електронних платіжних методів, таких як PayPal, банківські перекази або Revolut.

Цей підхід допомагає уникнути багатьох ризиків, пов'язаних з готівковими транзакціями. Однак, ризик того, що контрагент не виконає свої зобов'язання під час онлайн-обміну, є більшим. Дійсно, під час фізичного обміну, якщо ви передаєте гроші продавцю, який не надсилає вам біткойни у відповідь, ви можете негайно притягнути його до відповідальності, оскільки він перед вами. Онлайн, з іншого боку, часто неможливо знайти людину, яка вкрала у вас.

Щоб зменшити цей ризик, можна використовувати платформи, спеціалізовані на збігах для P2P обмінів. Ці платформи використовують механізми вирішення конфліктів для захисту постраждалих користувачів. Загалом, вони пропонують систему ескроу, де біткойни утримуються до підтвердження продавцем платежу в фіатній валюті.

З точки зору особистої безпеки, цей метод покупки значно безпечніший, ніж фізичні готівкові обміни. Однак, як зазначалося раніше, онлайн P2P обміни залишають більше слідів, ніж фізичний обмін, що може бути шкідливим для конфіденційності в Bitcoin. Використовуючи онлайн метод платежу в фіатній валюті, такий як банк, ви розкриваєте більше інформації, яка може сприяти ідентифікації ключів.

Ще раз рекомендую не проводити великі обміни в одній транзакції на цих платформах. Розділяючи свої транзакції, ви розподіляєте ризики, пов'язані з потенційною крадіжкою з боку контрагента.
Ще одним недоліком покупок через P2P є те, що ціна часто вища, ніж на регульованих платформах. Продавці часто накладають націнку від 1% до іноді більше ніж 10%. Існує кілька причин, які пояснюють цю різницю в цінах. По-перше, це загальноприйнята практика серед продавців P2P, яка була встановлена з часом. Далі, у продавців є комісійні збори, пов'язані з відправленням коштів покупцеві. Також існує підвищений ризик крадіжки у продажах через P2P порівняно з транзакціями на платформах, що виправдовує компенсацію за взятий на себе ризик. Нарешті, націнка може бути пов'язана з попитом та якістю обміну з точки зору конфіденційності. Як покупець, збільшення конфіденційності має ціну, яка відображається у націнці, застосованій продавцем. Деякі біткойнери також вважають, що підвищена ціна BTC, купленого через P2P, відображає його справжню вартість, і стверджують, що нижчі ціни на регульованих платформах є результатом компромісу щодо конфіденційності ваших особистих даних.

Що стосується рішень, я особисто завжди користувався [Bisq](https://bisq.network/) і дуже задоволений цим. Їхня система добре налагоджена і здається надійною. Однак, Bisq доступний лише на ПК, і його інтерфейс може бути занадто складним для початківців. Ще одним недоліком є те, що Bisq працює виключно з onchain транзакціями, що може стати дороговартісним під час періодів високих комісій за транзакції в Bitcoin.

[-> Дізнайтеся про наш підручник по Bisq.](https://planb.network/en/tutorials/exchange/bisq)

Для простішого варіанту ви можете спробувати [Peach](https://peachbitcoin.com/), мобільний додаток, який полегшує з'єднання між покупцями та продавцями з інтегрованою системою вирішення спорів. Процес більш інтуїтивний, ніж у Bisq.

[-> Дізнайтеся про наш підручник по Peach.](https://planb.network/en/tutorials/exchange/peach-wallet)
Інший онлайн-варіант - [HodlHodl](https://hodlhodl.com/), добре встановлена платформа, яка пропонує хорошу ліквідність, хоча я особисто не тестував її.
[-> Дізнайтеся про наш підручник по HodlHodl.](https://planb.network/en/tutorials/exchange/hodlhodl)

Для рішень, заснованих на Lightning Network, ви можете спробувати [RoboSats](https://learn.robosats.com/) та [LNP2PBot](https://lnp2pbot.com/). RoboSats доступний через вебсайт і є відносно простим у використанні. LNP2PBot більш нетиповий, оскільки працює через систему обміну в месенджері Telegram.

[-> Дізнайтеся про наш підручник по RoboSats.](https://planb.network/en/tutorials/exchange/robosats)
[-> Дізнайтеся про наш підручник по LNP2PBot.](https://planb.network/en/tutorials/exchange/lnp2pbot)

### Регульовані платформи без KYC

Залежно від країни, в якій ви живете, у вас може бути доступ до регульованих платформ, які не вимагають процедури KYC для купівлі або продажу біткойнів. Наприклад, у Швейцарії ви можете використовувати платформи, такі як [Relai](https://relai.app/) та [MtPelerin](https://www.mtpelerin.com/).

[-> Дізнайтеся про наш підручник по Relai.](https://planb.network/en/tutorials/exchange/relai)
Як ми бачили в попередньому розділі, цей тип платформи звільняє вас від ризиків, пов'язаних з процедурами KYC, але вони представляють вищий рівень ризику для ключової ідентифікації. З точки зору конфіденційності в Bitcoin, ці платформи, отже, пропонують кращий захист, ніж методи купівлі з KYC, але вони менш цікаві, ніж P2P обміни.

Однак, з точки зору особистої безпеки, використання цих платформ значно менш ризиковане, ніж P2P обміни. Вони також часто простіші у використанні, ніж платформи, які сприяють P2P обмінам.

### Банкомати

Іншим варіантом купівлі або продажу біткойнів без KYC є криптовалютні банкомати (ATM). Особисто я ніколи не мав можливості протестувати це рішення, оскільки в моїй країні їх немає. Але цей метод може бути дуже цікавим залежно від того, де ви живете.

![BTC204](assets/notext/44/09.webp)
Проблема з банкоматами полягає в тому, що в деяких країнах вони заборонені або суворо регулюються. Якщо банкомат вимагає процесу верифікації особи, то він стикається з тими ж ризиками, що й регульовані платформи KYC. Однак, якщо банкомат дозволяє транзакції без верифікації особи на невеликі суми, то його використання може пропонувати рівень конфіденційності, порівнянний з тим, що пропонує готівковий P2P обмін, уникаючи більшості ризиків, пов'язаних з цим типом обміну.
Основним недоліком банкоматів є їх часто високі комісії за обмін, які варіюються від кількох відсотків до іноді 15% від обміненої суми.

### Подарункові картки

Нарешті, я також хотів представити рішення, яке добре працює для тих, хто хоче використовувати свої біткойни щодня для покупок, а не продавати їх за фіатні валюти.

Найкращий спосіб витратити BTC, звичайно, використовувати Bitcoin безпосередньо або Lightning Network для купівлі товарів або послуг. Однак, у багатьох країнах кількість торговців, які приймають біткойни, залишається обмеженою. Практичною альтернативою тоді є використання подарункових карток.

Декілька платформ, які не вимагають процедури KYC, пропонують можливість обміну біткойнів на подарункові картки, які можна використовувати у великих магазинах. Серед цих платформ ми знаходимо [CoinsBee](https://www.coinsbee.com/), [The Bitcoin Company](https://thebitcoincompany.com/), та [Bitrefill](https://www.bitrefill.com/). Ці платформи значно полегшують щоденне використання ваших біткойнів, дозволяючи вам отримати доступ до широкого спектру товарів та послуг без необхідності конвертації в фіатну валюту.

![BTC204](assets/notext/44/10.webp)

### Інші методи придбання

Серед інших методів придбання біткойнів, зберігаючи вашу конфіденційність, очевидно, є майнінг. Для початку майнінгу сатоші необхідно розкрити вашу особу; вам просто потрібно знайти дійсний доказ роботи та надіслати його в мережу. Якщо ви вибираєте майнінг у пулі, деякі пули вимагають форму ідентифікації, таку як KYC, тоді як інші - ні.

Інший метод полягає в роботі в обмін на біткойни. Цей метод придбання може бути цікавим, але ступінь необхідної ідентифікації значно варіюється залежно від обставин.

*Для написання цього розділу я використовував курс [BTC205](https://planb.network/fr/courses/btc205), створений [@pivi___](https://x.com/pivi___) на PlanB Network (наразі доступний тільки французькою).*

## Консолідація, Управління UTXO та CIOH
<chapterId>d0486c8f-332d-402b-ae2e-949416752b9c</chapterId>
Одним з найскладніших аспектів управління, коли у вас є власний гаманець самоопіки, безсумнівно, є консолідація. Чи слід вам консолідувати? Для чого це? Який розмір UTXO вам слід прагнути? Які компроміси з точки зору приватності? Саме це ми спробуємо дослідити в цьому розділі.

### Що таке консолідація?

Робота Bitcoin схожа на аукціонний ринок, де транзакції, що пропонують найкращі комісії, віддають перевагу майнерами. Однак, кожен блок має максимальну вагу, що обмежує кількість транзакцій, які можуть бути включені. Оскільки блок створюється в середньому кожні 10 хвилин, доступний простір у кожному блоку є рідкісним ресурсом.

Майнери, чия діяльність пов'язана зі значними витратами на електроенергію, капітал та обслуговування, природно прагнуть максимізувати свою прибутковість. Вони схильні віддавати перевагу транзакціям, які пропонують їм найбільші комісії відносно їх ваги.

Дійсно, не всі транзакції Bitcoin мають однакову вагу. Ті, що мають більше входів та виходів, будуть мати більшу вагу. Наприклад, розглянемо 2 транзакції:
- Транзакція A включає 1 вхід та 1 вихід. Вона виділяє 1,994 сатоші комісії та має вагу 141 vB;
- Транзакція B, більш складна, з 2 входами та 2 виходами, виділяє 2,640 сатоші комісії за вагу 220 vB.

![BTC204](assets/notext/45/01.webp)

У цьому прикладі, хоча транзакція B пропонує загальну більшу кількість комісій, майнери віддадуть перевагу транзакції A, оскільки вона пропонує краще співвідношення між комісіями та вагою. Ось розрахунок для кожної транзакції, виражений у сатоші за віртуальний байт (sat/vB):

```text
TXA: 1994 / 141 = 14 sat/vB

TXB: 2640 / 220 = 12 sat / vB
```

Це означає, що за кожну одиницю ваги транзакція A пропонує більше комісій, ніж транзакція B, навіть якщо остання пропонує більше комісій у абсолютному значенні.

![BTC204](assets/notext/45/02.webp)

Тому завжди цікавіше для користувача витрачати якомога менше входів у своїх транзакціях. Однак, необхідно витрачати достатньо сум, щоб змогти задовольнити платіж на виході. Управляючи своїм гаманцем, один має мати достатньо великі UTXO.

Принцип консолідації полягає саме в тому, щоб скористатися періодами, коли комісії в Bitcoin низькі, для об'єднання своїх маленьких UTXO в один великий. Таким чином, коли комісії на Bitcoin зростають, можна здійснювати транзакції з мінімумом входів, і тому витрачати менше в абсолютних комісіях. Мета полягає в плануванні обов'язкових транзакцій, які мають бути здійснені під час періодів високих комісій.

![BTC204](assets/en/45/03.webp)
Крім економії на комісіях за транзакції, консолідація UTXO допомагає уникнути створення "пилу". Пилом називають UTXO, чия вартість у сатоші настільки низька, що її не вистачає для покриття необхідних комісій за транзакцію для їх витрати. Це робить ці UTXO економічно нераціональними для використання, доки комісії за транзакції залишаються високими. Проактивно групуючи свої UTXO, ви запобігаєте їх перетворенню на пил, забезпечуючи, що всі ваші кошти залишаються придатними до використання.

### Який мінімальний розмір для ваших UTXO?

Іноді мене питають, яке рекомендоване мінімальне значення для UTXO. На жаль, універсальної відповіді немає, оскільки це залежить від ваших переваг та ринкових умов комісій. Однак, ось формула, яка може допомогти вам визначити поріг, що відповідає вашим потребам:

$$
\frac {P \times F}T = M
$$

Де:
- $P$ є вагою транзакції;
- $F$ представляє максимальну ставку комісії в сатоші за вбайт (sats/vB), яку ви готові покрити;
- $T$ це відсоток комісії за транзакцію, яку ви готові заплатити відносно загальної вартості UTXO;
- $M$ це мінімальна сума в сатоші для кожного UTXO.

Припустимо, ви плануєте покрити комісії за стандартну SegWit транзакцію з 1 входом і 2 виходами, вагою 141 vB. Якщо ви готові покрити до 800 sats/vB, і готові витратити до 12% вартості UTXO на комісії максимум, тоді розрахунок буде:

$$
\frac{141 \times 800}{0.12} = 940\ 000
$$

У цьому прикладі буде розумно підтримувати мінімальну вартість 940,000 сатоші для UTXO у вашому гаманці.

### Консолідація та COIH

Одна з найбільш використовуваних евристик у аналізі ланцюгів - це COIH (*Common Input Ownership Heuristic*), яка дозволяє припустити, що всі входи біткойн-транзакції належать одній особі. Зокрема, принцип консолідації полягає в споживанні кількох UTXO як входів і створенні одного UTXO як виходу. Таким чином, консолідація дозволяє застосувати COIH.

![BTC204](assets/notext/45/04.webp)

На практиці це означає, що зовнішній спостерігач може зробити висновок, що всі консолідовані UTXO, ймовірно, належать одній особі, і що один вихід, який був створений, також належить їм. Ця ситуація може порушити вашу конфіденційність, зв'язавши різні історії транзакцій. Наприклад, скажімо, я консолідую 3 UTXO, отримані в P2P, з UTXO, отриманим через платформу, яка вимагає KYC:
![BTC204](assets/notext/45/05.webp)

Роблячи це, будь-яка організація з доступом до даних платформи обміну, включаючи потенційно державні агентства, може ідентифікувати, що я володію іншими сумами в BTC. Раніше ці UTXO не були безпосередньо пов'язані з моєю особою; тепер вони є. Більше того, це розкриває всім джерелам, що я володію певною кількістю біткойнів.

Управління UTXO включає економічні міркування, які спонукають до консолідації для зниження комісій, що суперечить хорошим практикам конфіденційності, які б рекомендували ніколи не об'єднувати ваші UTXO. Таким чином, вибір між економією та конфіденційністю залежить від пріоритетів кожного користувача.

Якщо ви можете уникнути консолідації, зберігаючи при цьому значні розміри UTXO, це ідеально. Для цього оптимізуйте свої методи придбання. Якщо ви купуєте свої біткойни в DCA, намагайтеся максимально розтягнути свої одноразові покупки, щоб групувати вартість у меншу кількість UTXO. Буде легше управляти одноразовою покупкою на €1,000 кожні 2 місяці, ніж покупкою на €120 щотижня. Це мінімізує кількість генерованих UTXO і спрощує управління вашим гаманцем, зберігаючи вашу конфіденційність.

Якщо вам потрібно консолідувати свої біткойни, спочатку віддайте перевагу консолідації UTXO з одного джерела. Наприклад, об'єднання 10 UTXO з однієї платформи вплине на вашу конфіденційність менше, ніж змішування 5 UTXO з платформи A з 5 UTXO з платформи B. Якщо консолідація з різних джерел неминуча, спробуйте розділити їх згідно з їх характеристиками. Наприклад, групуйте UTXO, отримані через KYC, в одній транзакції, а ті, що отримані в P2P, в іншій.
У будь-якому випадку, пам'ятайте, що будь-яке об'єднання неминуче призводить до втрати конфіденційності. Тому ретельно оцініть необхідність цієї операції та потенційний вплив на вашу приватність, враховуючи ризик.
## Інші хороші практики
<chapterId>b5216965-7d13-4ea1-9b7c-e292966a487b</chapterId>

Давайте разом розглянемо деякі інші хороші практики, які можуть допомогти вам оптимізувати вашу конфіденційність у Bitcoin.

### Повний вузол
Володіння вашими біткоїнами у власному зберіганні - це добре, але використання власного повного вузла краще! Ось чому мати власний вузол є критично важливим для повністю суверенного використання Bitcoin:
- **Стійкість до цензури**: Ваші транзакції не можуть бути заблоковані ніким;
- **Незалежність від третіх сторін**: Ви більше не залежите від будь-якої зовнішньої служби для перевірки даних блокчейна;
- **Активна участь**: У вас є можливість встановлювати власні правила валідації та безпосередньо брати участь у консенсусі;
- **Внесок у мережу**: Запускаючи вузол, ви допомагаєте зміцнити та розподілити мережу Bitcoin;
- **Технічна освіта**: Управління повним вузлом є відмінним способом поглибити ваші технічні знання про Bitcoin.

Окрім цих переваг, використання повного вузла також покращує вашу конфіденційність при трансляції ваших транзакцій. Коли ви відправляєте транзакцію, вона спочатку створюється та підписується через ваш гаманець. Щоб транслювати її в мережу Bitcoin, вона має бути відома принаймні одному вузлу. Використовуючи власний вузол, ви безпосередньо контролюєте цю трансляцію, тим самим покращуючи вашу конфіденційність та обмежуючи ризики витоку даних.

![BTC204](assets/notext/46/01.webp)

Якщо у вас немає власного вузла Bitcoin, вам доведеться використовувати вузол третьої сторони, наприклад, той, що пропонується вашим постачальником програмного забезпечення гаманця. Крім трансляції транзакцій, ваш гаманець потребує доступу до різної інформації, такої як очікуючі транзакції, баланси, асоційовані з вашими адресами, або кількість підтверджень для ваших транзакцій. Щоб отримати доступ до всіх цих даних, вам потрібно запитати вузол.

![BTC204](assets/notext/46/02.webp)

Основний ризик, коли ви не використовуєте власний вузол Bitcoin, полягає в тому, що оператор вузла третьої сторони може спостерігати за вашою діяльністю в блокчейні або навіть ділитися цією інформацією з іншими суб'єктами. Щоб обмежити цей ризик, проміжним рішенням є використання програмного забезпечення гаманця, яке дозволяє маскувати ваші з'єднання через Tor. Це може зменшити витік ваших даних. Однак, оптимальним рішенням залишається мати власний вузол Bitcoin і використовувати його для трансляції ваших транзакцій. Звичайно, вам також потрібно буде переконатися, що з вашого вузла не витікає жодної інформації, але це інша тема, яку ми розглянемо в наступних розділах.
Понад очевидну перевагу для вашої конфіденційності, наявність власного повного вузла також забезпечує достовірність даних на блокчейні, захищає від цензури та дозволяє вам активно брати участь у управлінні Bitcoin. Використовуючи власний вузол, ви вносите свою економічну вагу до ланцюга вашого вибору, що є важливим під час конфліктів у спільноті, наприклад, під час Війни за розмір блоку з 2015 по 2017 рік. У разі форку, використання вузла третьої сторони може призвести вас до підтримки ланцюга, який ви не бажаєте вибирати, оскільки оператор вузла робить вибір за вас.
Як ви можете зрозуміти, з огляду на конфіденційність та більш широко індивідуальний суверенітет, важливо запускати та використовувати власний повний вузол!

### Обман аналітичних евристик
Ширше кажучи, важливо розуміти евристики, про які ми говорили у попередній частині, щоб краще уникати або обманювати їх. Прийняття серії хороших практик може бути корисним, навіть якщо вони не є незамінними. Вони пропонують додатковий рівень захисту, який може бути важливим для підтримки гарної конфіденційності при використанні Bitcoin.
Перша порада, яку я міг би дати, - це змішатися з найгустішим натовпом. На Bitcoin це означає використання найпоширеніших шаблонів скриптів. Наприклад, скрипти P2WSH, які часто використовуються для конфігурацій SegWit V0 multisig, дуже рідкісні. Вони не дозволяють вам ховатися в великому анонімному наборі. Те ж саме стосується старих моделей, як P2PKH або P2SH. Хоча вони широко присутні в наборі UTXO, вони використовуються все менше і менше для нових транзакцій.

Загалом, безпечніше звертатися до найновішого стандарту скрипта, за умови, що він достатньо прийнятий. Так, якщо в 2022 році я б радив проти використання P2TR (Taproot) через його низьке прийняття, то до 2024 року я б рекомендував вибирати цей тип скрипта, або, у разі неможливості, скрипт SegWit V0, оскільки кількість транзакцій, що використовують P2TR, починає представляти дуже значну частку.

![BTC204](assets/notext/46/03.webp)

Джерело: [txstats.com](https://txstats.com/d/000000054/utxo-set-repartition-by-output-type)
Ще одна порада для збереження вашої конфіденційності - це спроба обійти внутрішні евристики транзакцій. Наприклад, при здійсненні платежу, ви можете спробувати уникнути створення виходу з круглою сумою, оскільки це може сигналізувати, що інший вихід представляє решту. Якщо вам потрібно відправити 100k сатоші другу, розгляньте можливість переказу трохи більшої суми, щоб уникнути цієї евристики. Аналогічно, намагайтеся не створювати виходи решти, які непропорційно великі порівняно з здійсненим платежем, оскільки це також може виявити, який з виходів представляє решту.
![BTC204](assets/notext/46/04.webp)

Нарешті, якщо ви регулярно здійснюєте транзакції Bitcoin, переконайтеся, що ви не завжди транслюєте їх у ті самі часи. Розподіляючи трансляцію ваших транзакцій протягом дня та тижня, ви уникаєте надання зовнішнім спостерігачам можливості виявити тимчасовий шаблон на основі часових поясів, який міг би покращити їх аналіз.

Понад усі ці хороші практики, які слід приймати щодня, існують ще більш ефективні методи повного розриву слідування ваших біткойнів. Серед них, звичайно, є транзакції coinjoin, які ми детально вивчимо в наступній частині.

# Розуміння транзакцій Coinjoin
<partId>6d0bbf16-3714-4db1-9897-2d45019f6bdc</partId>

## Що таке транзакція Coinjoin?
<chapterId>0862bc6b-1c48-4aa4-b76d-4f547b469008</chapterId>

Після вивчення основ захисту конфіденційності, ми тепер обговоримо більш складні техніки, спрямовані на активний захист вашої конфіденційності, зокрема шляхом роз'єднання історії ваших біткойнів. У наступній частині ми дослідимо багато дрібних технік, але спочатку я хочу поговорити з вами про coinjoin.

Coinjoin часто вважається найефективнішим методом для захисту конфіденційності користувачів Bitcoin. Але що саме таке транзакція coinjoin? Давайте з'ясуємо разом.

### Основні принципи Coinjoin

Coinjoin - це техніка, яка розриває слідування біткойнів на блокчейні. Вона ґрунтується на спільній транзакції зі специфічною структурою однойменної: транзакцією coinjoin.
Як ми бачили в перших частинах цього навчання, транзакції в Bitcoin відомі всім користувачам через їхній вузол. Тому легко перевірити ланцюг електронних підписів кожної монети та спостерігати за її історією. Це означає, що всі користувачі можуть намагатися аналізувати транзакції інших користувачів. В результаті, анонімність на рівні транзакцій неможлива. Однак, анонімність зберігається на рівні ідентифікації особи. На відміну від традиційної банківської системи, де кожен рахунок пов'язаний з особистою ідентичністю, в Bitcoin кошти асоційовані з криптографічними ключовими парами (або скриптами), таким чином надаючи користувачам форму псевдонімності за криптографічними ідентифікаторами.![BTC204](assets/en/51/01.webp)

Таким чином, конфіденційність в Bitcoin порушується, коли зовнішні спостерігачі вдаються до асоціації конкретних UTXO з ідентифікованими користувачами. Як тільки ця асоціація встановлена, стає можливим відстежувати їхні транзакції та аналізувати історію їхніх біткоїнів. Coinjoin - це саме техніка, розроблена для розриву слідування UTXO, з метою надання певного рівня конфіденційності користувачам Bitcoin на рівні транзакцій.

Coinjoins підвищують конфіденційність користувачів Bitcoin, ускладнюючи аналіз ланцюга для зовнішніх спостерігачів. Їх структура дозволяє об'єднувати кілька монет від різних користувачів в одну транзакцію, таким чином затемнюючи сліди та ускладнюючи визначення зв'язків між вхідними та вихідними адресами.

Важливо розуміти, що мета транзакції coinjoin полягає в розриві історії монети. Ця техніка не надає постійної анонімності, ні остаточно не блокує відстеження біткоїнів, на відміну від того, що можна було б подумати. Coinjoin має на меті лише розірвати історію в точці, де виконується транзакція coinjoin. Однак, до і після цієї операції, монета залишається піддана тим самим ризикам приватності.

![BTC204](assets/notext/51/02.webp)

### Як працюють coinjoins?

Принцип coinjoin ґрунтується на колаборативному підході: кілька користувачів, які бажають змішати свої біткоїни, вносять ідентичні суми в входи однієї та тієї ж транзакції. Ці суми потім перерозподіляються в виходи однакових значень кожному користувачу.

![BTC204](assets/notext/51/03.webp)

В кінці транзакції стає неможливим асоціювати конкретний вихід з відомим користувачем на вході. Прямого зв'язку між входами та виходами не існує, що розриває асоціацію між користувачами та їхніми UTXO, а також історію кожної монети.

![BTC204](assets/notext/51/04.webp)
Давайте розглянемо приклад Аліси. Вона хоче відправити приблизно 100,000 сатоші своїй сестрі Єві на день народження. Однак, Аліса не хоче, щоб Єва могла відстежити історію її транзакцій, тому що вона не хоче розкривати, скільки біткоїнів вона має або як вона їх отримала. Для цього Аліса вирішує розірвати історію свого UTXO за допомогою транзакції coinjoin. Вона організовується з Бобом, Чарльзом, Девідом та Френком для проведення колаборативної транзакції:
- Аліса, Боб, Чарльз, Девід та Френк кожен вносять UTXO по 105,000 сатоші (з 5,000 сатоші на майнінгові комісії) як входи для транзакції:

![BTC204](assets/notext/51/05.webp)

- У відповідь на використання цих входів, кожен генерує нову адресу для створення п'яти однакових виходів по 100,000 сатоші кожен. Кожен отримує вихід:

![BTC204](assets/notext/51/06.webp)

- Аліса в результаті отримує UTXO на 100,000 сатоші, чия історія змішана. Вона використовує цей UTXO в новій транзакції, щоб відправити суму Єві на день народження:
![BTC204](assets/notext/51/07.webp)
- Якщо Єва спробує проаналізувати цю транзакцію, щоб витягнути інформацію, вона зіткнеться з транзакцією coinjoin, в якій беруть участь Аліса, Боб, Чарльз, Девід та Френк. Не маючи можливості відрізнити, який вхід належить кому через однаковість сум, Єва не може простежити історію UTXO Аліси, а також визначити, скільки біткоїнів має її сестра або як вона їх отримала:

![BTC204](assets/notext/51/08.webp)

У цьому сценарії Аліса використала техніку coinjoin, щоб збільшити свою конфіденційність проти ретроспективного аналізу. Дійсно, Аліса захищає себе від можливого аналізу з боку Єви, який би почався з конкретної транзакції для простеження історії UTXO назад. Цей захист від аналізу з теперішнього в минуле називається ретроспективний anonset. Ми детальніше розглянемо цю концепцію в останніх розділах цієї частини.

Однак, coinjoin також пропонує можливість покращити конфіденційність проти аналізу з минулого в теперішнє, що називається перспективний anonset. Повернімося до нашого прикладу, де Аліса відправила 98,000 сатоші Єві на її день народження, але змінимо ролі. Тепер уявіть, що Єва турбується про свою конфіденційність. Дійсно, Аліса може бути спокусена слідувати за монетою, яку вона відправила Єві, щоб зібрати інформацію. Єва може об'єднати цей UTXO, який вона щойно отримала, з усіма своїми іншими UTXO, що може розкрити Алісі кількість біткоїнів, які вона тримає у своєму гаманці. Щоб уникнути цього, Єва також може перервати історію монети, яку вона щойно отримала.
- Єва, Грейс, Меллорі, Оскар та Віктор кожен вносять UTXO по 98,000 сатоші як вхідні дані в транзакцію Bitcoin:
![BTC204](assets/notext/51/09.webp)

- В обмін на використання цих вхідних даних, кожен надає нову адресу для створення 5 вихідних даних по 97,500 сатоші кожен, абсолютно рівні. Кожен користувач отримує вихідні дані:

![BTC204](assets/notext/51/10.webp)

- Тепер Єва має UTXO на 97,500 сатоші з перерваною історією. Вона може використовувати його без страху для майбутніх транзакцій. Дійсно, якщо Аліса спробує слідувати за біткоїнами, які вона відправила Єві, вона зіткнеться з транзакцією coinjoin. Вона не зможе визначити, якому вихідному UTXO належить Єва. Аналіз стає неможливим:

![BTC204](assets/notext/51/11.webp)

У першому прикладі ми побачили, як coinjoin може захистити конфіденційність монети у відношенні до її минулого, а в другому прикладі, як він також може забезпечити історію монети у відношенні до її майбутнього. Ось чому я згадав, що coinjoin слід розглядати як одноразову подію, яка розділяє історію монети в обох напрямках:

![BTC204](assets/notext/51/02.webp)

### Міксування, coinjoins, міксери... У чому різниця?

Термін "міксування" іноді використовується для опису coinjoins, термін, який деякі біткоїнери відкидають, оскільки вони бояться плутанини з кастодіальними міксерами. Однак, я вважаю, що ці побоювання є безпідставними, оскільки в математичному контексті coinjoin точно втілює концепцію міксування.
У загальній області математики, змішування відноситься до властивості динамічної системи, де, після деякого часу, всі частини початкового простору теоретично можуть бути змішані з будь-якою іншою частиною. Змішування передбачає, що положення частинки або стан системи еволюціонує таким чином, що її майбутнє розподіл є незалежним від її початкового розподілу, досягаючи стану, де характеристики початкового стану рівномірно розподілені по всьому простору системи. Саме це відбувається у coinjoin з біткоїнами. Таким чином, на мою думку, coinjoin дійсно є методом змішування монет.
![BTC204](assets/notext/51/12.webp)

Однак, важливо відрізняти coinjoin від міксерів. Міксер - це сервіс, куди користувачі відправляють свої біткоїни для змішування. Ці сервіси були популярні протягом 2010-х років, але їх використання зменшилося через два основні недоліки порівняно з coinjoin:
- Вони вимагають від користувача відмовитися від контролю над своїми коштами під час процесу змішування, що піддає їх ризику крадіжки;
- Немає гарантії, що міксер не записує деталі транзакцій, або навіть не продає цю інформацію компаніям аналізу ланцюгів.
![BTC204](assets/notext/51/13.webp)

На сьогоднішній день користувачі тому віддають перевагу coinjoin, оскільки це дозволяє їм зберігати повний контроль над своїми коштами протягом усього процесу. Учасники coinjoin не ризикують втратити свої біткоїни через інших учасників. Давайте разом дослідимо, як все це можливо в наступному розділі.

## Zerolink та Chaumian Coinjoins
<chapterId>326c9654-b359-4906-b23d-d6518dd5dc3e</chapterId>

Приватність, яку надає coinjoin, залежить від розміру групи, в якій наша частка захована. Тому необхідно знайти якомога більше учасників. Здійснити coinjoin вручну, з користувачами, яких ви знайшли самостійно, цілком можливо, але цей метод складний, і він не дозволяє досягти великих анонімних наборів.

Саме тому були розроблені координатори coinjoin на Bitcoin. Їхня роль полягає у з'єднанні різних користувачів та передачі інформації, необхідної для успішного завершення спільної транзакції.

![BTC204](assets/notext/52/01.webp)

Але як можна забезпечити, щоб координатор ніколи не мав контролю над біткоїнами користувачів, і, незважаючи на те, що вони є особою, яка конструює транзакцію coinjoin, як можна забезпечити, щоб вони не могли зв'язати входи та виходи користувачів, що могло б становити витік приватності?

### Сліпі Підписи Чаума

Сучасні реалізації coinjoin використовують сліпі підписи Девіда Чаума для уникнення витоку інформації. Давайте швидко вивчимо разом, як працюють ці сліпі підписи.

Сліпі підписи Чаума - це форма цифрового підпису, де видавець підпису не знає змісту повідомлення, яке він підписує. Однак, підпис пізніше може бути перевірений з оригінальним повідомленням. Цю техніку було розроблено криптографом Девідом Чаумом у 1983 році.

![BTC204](assets/notext/52/02.webp)

Візьмемо приклад компанії, яка хоче аутентифікувати конфіденційний документ, такий як контракт, не розкриваючи його зміст. Компанія застосовує процес маскування, який криптографічно перетворює оригінальний документ оборотним чином. Цей модифікований документ відправляється до сертифікаційного органу, який застосовує сліпий підпис, не знаючи підлеглого змісту. Після отримання підписаного документа, компанія знімає маскування з підпису. Результатом є оригінальний документ, аутентифікований підписом органу, без того, щоб орган коли-небудь бачив оригінальний зміст.
Сліпі підписи Чаума дозволяють засвідчити автентичність документа, не знаючи його змісту, що гарантує як конфіденційність даних користувача, так і цілісність підписаного документа.
### Чауміанські Coinjoins
У "Чауміанських CoinJoins" використання Tor та сліпих підписів Девіда Чаума поєднуються, щоб забезпечити, що координатор не може знати, який вихід належить якому користувачу. Процес створення транзакції coinjoin обертається навколо 3 основних кроків: реєстрація входів, реєстрація виходів та підписання транзакції. Давайте розглянемо цей процес на прикладі Аліси, одного з учасників coinjoin. Всі інші учасники слідують тим же крокам, що й Аліса, кожен самостійно.

**Крок 1: Реєстрація входів.**
- Аліса надсилає координатору UTXO, який вона хоче використати як вхід для транзакції, а також замасковану адресу отримання, яку вона хоче використати як вихід для отримання своїх біткойнів. Таким чином, координатор не може знати адресу Аліси. Він бачить лише її замасковану версію:

![BTC204](assets/notext/52/03.webp)

- Координатор перевіряє валідність входів, потім підписує замасковану адресу Аліси своїм приватним ключем. Він відправляє Алісі сліпий підпис:

![BTC204](assets/notext/52/04.webp)

**Крок 2: Реєстрація виходів.**
- Тепер Аліса може розкрити свою адресу, підписану приватним ключем координатора. Вона встановлює нове з'єднання під іншою ідентичністю Tor. Координатор не може ідентифікувати, що це Аліса підключається під цією новою ідентичністю:

![BTC204](assets/notext/52/05.webp)

- Аліса надсилає розкриту адресу та підпис координатору (який все ще не знає, що це Аліса):

![BTC204](assets/notext/52/06.webp)

**Крок 3: Підписання транзакції.**
- Координатор аналогічно отримує розкриті виходи від усіх учасників. Завдяки відповідним підписам, він може перевірити, що кожен вихід, поданий анонімно, дійсно був підписаний його приватним ключем раніше, забезпечуючи їхню легітимність. Потім він готовий сконструювати транзакцію coinjoin і відправляє її учасникам для підписання:

![BTC204](assets/notext/52/07.webp)

- Аліса, як і інші учасники, перевіряє, що її вхід та вихід правильно включені в транзакцію, сконструйовану координатором. Якщо все задовільно, вона надсилає підпис, який розблоковує скрипт її входу координатору:

![BTC204](assets/notext/52/08.webp)

- Після збору підписів від усіх учасників coinjoin, координатор може транслювати транзакцію в мережу Bitcoin, щоб вона могла бути додана до блоку.
У цій системі координатор не може пов'язати вхід з конкретним виходом. Більше того, він не може взяти володіння коштами учасників, оскільки ніколи не має доступу до приватних ключів, необхідних для розблокування їхніх UTXO. Протягом усього процесу, і до кінця кроку 3, він також не має доступу до підписів. Коли Аліса та інші учасники підписують загальну транзакцію, після перевірки на коректність, координатор більше не може змінити цю транзакцію, включаючи виходи, без її інвалідації. Це, таким чином, запобігає крадіжці біткойнів координатором.
В остаточному підсумку, коли користувач coinjoin записує свій результат у транзакції, він хоче мати гарантії, подібні до тих, що має громадянин, голосуючи на виборах. Існує двоїстість між публічними та приватними аспектами цих дій. З одного боку, є те, що хочеться зберегти в таємниці: для виборця, вони не хочуть, щоб їхній бюлетень був пов'язаний з їхньою особистістю; для користувача coinjoin, вони не хочуть, щоб їхній результат був асоційований з їхнім входом. Дійсно, якщо координатор, або будь-яка інша сторона, вдасться встановити зв'язок між входом і виходом, coinjoin втрачає весь свій сенс. Як було пояснено раніше, coinjoin має функціонувати як переривання в історії монети. Ця зупинка відбувається саме через неможливість асоціювати певний вхід з певним виходом у транзакції coinjoin (перспективний anonset) і навпаки (ретроспективний anonset).

З іншого боку, є публічний аспект: виборець хоче переконатися, що його бюлетень включено до виборчої скриньки; аналогічно, користувач coinjoin хоче переконатися, що його результат включено до транзакції coinjoin. Дійсно, абсолютно необхідно, щоб учасники coinjoin могли перевірити наявність свого результату перед підписанням транзакції, інакше координатор міг би вкрасти кошти.

Саме ці 2 публічні та приватні аспекти, зроблені можливими за допомогою сліпих підписів Девіда Чаума, гарантують учасникам Chaumian coinjoins, що їхні біткоїни не будуть вкрадені, і що їхні кошти не можуть бути відстежені.

### Хто винайшов концепцію coinjoin?

Важко з упевненістю визначити, хто першим представив ідею coinjoin на Bitcoin, і хто мав ідею використання сліпих підписів Девіда Чаума в цьому контексті. Часто вважається, що це був Грегорі Максвелл, який першим заговорив про це в [повідомленні на BitcoinTalk у 2013 році](https://bitcointalk.org/index.php?topic=279249.0):
Використання сліпих підписів Чаума: Користувачі входять в систему та надають входи (та адреси для здачі) разом з криптографічно замаскованою версією адреси, на яку вони хочуть відправити свої приватні монети; сервер підписує токени та повертає їх користувачам. Користувачі підключаються анонімно, розкривають свої адреси виходів та відправляють їх назад на сервер. Сервер може бачити, що всі виходи були підписані ним і що, відповідно, всі виходи походять від дійсних учасників. Пізніше люди підключаються знову та підписують.
Максвелл, Г. (2013, 22 серпня). *CoinJoin: Приватність Bitcoin для реального світу*. Форум BitcoinTalk. https://bitcointalk.org/index.php?topic=279249.0

![BTC204](assets/notext/52/09.webp)

Однак, існують більш ранні згадки, як для підписів Чаума в контексті міксування, так і для coinjoins. [У червні 2011 року, Дункан Таунсенд представив на BitcoinTalk](https://bitcointalk.org/index.php?topic=12751.0) міксер, який використовує підписи Чаума способом досить схожим на сучасні Chaumian coinjoins.
У тій самій гілці є [повідомлення від hashcoin у відповідь Duncan Townsend](https://bitcointalk.org/index.php?topic=12751.msg315793#msg315793), щоб покращити його міксер. Процес, описаний у цьому повідомленні, точно представляє те, що найбільше нагадує coinjoins. Також згадується подібна система у [повідомленні від Alex Mizrahi у 2012 році](https://gist.github.com/killerstorm/6f843e1d3ffc38191aebca67d483bd88#file-laundry), коли він радив творцям Tenebrix, однієї з перших альткоїнів, яка послужила основою для створення Litecoin згодом. Навіть термін "coinjoin" не був винайдений Greg Maxwell, а вийшов з ідеї Peter Todd.
![BTC204](assets/notext/52/10.webp)

### Zerolink

Zerolink - це комплексний протокол міксування, який інтегрує Chaumian coinjoins та різні стратегії для захисту анонімності користувачів проти кількох форм аналізу ланцюгів, зокрема, мінімізуючи помилки, пов'язані з управлінням гаманцем. Цей протокол [був представлений nopara73 та TDevD у 2017 році](https://github.com/nopara73/ZeroLink/blob/master/README.md).

![BTC204](assets/notext/52/11.webp)

Як випливає з назви, принцип Zerolink полягає у проведенні транзакцій coinjoin, які забезпечують неможливість відстеження зв'язків між входами та виходами. Ця характеристика досягається шляхом забезпечення того, що всі виходи мають абсолютно ідентичні суми.

![BTC204](assets/notext/52/12.webp)
Важливим запобіжним заходом від Zerolink є повне відокремлення незмішаних UTXO від змішаних UTXO за допомогою використання різних наборів криптографічних ключів, або навіть окремих гаманців. Таким чином, гаманець "до міксу", призначений для монет до міксування, відрізняється від гаманця "після міксу", призначеного для монет, які були змішані.
![BTC204](assets/notext/52/13.webp)

Це строге відокремлення UTXO перш за все служить для запобігання випадковим асоціаціям між змішаним UTXO та незмішаним UTXO. Дійсно, якщо такі зв'язки виникають, ефективність coinjoin на змішаному UTXO анулюється без відома користувача, таким чином компрометуючи конфіденційність UTXO, історію якого вони вважали перерваною. Ці зв'язки можуть виникати або через повторне використання адреси при забезпеченні змішаного UTXO незмішаним, або застосуванням гевристики спільного володіння входами (CIOH), якщо користувач використовує змішані та незмішані UTXO як входи однієї транзакції. Відокремлення гаманців до та після міксування уникає цих випадкових асоціацій, і користувач захищений від ненавмисних помилок.

![BTC204](assets/notext/52/14.webp)

Це відокремлення також пропонує можливість застосування різних правил між гаманцями до міксування та після міксування на рівні програмного забезпечення гаманця. Наприклад, у гаманці після міксу програмне забезпечення може забороняти об'єднання UTXO в входи, щоб запобігти застосуванню CIOH, яке могло б скомпрометувати anonset користувача. Також можливо стандартизувати використання скриптів та опцій транзакцій (наприклад, сигналізації RBF) для запобігання ідентифікації за відбитками гаманця.

Наразі Whirlpool є єдиною реалізацією coinjoin, яка суворо застосовує протокол Zerolink. У наступному розділі ми розглянемо різні існуючі реалізації coinjoin та переваги та недоліки кожної.
<chapterId>e37ed073-9498-4e4f-820b-30951e829596</chapterId>
*У 2024 році ми спостерігаємо значні зміни в інструментах, доступних для користувачів, які бажають виконувати coinjoins на Bitcoin. Ми зараз перебуваємо в переломний період, і ринок coinjoin переживає велику реструктуризацію. Тому цей розділ, ймовірно, буде оновлюватися з часом.*

На даний момент існує головним чином 3 різні реалізації coinjoin на Bitcoin:
- Whirlpool;
- Wabisabi;
- JoinMarket.
Кожна з цих реалізацій має на меті розірвати історію UTXO через транзакції coinjoin. Однак їхні механізми значно відрізняються. Тому важливо розуміти, як кожна з них працює, щоб вибрати найбільш підходящий варіант для ваших потреб.

### JoinMarket

JoinMarket, створений у 2015 році Адамом Гібсоном та Крісом Белчером, вирізняється серед інших реалізацій coinjoin завдяки своїй унікальній моделі зіставлення користувачів. Ця система базується на ринку P2P обміну, де деякі користувачі, "makers", роблять свої біткоїни доступними для міксування, тоді як інші, "takers", використовують ці кошти для виконання транзакцій coinjoin в обмін на плату.

![BTC204](assets/notext/53/01.webp)

У цій моделі "makers" залишають свої біткоїни доступними для "takers" і отримують плату за свою послугу. "Takers", з іншого боку, платять за використання біткоїнів "makers" для проведення власних транзакцій coinjoin. Розмір сервісних зборів залежить від ролі: "makers" накопичують збори за свою пропозицію ліквідності, тоді як "takers" платять збори. Цей ринок діє вільно без умов використання.

Одним з основних недоліків JoinMarket є його складність у використанні, яка вимагає певної знайомості з терміналами для ефективного використання. Хоча ця складність не є бар'єром для досвідченого користувача, вона може обмежити доступ для широкої публіки. Однак нещодавнє введення веб-інтерфейсу під назвою JAM дещо полегшило його використання.

![BTC204](assets/notext/53/02.webp)

Джерело: [JAM](https://github.com/joinmarket-webui/jam/blob/devel/docs/assets/screenshot-dark.webp)

Однак технічний бар'єр залишається значною перешкодою. У екосистемі coinjoin, де конфіденційність посилюється кількістю учасників, будь-яке обмеження, що знижує доступність, безпосередньо впливає на доступну ліквідність, яка є вирішальним фактором для ефективності міксування. Bitcoin, вже ніша в фінансових транзакціях, бачить своє використання coinjoins як піднішу, а JoinMarket представляє ще більш спеціалізовану частку, таким чином обмежуючи свій потенціал для збільшення anonsets своїх користувачів.

Незважаючи на свою інноваційну модель P2P зіставлення для coinjoins, JoinMarket має деякі значні недоліки, особливо з точки зору транзакційної структури. На відміну від інших реалізацій, таких як Whirlpool, JoinMarket не гарантує ідеальної рівності між виходами, і можливо простежити детерміновані зв'язки між входами та виходами. Більше того, він не має інструментів для запобігання повторному міксуванню монет, які вже були змішані разом, що може поставити під загрозу конфіденційність, яку шукають користувачі.
Нарешті, хоча концепція JoinMarket є цікавою, особливо для тих, хто зацікавлений у динамічному ринку ліквідності, його структурні слабкості та технічна складність роблять його, на мою думку, менш привабливим, як для новачків, так і для експертів, які шукають реалізацію coinjoin.
### Wabisabi
Wabisabi - це ще одна реалізація coinjoin, яка передбачає централізоване координування транзакцій. Цю модель було розроблено Адамом Фіксором (nopara73), Ювалем Когманом, Лукасом Онтіверо та Іштваном Андрашем Серешем у 2021 році, і вона була інтегрована в програмне забезпечення Wasabi 2.0 наступного року. Wabisabi є точною еволюцією моделі coinjoin програмного забезпечення Wasabi, запущеного у 2018 році.
![BTC204](assets/notext/53/03.webp)

Наприкінці 2010-х років Wasabi прийняв структуру транзакцій для своїх coinjoins, яка кардинально відрізнялася від тієї, що використовувалася Whirlpool. Для збільшення анонімних наборів своїх учасників, Wasabi використовував дуже великі транзакції coinjoin, групуючи десятки учасників. Натомість, Whirlpool обрав кілька малих транзакцій, що дозволяло експоненційно збільшувати анонімні набори з кожним циклом.

Методи управління рештою також відрізняли дві реалізації. У Whirlpool решта була виключена та ізольована від UTXO перед циклами coinjoin завдяки TX0, концепцію, яку я поясню далі у наступному розділі. У Wasabi, з іншого боку, решта формувала один з виходів транзакції coinjoin, що підтримувало детерміновані зв'язки між певними входами та виходами.

![BTC204](assets/notext/53/04.webp)

З Wabisabi версія 2.0 Wasabi адаптувала свій підхід до coinjoins, наблизившись до моделі Whirlpool. Хоча транзакції coinjoin залишаються дуже великими, тепер можливо здійснити кілька послідовних циклів, таким чином слідуючи моделі Whirlpool. Особлива увага також була приділена управлінню рештою: на відміну від Wasabi 1.0, де решта була безпосередньо пов'язана з входами користувачів, Wabisabi прагне поділити решту на кілька малих сум, розподілених рівними номіналами для всіх учасників.

Давайте ілюструвати це на спрощеному прикладі, що включає лише 2 користувачів: Аліса хоче змішати 115,000 sats, а Боб - 210,000 sats. Ігноруючи комісії, з Wasabi 1.0 транзакція coinjoin була би створила 3 виходи по 100,000 sats, плюс 1 решту 15,000 sats для Аліси та 1 решту 10,000 sats для Боба. Виходи решти завжди були б пов'язані з входами:

![BTC204](assets/notext/53/05.webp)
Під Wabisabi та сама транзакція би створила 3 виходи по 100,000 sats та 5 виходів по 5,000 sats, таким чином розподіляючи решту так, що вона не є безпосередньо простежуваною до конкретного входу:
![BTC204](assets/notext/53/06.webp)

Особисто я вважаю, що управління рештою в Wabisabi представляє кілька ризиків, які можуть підірвати його ефективність з точки зору приватності:
- Коли користувач вносить UTXO, значно більший, ніж ті, що мають інші учасники, вони неминуче отримують суму решти, яка буде пов'язана з їхнім входом. Це суперечить початковій меті протоколу, яка полягає в усуненні будь-якої ідентифікованої решти;
- Розмноження номіналів для фрагментації решти може парадоксально зашкодити ефективності змішування. Цей процес може призвести до зниження анонімних наборів для певних виходів, оскільки вони стають легше ідентифікованими.
Цей метод також генерує UTXO низької вартості, які створюють проблеми з управлінням для користувача. Ці малі UTXO, якщо витрати на їх використання стають занадто великими порівняно з їх вартістю, можуть перетворитися на "пил". Це явище змушує користувача об'єднувати кілька UTXO в інпути в їх майбутніх транзакціях або консолідувати їх. В обох випадках, через COH, це може або зменшити отримані anonsets, або повністю скасувати приватні переваги, отримані завдяки початковому coinjoin.

На відміну від Whirlpool, який впроваджує протокол ZeroLink, що забезпечує суворе розділення між UTXO до змішування та після нього, Wabisabi не підтримує це строге сегрегування. Також були проблеми з повторним використанням адрес деякими клієнтами Wasabi, що, очевидно, дуже шкідливо для користувача.

У версії 2.0 Wasabi було впроваджено нову політику комісій за coinjoin. Тепер комісії координатора становлять 0.3% для UTXO більше ніж 0.01 біткоїна, тоді як для менших UTXO ці комісії повністю скасовані. Більше того, ремікси для цих малих UTXO є безкоштовними, хоча комісії за майнінг залишаються на відповідальності користувача для всіх транзакцій, включаючи ремікси.

Ця політика контрастує з політикою Whirlpool, де комісії залишаються фіксованими, незалежно від розміру отриманих anonsets. З Wasabi 2.0, хоча комісії координатора скасовані для малих UTXO, користувач все одно мусить платити комісії за майнінг на всі транзакції, включаючи ремікси.
На момент написання, використання Wabisabi стало помітно складнішим після останніх подій. Дійсно, після арешту засновників Samourai Wallet, zkSNACKs, компанія, яка фінансує та керує розробкою Wasabi, оголосила про припинення свого сервісу координації coinjoin з 1 червня 2024 року. Цей координатор, який був встановлений за замовчуванням на Wasabi, мав переважну більшість ліквідності.

З припиненням роботи цього основного координатора, користувачам тепер потрібно підключатися до нових незалежних координаторів. Ця зміна викликає занепокоєння: з одного боку, нові координатори можуть не мати достатньої ліквідності, що зменшує ефективність coinjoins з точки зору приватності. З іншого боку, існує ризик зіткнутися з шкідливим координатором. Ця ситуація додає нові значні ризики для тих, хто хоче використовувати Wabisabi.

Поза технічними проблемами, рішення zkSNACKs, компанії за Wasabi, використовувати послуги компанії з аналізу ланцюгів для фільтрації учасників coinjoins ставить серйозні етичні та стратегічні питання. Початкова ідея полягала в тому, щоб запобігти використанню coinjoins на Wasabi злочинцями, крок, який може здатися законним. Однак, це породжує парадокс: платити комісії координатору, основна місія якого - підвищити приватність користувачів, лише для того, щоб потім фінансувати компанію, чия мета - порушити цю саму приватність.

Ще більш тривожним є принцип фільтрації, який різко контрастує з філософією Bitcoin, спрямованою на створення відкритої та непідконтрольної фінансової системи. Хоча може здатися виправданим бажання виключити кримінальну діяльність, ця фільтрація також може торкнутися осіб, чиї дії, хоча й класифікуються як незаконні в деяких контекстах, можуть бути морально виправданими або соціально корисними. Приклад Едварда Сноудена ідеально ілюструє цю дихотомію: вважаючи його злочинцем деякими урядами за його розкриття, інші бачать його як викривача, який діяв у громадських інтересах. Ця складність підкреслює потенційну небезпеку фільтрації, яка, хоча й виходить з добрих намірів, може в кінцевому підсумку порушити права та безпеку легітимних користувачів. Також можна було б згадати активістів та журналістів, які переслідуються під певними авторитарними режимами.
Як ви вже зрозуміли, моя перевага безсумнівно належить моделі Whirlpool для проведення coinjoins на Bitcoin. Ця система вирізняється своєю строгістю та пропонує вищі гарантії з точки зору конфіденційності. Вона також є єдиною, яка пропонує змішування, вважане ідеальним у математичному контексті. На мою думку, ця модель представляє майбутнє coinjoins на Bitcoin. Тому я запрошую вас глибше дослідити цю модель у наступному розділі.
## Функціонування Whirlpool
<chapterId>bdbd7109-e36d-4b4f-a3c6-928df4e9bfda</chapterId>

Whirlpool відрізняється від інших методів coinjoin за допомогою транзакцій "_ZeroLink_", які забезпечують, що технічно неможливо створити жодного зв'язку між усіма входами та виходами. Це ідеальне змішування досягається через структуру, де кожен учасник вносить однакову суму на вхід (крім комісії за майнінг), таким чином генеруючи виходи з абсолютно рівними сумами.

Цей обмежувальний підхід до входів надає транзакціям coinjoin Whirlpool унікальну характеристику: повна відсутність детермінованих зв'язків між входами та виходами. Іншими словами, кожен вихід має однакову ймовірність бути приписаним будь-якому учаснику, у відношенні до всіх інших виходів транзакції.

![BTC204](assets/notext/54/01.webp)

### Загальне функціонування Whirlpool

Спочатку кількість учасників у кожному coinjoin Whirlpool була обмежена 5, з 2 новими учасниками та 3 реміксерами (ми пояснимо ці поняття далі). Однак, зростання комісій за транзакції в мережі, спостережене у 2023 році, спонукало команди Samourai переосмислити свою модель для покращення конфіденційності, знижуючи при цьому витрати. Таким чином, враховуючи ринкову ситуацію з комісіями та кількість учасників, координатор тепер може організовувати coinjoins, що включають 6, 7 або 8 учасників. Ці покращені сесії позначені під назвою "_Surge Cycles_". Важливо зазначити, що незалежно від конфігурації, у coinjoins Whirlpool завжди є лише 2 нових учасника.

Таким чином, транзакції Whirlpool характеризуються однаковою кількістю входів та виходів, які можуть бути:
- 5 входів та 5 виходів;

![BTC204](assets/notext/54/02.webp)

- 6 входів та 6 виходів;

![BTC204](assets/notext/54/03.webp)

- 7 входів та 7 виходів;

![BTC204](assets/notext/54/04.webp)

- 8 входів та 8 виходів.

![BTC204](assets/notext/54/05.webp)
Модель, запропонована Whirlpool, таким чином базується на малих транзакціях coinjoin. На відміну від Wabisabi та JoinMarket, де міцність anonsets залежить від об'єму учасників у одному циклі (або кількох циклах), Whirlpool ставить на ланцюжок багатьох малих циклів. У цій моделі користувач зазнає витрат лише при своєму початковому вході в пул, дозволяючи їм брати участь у безлічі реміксів без додаткових зборів. Нові учасники покривають комісії за майнінг для реміксерів.

З кожним додатковим coinjoin, у якому бере участь монета разом зі своїми попередніми партнерами, anonsets будуть зростати експоненційно. Таким чином, метою є використання цих безкоштовних реміксів, які з кожним разом сприяють зміцненню щільності anonsets, асоційованих з кожною змішаною монетою.

![BTC204](assets/notext/54/06.webp)

Whirlpool було розроблено з двома важливими вимогами на увазі:
- Доступність реалізації на мобільних пристроях, враховуючи, що Samourai Wallet переважно є додатком для смартфонів;
- Швидкість циклів перемішування для стимулювання значного збільшення анонімних наборів.

Ці імперативи керували вибором розробників Samourai Wallet у проектуванні Whirlpool, змусивши їх обмежити кількість учасників на цикл. Занадто мала кількість учасників могла б підірвати ефективність coinjoin, різко зменшуючи анонімні набори, створені в кожному циклі, тоді як занадто велика кількість учасників могла б створити проблеми з управлінням на мобільних додатках і перешкоджати потоку циклів.

Врешті-решт, немає потреби мати велику кількість учасників на coinjoin у Whirlpool, оскільки анонімні набори створюються за допомогою накопичення декількох циклів coinjoin. Найважливішим принципом тут є однорідність UTXO всіх учасників, оскільки це дозволяє досягти ідеального змішування і, таким чином, повною мірою скористатися циклами змішування та перемішування.

### Басейни та комісії за coinjoin

Для того, щоб ці кілька циклів ефективно збільшували анонімні набори змішаних монет, має бути встановлений певний фреймворк, щоб обмежити кількість UTXO, що використовуються. Таким чином, Whirlpool визначає різні басейни.

Басейн представляє групу користувачів, які бажають змішатися разом, які домовляються про кількість UTXO для використання, щоб оптимізувати процес coinjoin, зберігаючи при цьому ідеальну однорідність монет. Кожен басейн вказує фіксовану кількість для UTXO, з якою користувач повинен відповідати, щоб брати участь. Таким чином, для виконання coinjoins з Whirlpool, вам потрібно вибрати басейн. На даний момент доступні такі басейни:
- 0.5 біткоїнів;
- 0.05 біткоїна;
- 0.01 біткоїна;
- 0.001 біткоїн (= 100,000 сатоші).
Приєднуючись до басейну зі своїми біткоїнами, вони будуть поділені для генерації UTXO, які є ідеально однорідними з тими, що у інших учасників басейну. Кожен басейн має максимальний ліміт; таким чином, для сум, що перевищують цей ліміт, вам буде змушено або зробити два окремі входи в межах того ж басейну, або звернутися до іншого басейну з більшою сумою:
| Басейн (біткоїн) | Максимальна сума за вхід (біткоїн) |
|------------------|------------------------------------|
| 0.5              | 35                                 |
| 0.05             | 3.5                                |
| 0.01             | 0.7                                |
| 0.001            | 0.025                              |

UTXO вважається належним до басейну, коли він готовий бути інтегрованим у coinjoin. Однак, це не означає, що користувач втрачає володіння ним. Як ми бачили в перших розділах цієї частини, через різні цикли змішування, ви зберігаєте повний контроль над своїми ключами і, відповідно, своїми біткоїнами. Це те, що відрізняє техніку coinjoin від інших централізованих технік змішування.

Для входу в басейн coinjoin вам потрібно заплатити сервісні збори, а також збори за майнінг. Сервісні збори фіксовані для кожного басейну і призначені для компенсації командам, відповідальним за розробку та обслуговування Whirlpool.

Сервісні збори за використання Whirlpool сплачуються одноразово при вході в басейн. Після завершення цього кроку у вас є можливість брати участь у необмеженій кількості перемішувань без додаткових зборів. Ось поточні фіксовані збори за кожен басейн:

| Басейн (біткоїн) | Вступний збір (біткоїн)    |
|------------------|-----------------------------|
| 0.5              | 0.0175                      |
| 0.05             | 0.00175                     |
| 0.01             | 0.0005 (50,000 сатоші)      |
| 0.001          | 0.00005 (5,000 сатс)        |
Ці комісії фактично функціонують як вхідний квиток для обраного пулу, незалежно від суми, яку ви вкладаєте в coinjoin. Таким чином, незалежно від того, приєднуєтеся ви до пулу 0.01 з точно 0.01 BTC або входите в нього з 0.5 BTC, комісії залишаться тими самими в абсолютному значенні.

Перед тим, як продовжити з Whirlpool coinjoins, користувач, отже, має вибір між 2 стратегіями:
- Обрати менший пул, щоб мінімізувати сервісні комісії, знаючи, що вони отримають кілька менших UTXO в результаті;
- Або віддати перевагу більшому пулу, погоджуючись платити вищі комісії, щоб в підсумку отримати меншу кількість UTXO більшої вартості.
Загалом не рекомендується об'єднувати кілька змішаних UTXO після циклів coinjoin, оскільки це може поставити під загрозу отриману конфіденційність, особливо через евристику спільного володіння входами (CIOH: *Common-Input-Ownership-Heuristic*). Тому, можливо, буде розумно обрати більший пул, навіть якщо це означає платити більше, щоб уникнути наявності занадто багатьох UTXO малої вартості як результати. Користувач має зважити ці компроміси, щоб обрати пул, який вони вважають за краще.
Окрім сервісних комісій, також мають бути враховані комісії за майнінг, притаманні будь-якій транзакції Bitcoin. Як користувач Whirlpool, вам буде потрібно заплатити комісії за майнінг для підготовчої транзакції (`Tx0`), а також для першого coinjoin. Всі наступні ремікси будуть безкоштовними, завдяки моделі Whirlpool, яка покладається на платежі нових учасників.

Дійсно, в кожному Whirlpool coinjoin, 2 користувачі серед входів є новими учасниками. Інші входи походять від реміксерів. В результаті, комісії за майнінг для всіх учасників транзакції покриваються цими 2 новими учасниками, які потім також отримають безкоштовні ремікси:

![BTC204](assets/en/54/07.webp)

Завдяки цій системі комісій, Whirlpool справді відрізняється від інших реалізацій coinjoin, оскільки anonsets UTXO не пропорційні до ціни, сплаченої користувачем. Таким чином, можливо досягти значно високих рівнів анонімності, сплачуючи лише вхідну комісію пулу та комісії за майнінг для 2 транзакцій (the `Tx0` та початковий мікс).

Важливо зауважити, що користувач також має покрити комісії за майнінг для виведення своїх UTXO з пулу після виконання їхніх численних coinjoins, якщо вони не обрали опцію `mix to`, яка дозволяє надати зовнішню адресу, яка безпосередньо отримає кошти як вихід coinjoin, без будь-якої додаткової транзакції.

### HD Wallet Accounts

Для виконання coinjoin через Whirlpool, гаманець має генерувати кілька окремих рахунків. Це принцип протоколу ZeroLink. Рахунок, у контексті HD (*Hierarchical Deterministic*) гаманця, становить секцію, повністю ізольовану від інших, ця ізоляція відбувається на третьому рівні ієрархії гаманця, тобто на рівні `xpub`.

![BTC204](assets/en/54/08.webp)

HD гаманець теоретично може похіднувати до `2^(32/2)` різних рахунків. Початковий рахунок, який використовується за замовчуванням у всіх Bitcoin гаманцях, відповідає індексу `0'`.

Для гаманців, адаптованих до Whirlpool, використовуються 4 рахунки, щоб задовольнити потреби процесу ZeroLink:
- **Рахунок депозиту**, ідентифікований індексом `0'`;
- **Рахунок поганого банку** (або "doxxic change"), ідентифікований індексом `2 147 483 644'`;
- Рахунок **premix**, ідентифікований індексом `2 147 483 645`;
- Рахунок **postmix**, ідентифікований індексом `2 147 483 646`.

Кожен з цих рахунків виконує певну функцію в процесі coinjoin, яку ми розглянемо в наступних розділах.

Всі ці рахунки пов'язані з одним seed, що дозволяє користувачу відновити доступ до всіх своїх біткоїнів, використовуючи свою фразу відновлення і, за необхідності, свій пароль. Однак, під час цієї операції відновлення, необхідно вказати програмному забезпеченню різні індекси рахунків, які були використані.

Тепер давайте розглянемо різні етапи Whirlpool coinjoin в межах цих рахунків.

### TX0

Вихідною точкою будь-якого Whirlpool coinjoin є **рахунок депозиту**. Це рахунок, який ви автоматично використовуєте, коли створюєте новий гаманець Bitcoin. На цей рахунок мають бути зараховані біткоїни, які ви хочете змішати.

`Tx0` представляє перший крок у процесі міксування Whirlpool. Його мета - підготувати та вирівняти UTXO для coinjoin, розділивши їх на одиниці, що відповідають сумі обраного пулу, щоб забезпечити однорідність міксування. Вирівняні UTXO потім надсилаються на рахунок **premix**. Що стосується різниці, яка не може увійти в пул, вона відокремлюється на специфічний рахунок: **bad bank** (або "doxxic change").

Ця початкова транзакція `Tx0` також служить для сплати сервісних зборів координатору coinjoin. На відміну від наступних кроків, ця транзакція не є спільною; користувач, отже, повинен нести всі витрати на майнінг:

![BTC204](assets/en/54/09.webp)

У цьому прикладі транзакції `Tx0`, вхід у `372 000 sats` з нашого **рахунку депозиту** ділиться на кілька вихідних UTXO, які розподіляються наступним чином:
- Сума `5 000 sats` призначена для координатора за сервісні збори, що відповідає входу в пул `100 000 sats`;
- 3 UTXO, підготовлені для міксування, перенаправляються на наш рахунок **premix** і реєструються у координатора. Ці UTXO вирівнюються по `108 000 sats` кожен, щоб покрити витрати на майнінг для їх майбутнього початкового міксу;
- Надлишок, який не може увійти в пул, будучи занадто малим, вважається токсичною зміною. Він надсилається на свій специфічний рахунок. Тут ця зміна становить `40 000 sats`;
- Нарешті, є `3,000 sats`, які не становлять вихід, але є майнінговими зборами, необхідними для підтвердження `Tx0`.
Наприклад, ось реальна транзакція Tx0 Whirlpool (не від мене): [edef60744f539483d868caff49d4848e5cc6e805d6cdc8d0f9bdbbaedcb5fc46](https://mempool.space/fr/tx/edef60744f539483d868caff49d4848e5cc6e805d6cdc8d0f9bdbbaedcb5fc46)

![BTC204](assets/notext/54/10.webp)

### Токсична Зміна

Надлишок, який не міг бути інтегрований у пул, тут еквівалентний `40,000 sats`, перенаправляється на рахунок **bad bank**, також відомий як "токсична зміна", щоб забезпечити строге відділення від інших UTXO в гаманці.
Цей UTXO є небезпечним для приватності користувача, оскільки він не лише залишається пов'язаним зі своїм минулим, а отже, можливо, з ідентичністю його власника, але й позначений як належний користувачу, який брав участь у coinjoin.
![BTC204](assets/notext/54/11.webp)

Якщо цей UTXO буде об'єднаний з перемішаними виходами, вони втратять усю приватність, отриману під час циклів coinjoin, зокрема через CIOH (*Common-Input-Ownership-Heuristic*). Якщо він буде об'єднаний з іншими токсичними змінами, користувач ризикує втратити приватність, оскільки це пов'яже різні записи з циклів coinjoin. Тому з ним потрібно поводитися обережно. Ми детальніше поговоримо про управління цими токсичними UTXO в останньому розділі цього розділу.

### Початкове Змішування

Після завершення `Tx0`, урівняні UTXO відправляються на рахунок **premix** нашого гаманця, готові до введення в їх перший цикл coinjoin, який також називається "початкове змішування". Якщо, як у нашому прикладі, `Tx0` генерує кілька UTXO, призначених для змішування, кожен з них буде інтегрований у окреме початкове змішування.

На кінці цих перших змішувань рахунок **premix** буде порожнім, тоді як наші монети, заплативши комісію за майнінг за це перше coinjoin, будуть точно скориговані до суми, визначеної обраним пулом. У нашому прикладі, наші початкові UTXO `108,000 сатоші` будуть зменшені до точно `100,000 сатоші`.

![BTC204](assets/notext/54/12.webp)

### Повторні Змішування
Після початкового змішування UTXO переводяться на рахунок **postmix**. Цей рахунок збирає як вже змішані UTXO, так і ті, що чекають на повторне змішування. Коли клієнт Whirlpool активний, UTXO на рахунку **postmix** автоматично доступні для повторного змішування і будуть випадково обрані для участі в цих нових циклах.
Нагадуємо, що повторні змішування є абсолютно безкоштовними: не потрібно додаткових сервісних або комісій за майнінг. Зберігання UTXO на рахунку **postmix** таким чином зберігає їхню недоторкану вартість і одночасно покращує їх anonsets. Тому важливо дозволити цим монетам брати участь у кількох циклах coinjoin. Це не коштує вам абсолютно нічого, і це збільшує їх рівні анонімності.

Коли ви вирішите витратити змішані UTXO, ви можете зробити це безпосередньо з цього рахунку **postmix**. Рекомендується зберігати змішані UTXO на цьому рахунку, щоб скористатися безкоштовними повторними змішуваннями та запобігти їх виходу з циклу Whirlpool, що могло б зменшити їх приватність.

### Як правильно управляти вашим postmix?

Після виконання циклів coinjoin найкраща стратегія - зберігати ваші UTXO на рахунку **postmix**, чекаючи на їх майбутнє використання. Навіть рекомендується дозволити їм повторно змішуватися нескінченно, поки вам не потрібно буде їх витратити.

Деякі користувачі можуть розглядати можливість переведення своїх змішаних біткойнів до гаманця, захищеного апаратним гаманцем. Це можливо, але важливо ретельно дотримуватися рекомендацій Samourai Wallet, щоб не поставити під загрозу отриману конфіденційність.

Об'єднання UTXO є найчастіше зробленою помилкою. Необхідно уникати комбінування змішаних UTXO з незмішаними UTXO в одній транзакції, щоб уникнути Common-Input-Ownership-Heuristic (CIOH). Це вимагає ретельного управління вашими UTXO у вашому гаманці, особливо з точки зору маркування.

![BTC204](assets/notext/54/13.webp)
Також важливо бути обережними з консолідацією змішаних UTXO між собою. Помірні консолідації можливі, якщо ваші змішані UTXO мають значні анонімні набори, але це неминуче зменшить конфіденційність ваших монет. Переконайтеся, що консолідації не є надто значними або виконані після недостатньої кількості реміксів, щоб уникнути створення виведених зв'язків між вашими UTXO до і після циклів coinjoin. У разі сумнівів щодо цих маніпуляцій, найкращою практикою є не консолідувати постміксові UTXO, а передавати їх по одному до вашого апаратного гаманця, генеруючи нову порожню адресу кожного разу. Знову ж таки, пам'ятайте належно маркувати кожен отриманий UTXO. Також не рекомендується передавати ваші постміксові UTXO до гаманця, який використовує незвичайні скрипти. Наприклад, якщо ви входите в Whirlpool з мультісіг-гаманцем, який використовує скрипти `P2WSH`, шанси змішатися з іншими користувачами, які спочатку мають такий самий тип гаманця, мінімальні. Якщо ви виведете ваш постмікс до цього ж мультісіг-гаманця, рівень приватності ваших змішаних біткойнів значно знизиться. Крім скриптів, існує багато інших відбитків гаманців, які можуть вас обдурити.

Як і в будь-якій транзакції з біткойнами, також важливо не використовувати повторно адреси отримання. Кожна нова транзакція має бути отримана на нову, порожню адресу.

Найпростішим і найбезпечнішим рішенням є залишити ваші змішані UTXO в їхньому **постмікс**-рахунку, дозволяючи їм реміксуватися і торкатися їх лише для витрати. Гаманці Samourai та Sparrow мають додаткові захисти проти всіх цих ризиків, пов'язаних з аналізом ланцюга. Ці захисти допомагають вам уникнути помилок.

### Як правильно керувати вашою токсичною здачею?

Далі, вам потрібно бути обережними у керуванні вашою токсичною здачею, здачею, яка не могла увійти в пул coinjoin. Ці токсичні UTXO, що виникають в результаті використання Whirlpool, становлять ризик для вашої приватності, оскільки вони створюють зв'язок між вами та використанням coinjoin. Тому вкрай важливо обережно з ними поводитися і не комбінувати їх з іншими UTXO, особливо змішаними UTXO.

Ось різні стратегії, які варто розглянути для їх використання:
- **Змішайте їх у менших пулах:** Якщо ваш токсичний UTXO достатньо великий, щоб увійти в менший пул самостійно, розгляньте можливість його змішування. Це часто є найкращим варіантом. Однак, об'єднання кількох токсичних UTXO для доступу до пулу не рекомендується, оскільки це може пов'язати ваші різні входи;
- **Позначте їх як "невитрачені":** Інший підхід - більше їх не використовувати, позначити як "невитрачені" у їхньому призначеному рахунку та просто зберігати. Це забезпечує, що ви випадково не витратите їх. Якщо вартість біткойна зросте, можуть з'явитися нові пули, більш підходящі для ваших токсичних UTXO;
- **Робіть пожертви:** Розгляньте можливість робити пожертви, навіть скромні, розробникам, які працюють над біткойном та його асоційованим програмним забезпеченням. Ви також можете пожертвувати організаціям, які приймають BTC. Якщо управління вашими токсичними UTXO здається занадто складним, ви можете просто позбутися їх, зробивши пожертву.
- **Купуйте подарункові картки:** Платформи, такі як [Bitrefill](https://www.bitrefill.com/), дозволяють обмінювати біткойни на подарункові картки, які можна використовувати в різних торгових точках. Це може бути спосіб позбутися ваших токсичних UTXO без втрати асоційованої вартості.
- **Консолідуйте їх на Monero:** Гаманець Samourai пропонує сервіс атомарного свопу між BTC та XMR. Це ідеально для управління токсичними UTXO, консолідуючи їх на Monero, не порушуючи вашу конфіденційність через KYC, перед тим як відправити їх назад на Bitcoin. Однак, цей варіант може бути дорогим з точки зору комісій за майнінг та премій через обмеження ліквідності.
- **Відправте їх на Lightning Network:** Переказ цих UTXO на Lightning Network для отримання переваги знижених комісій за транзакції є цікавим варіантом. Однак, цей метод може розкрити певну інформацію залежно від вашого використання Lightning і тому має бути використаний з обережністю.

### Як користуватися Whirlpool?

Після арешту засновників гаманця Samourai та конфіскації їх серверів 24 квітня 2024 року, інструмент Whirlpool більше не працює, навіть для тих, хто має власний Dojo. Раніше він був доступний у гаманці Samourai та Sparrow Wallet.

![BTC204](assets/notext/54/14.webp)

Однак, залишається можливим, що цей інструмент може бути знову запущений у найближчі тижні, залежно від результатів судових процесів, або відновлений іншим способом. У будь-якому випадку, я вважаю, що ринок coinjoin на Bitcoin не залишиться без пропозицій надовго, оскільки є чіткий попит. Більше того, модель Whirlpool, будучи найбільш просунутою з точки зору конфіденційності, напевно буде використана у майбутньому для інших реалізацій.

Ми уважно слідкуємо за розвитком цієї справи, а також за розвитком пов'язаних інструментів. Будьте впевнені, що ми оновимо цей навчальний матеріал, як тільки з'явиться нова інформація.

У наступному розділі ми дізнаємося, що таке "anonsets", як ці показники розраховуються, і як вони можуть допомогти нам оцінити ефективність циклів coinjoin.

https://planb.network/tutorials/privacy/coinjoin-sparrow-wallet

https://planb.network/tutorials/privacy/coinjoin-samourai-wallet

https://planb.network/tutorials/privacy/coinjoin-dojo

## Набори анонімності
<chapterId>be1093dc-1a74-40e5-9545-2b97a7d7d431</chapterId>

Після вивчення того, як працюють coinjoins і з якими викликами пов'язане ефективне змішування, ми тепер дізнаємося, як виміряти цю ефективність. Як визначити, чи був процес coinjoin ефективним і який ступінь анонімності отримала монета? Саме це ми дослідимо в цьому розділі з наборами анонімності або "anonsets" англійською.

### Нагадування про користь Coinjoin
Користь CoinJoin полягає в його здатності створювати правдоподібне заперечення, занурюючи вашу монету в групу невідрізнених монет. Мета цієї дії - розірвати ланцюги слідків, як з минулого в сучасне, так і з сучасного в минуле.
Іншими словами, аналітик, який знає вашу початкову транзакцію (`Tx0`) на вході циклів CoinJoin, не повинен бути в змозі із впевненістю ідентифікувати ваш UTXO на виході з циклів реміксу (аналіз від входу до виходу циклу).

![BTC204](assets/en/55/01.webp)

Навпаки, аналітик, який знає ваш UTXO на виході з циклів CoinJoin, не повинен бути в змозі визначити оригінальну транзакцію на вході циклів (аналіз від виходу до входу циклу).

![BTC204](assets/en/55/02.webp)
Для оцінки складності аналітика зв'язати минуле з теперішнім і навпаки, необхідно кількісно визначити розмір груп однорідних монет, серед яких прихована ваша монета. Цей показник говорить нам про кількість аналізів з ідентичною ймовірністю. Таким чином, якщо правильний аналіз загублений серед 3 інших аналізів з рівною ймовірністю, ваш рівень прихованості дуже низький. Однак, якщо правильний аналіз знаходиться в наборі з 20 000 аналізів, всі однаково ймовірні, ваша монета дуже добре прихована. І саме розмір цих груп представляє індикатори, які називаються "anonsets".
### Розуміння Anonsets

Anonsets служать індикаторами для оцінки ступеня приватності конкретного UTXO. Більш конкретно, вони вимірюють кількість нерозрізнених UTXO в наборі, який включає вивчену монету. Вимога однорідного набору UTXO означає, що anonsets зазвичай розраховуються за циклами CoinJoin. Використання цих індикаторів особливо актуально для Whirlpool CoinJoins через їх однорідність.

Anonsets дозволяють, за потреби, оцінити якість CoinJoins. Великий розмір anonset свідчить про високий рівень анонімності, оскільки стає важко відрізнити конкретний UTXO в однорідному наборі.

Існує 2 типи anonsets:
- **Перспективний anonset;**
- **Ретроспективний anonset.**

### Перспективний Anonset

Перспективний anonset вказує розмір групи, серед якої приховано вивчений UTXO на виході з циклу, знаючи UTXO на вході, тобто кількість нерозрізнених монет, присутніх у цій групі. Англійською назва цього індикатора - "forward anonset" або "forward-looking metrics".
Цей індикатор дозволяє виміряти стійкість приватності монети проти аналізу з минулого в теперішнє (вхід до виходу).
![BTC204](assets/en/55/03.webp)

Ця метрика оцінює, наскільки ваш UTXO захищений від спроб реконструювати його історію від точки входу до точки виходу в процесі coinjoin.

Наприклад, якщо ваша транзакція брала участь у своєму першому циклі coinjoin і було завершено два додаткові нащадкові цикли, перспективний anonset вашої монети буде `13`:

![BTC204](assets/notext/55/04.webp)

Наприклад, уявімо, що наша монета на вході в цикл coinjoin має перспективний anonset `86,871`. На практиці це означає, що вона прихована серед `86,871` нерозрізнених монет. Для зовнішнього спостерігача, який знає про цю монету на початку циклів coinjoin і намагається відстежити її вихід, він стикнеться з `86,871` можливими UTXO, кожен з ідентичною ймовірністю бути шуканою монетою.

![BTC204](assets/en/55/05.webp)

### Ретроспективний Anonset

Ретроспективний anonset вказує кількість можливих джерел для даної монети, знаючи UTXO на виході з циклу. Цей індикатор вимірює стійкість приватності монети проти аналізу з теперішнього в минуле (вихід до входу), тобто наскільки важко аналітику прослідити до походження вашої монети, до циклів coinjoin. Англійською назва цього індикатора - "backward anonset," або "backward-looking metrics."

![BTC204](assets/en/55/06.webp)

Знаючи ваш UTXO на виході з циклів, ретроспективний anonset визначає кількість потенційних транзакцій Tx0, які могли бути вашим входом у цикли coinjoin. На діаграмі нижче це відповідає сумі всіх помаранчевих бульбашок.
![BTC204](assets/notext/55/07.webp)
Наприклад, уявімо, що наша монета на виході з циклу coinjoin отримує ретроспективний anonset розміром `42,185`. На практиці це означає, що існує `42,185` потенційних джерел для цього UTXO. Якщо зовнішній спостерігач ідентифікує цю монету на кінці циклів і намагається відстежити її походження, він зіткнеться з `42,185` можливими джерелами, кожне з яких має однакову ймовірність бути шуканим походженням.

![BTC204](assets/en/55/08.webp)

### Як конкретно розрахувати anonsets?
Можливо вручну розрахувати свої anonsets, використовуючи блок-експлорер для невеликих наборів. Однак, для більших anonsets, використання спеціалізованого інструменту стає обов'язковим. На моє знання, єдине програмне забезпечення, здатне виконувати це завдання, - це *Whirlpool Stats Tool*, Python інструмент, розроблений командами Samourai та OXT. На жаль, цей інструмент наразі не працює через арешт засновників Samourai та припинення роботи OXT, яке використовувалося для витягування даних з блокчейну.
![BTC204](assets/notext/55/09.webp)

Як ми бачили в цьому розділі, anonsets можуть бути розраховані лише за умови певної однорідності у структурі coinjoins. І саме, у наступному розділі, ми дізнаємося, як кількісно оцінити цю однорідність у транзакції Bitcoin, чи то coinjoin, чи більш традиційна транзакція.

https://planb.network/tutorials/privacy/wst-anonsets

## Ентропія
<chapterId>e4fe289d-618b-49a2-84c9-68c562e708b4</chapterId>

Як ми бачили в цій частині про coinjoins, однорідність UTXO в інпутах та аутпутах відіграє важливу роль у покращенні конфіденційності транзакції Bitcoin. Цей параметр дозволяє забезпечити правдоподібне заперечення проти аналізу ланцюга. Існує кілька методів вимірювання цієї однорідності, але одним з найефективніших, на мою думку, є використання індикаторів, наданих інструментом *Boltzmann*, розробленим командами OXT та Samourai Wallet, особливо ентропії транзакції. Саме це ми детально вивчимо в цьому розділі.

На відміну від anonsets, які розраховуються за набором транзакцій, індикатори, які ми тут представимо, зосереджуються виключно на одній транзакції, чи то coinjoin, чи більш традиційна транзакція.

### Кількість інтерпретацій

Перший індикатор, який можна спостерігати на транзакції Bitcoin, - це загальна кількість можливих інтерпретацій в очах зовнішнього спостерігача, який аналізує транзакцію. Враховуючи значення UTXO, залучених у транзакцію, цей індикатор вказує кількість способів, якими інпути можуть бути асоційовані з аутпутами. Іншими словами, він визначає кількість можливих інтерпретацій, які транзакція може генерувати в потоці біткойнів з точки зору зовнішнього спостерігача, який її аналізує.

Наприклад, проста платіжна транзакція з 1 інпутом і 2 аутпутами матиме лише одну інтерпретацію, а саме що інпут #0 фінансував аутпут #0 і аутпут #1. Інших можливих інтерпретацій немає:

![BTC204](assets/notext/56/01.webp)

Натомість, coinjoin, структурований за моделлю Whirlpool 5x5, представляє $1,496$ можливих комбінацій:
![BTC204](assets/notext/56/02.webp)
Coinjoin Whirlpool Surge Cycle 8x8 представляє собою $9,934,563$ можливих інтерпретацій:

![BTC204](assets/notext/56/03.webp)

### Ентропія
З числа інтерпретацій транзакції Bitcoin можна розрахувати її ентропію.

У загальному контексті криптографії та інформації, ентропія є кількісною мірою невизначеності або непередбачуваності, пов'язаної з джерелом даних або випадковим процесом. Іншими словами, ентропія - це спосіб вимірювання того, наскільки важко передбачити або здогадатися про інформацію.

У специфічному контексті аналізу ланцюгів, ентропія також є назвою індикатора, похідного від ентропії Шеннона та [винайденого LaurentMT](https://gist.github.com/LaurentMT/e758767ca4038ac40aaf), який можна розрахувати для транзакції Bitcoin.

Коли транзакція має велику кількість можливих інтерпретацій, часто більш відповідно посилатися на її ентропію. Цей індикатор дозволяє виміряти незнання аналітиків про точну конфігурацію транзакції. Іншими словами, чим вища ентропія, тим складніше завдання ідентифікації потоків біткоїнів між входами та виходами стає для аналітиків.

На практиці, ентропія виявляє, чи має транзакція з точки зору зовнішнього спостерігача кілька можливих інтерпретацій, ґрунтуючись лише на сумах входів та виходів, не враховуючи інші зовнішні або внутрішні моделі та евристики. Висока ентропія тоді є синонімом кращої конфіденційності для транзакції.

Ентропія визначається як двійковий логарифм кількості можливих комбінацій. Ось формула, що використовується з $E$ як ентропією транзакції та $C$ як кількістю можливих інтерпретацій:

$$
E = \log_2(C)
$$

У математиці, двійковий логарифм (логарифм за основою 2) відповідає оберненій операції піднесення до степеня 2. Іншими словами, двійковий логарифм $x$ є показником степеня, до якого має бути піднесено $2$, щоб отримати $x$. Таким чином, цей індикатор виражається в бітах.

Давайте розглянемо приклад розрахунку ентропії для транзакції coinjoin, структурованої відповідно до моделі Whirlpool 5x5, яка, як зазначено в попередньому розділі, має кількість можливих інтерпретацій $1,496$:

$$
\begin{align*}
C &= 1,496 \\
E &= \log_2(1,496) \\
E &= 10.5469 \text{ біт}
\end{align*}
$$
Таким чином, ця транзакція coinjoin має ентропію $10.5469$ біт, що вважається дуже задовільним. Чим вище це значення, тим більше різних інтерпретацій допускає транзакція, тим самим підвищуючи її рівень приватності.
Для транзакції coinjoin 8x8, що має $9,934,563$ інтерпретацій, ентропія була б:

$$
\begin{align*}
C &= 9,934,563 \\
E &= \log_2(9,934,563) \\
E &= 23.244 \text{ біт}
\end{align*}
$$

Давайте розглянемо ще один приклад зі стандартною платіжною транзакцією, що має 1 вхід та 2 виходи: [1b1b0c3f0883a99f1161c64da19471841ed12a1f78e77fab128c69a5f578ccce](https://mempool.space/tx/1b1b0c3f0883a99f1161c64da19471841ed12a1f78e77fab128c69a5f578ccce)

![BTC204](assets/notext/56/04.webp)

У випадку цієї транзакції, єдина можлива інтерпретація: `(In.0) > (Out.0 ; Out.1)`. Відповідно, її ентропія встановлена на $0$:
### Ефективність

З ентропії транзакції ми також можемо розрахувати її ефективність з точки зору приватності. Цей показник оцінює ефективність транзакції, порівнюючи її з оптимальною транзакцією, що можлива в ідентичній конфігурації.

Це приводить нас до обговорення концепції максимальної ентропії, яка відповідає найвищій ентропії, яку конкретна структура транзакції теоретично може досягти. Ефективність транзакції потім розраховується шляхом порівняння цієї максимальної ентропії з фактичною ентропією аналізованої транзакції.

Формула використовується наступна:
- $E_R$: фактична ентропія транзакції, виражена в бітах;
- $E_M$: максимально можлива ентропія для структури транзакції, також виражена в бітах;
- $Ef$: ефективність транзакції в бітах:

$$
Ef = E_R - E_M
$$

Наприклад, для структури монетного з'єднання типу Whirlpool 5x5 максимальна ентропія становить $10.5469$:

$$
\begin{align*}
E_R &= 10.5469 \\
E_M &= 10.5469 \\
Ef &= E_R - E_M \\
Ef &= 10.5469 - 10.5469 \\
Ef &= 0 \text{ біт}
\end{align*}
$$

Цей показник також виражається у відсотках. Формула використовується наступна:
- $C_R$: кількість можливих реальних інтерпретацій;
- $C_M$: максимальна кількість можливих інтерпретацій з тією ж структурою;
- $Ef$: ефективність, виражена у відсотках:

$$
\begin{align*}
E_f &= \frac{C_R}{C_M} \\
E_f &= \frac{1\,496}{1\,496} \\
E_f &= 100\%
\end{align*}
$$

Таким чином, ефективність у $100\%$ вказує на те, що транзакція максимізує свій потенціал для приватності на основі своєї структури.

### Щільність Ентропії

Ентропія є хорошим показником для вимірювання приватності транзакції, але вона частково залежить від кількості входів та виходів у транзакції. Для порівняння ентропії 2 різних транзакцій, які не мають однакової кількості входів та виходів, можна розрахувати щільність ентропії. Цей показник пропонує перспективу щодо ентропії відносно кожного входу або виходу транзакції. Щільність корисна для оцінки та порівняння ефективності транзакцій різного розміру.

Для розрахунку просто поділіть загальну ентропію транзакції на загальну кількість входів та виходів, залучених у транзакцію:
- $E_D$: щільність ентропії, виражена в бітах;
- $E$: ентропія транзакції, виражена в бітах;
- $T$: загальна кількість входів та виходів у транзакції:

$$
E_D = \frac{E}{T}
$$

Давайте розглянемо приклад монетного з'єднання Whirlpool 5x5:

$$
\begin{align*}
T &= 5 + 5 = 10 \\
E &= 10.5469 \\
E_D &= \frac{E}{T} \\
E_D &= \frac{10.5469}{10} \\
E_D &= 1.054 \text{ біт}
\end{align*}
$$

Також розрахуємо щільність ентропії монетного з'єднання Whirlpool 8x8:

$$
\begin{align*}
T &= 8 + 8 = 16 \\
E &= 23.244 \\
E_D &= \frac{E}{T} \\
E_D &= \frac{23.244}{16} \\
$$
E_D &= 1.453 \text{ біти}\end{align*}
$$

Аналізуючи густину ентропії цих двох типів coinjoin, стає очевидним, що, навіть нормалізуючи ентропію за кількістю елементів, coinjoin "Surge Cycle 8x8" генерує більше невизначеності для аналізу.

### Оцінка Больцмана
Іншим елементом, який аналізується в транзакції, є оцінка Больцмана кожного елемента відносно іншого. Це таблиця ймовірностей співставлення між входами та виходами. Ця таблиця вказує, через оцінку Больцмана, умовну ймовірність того, що певний вхід пов'язаний з данним виходом. Таким чином, це кількісна міра умовної ймовірності асоціації між входом та виходом у транзакції, заснована на співвідношенні кількості сприятливих випадків цієї події до загальної кількості можливих випадків у наборі інтерпретацій.
Беручи за приклад Whirlpool coinjoin, таблиця умовних ймовірностей підкреслить шанси зв'язку між кожним входом та виходом, надаючи кількісну міру невизначеності асоціацій у транзакції:

| %       | Вихід 0 | Вихід 1 | Вихід 2 | Вихід 3 | Вихід 4 |
| ------- | -------- | -------- | -------- | -------- | -------- |
| Вхід 0 | 34%      | 34%      | 34%      | 34%      | 34%      |
| Вхід 1 | 34%      | 34%      | 34%      | 34%      | 34%      |
| Вхід 2 | 34%      | 34%      | 34%      | 34%      | 34%      |
| Вхід 3 | 34%      | 34%      | 34%      | 34%      | 34%      |
| Вхід 4 | 34%      | 34%      | 34%      | 34%      | 34%      |

Тут очевидно, що кожен вхід має рівний шанс бути асоційованим з будь-яким виходом, що підвищує конфіденційність транзакції.

Розрахунок оцінки Больцмана включає ділення кількості інтерпретацій, в яких певна подія проявляється, на загальну кількість доступних інтерпретацій. Таким чином, для визначення оцінки асоціації входу №0 з виходом №3 (подія, присутня в 512 інтерпретаціях), процес наступний:

$$
\begin{align*}
\text{Інтерпретації (ВХ.0 > ВИХ.3)} &= 512 \\
\text{Загальна кількість інтерпретацій} &= 1496 \\
\text{Оцінка} &= \frac{512}{1496} \\
\text{Оцінка} &= 34 \%
\end{align*}
$$

Якщо ми повернемося до прикладу Whirlpool coinjoin 8x8 Surge Cycle, таблиця Больцмана виглядатиме так:

|       | ВИХ.0 | ВИХ.1 | ВИХ.2 | ВИХ.3 | ВИХ.4 | ВИХ.5 | ВИХ.6 | ВИХ.7 |
|-------|-------|-------|-------|-------|-------|-------|-------|-------|
| ВХ.0  | 23%   | 23%   | 23%   | 23%   | 23%   | 23%   | 23%   | 23%   |
| IN.1  | 23%   | 23%   | 23%   | 23%   | 23%   | 23%   | 23%   | 23%   |
| IN.2  | 23%   | 23%   | 23%   | 23%   | 23%   | 23%   | 23%   | 23%   |
| IN.3  | 23%   | 23%   | 23%   | 23%   | 23%   | 23%   | 23%   | 23%   |
| IN.4  | 23%   | 23%   | 23%   | 23%   | 23%   | 23%   | 23%   | 23%   |
| IN.5  | 23%   | 23%   | 23%   | 23%   | 23%   | 23%   | 23%   | 23%   |
| IN.6  | 23%   | 23%   | 23%   | 23%   | 23%   | 23%   | 23%   | 23%   |
| IN.7  | 23%   | 23%   | 23%   | 23%   | 23%   | 23%   | 23%   | 23%   |

Однак, у випадку простої транзакції з одним входом і двома виходами, ситуація інша:

| %       | Вихід 0 | Вихід 1 |
|---------|---------|---------|
| Вхід 0  | 100%    | 100%    |

Тут ми спостерігаємо, що ймовірність кожного виходу походити від входу №0 становить 100%. Таким чином, нижча ймовірність перекладається на більшу приватність, розмиваючи прямі зв'язки між входами та виходами.

### Детерміновані зв'язки

Також можливо розрахувати кількість детермінованих зв'язків у транзакції. Цей показник виявляє, скільки з'єднань між входами та виходами в аналізованій транзакції є беззаперечними, з ймовірністю 100%. Цей показник можна доповнити, розрахувавши співвідношення детермінованих зв'язків. Співвідношення дає перспективу щодо ваги цих детермінованих зв'язків серед усіх зв'язків транзакції.

Наприклад, транзакція типу Whirlpool-coinjoin показує відсутність детермінованого зв'язку між входами та виходами, тим самим відображаючи показник 0 зв'язків і співвідношення 0%. Навпаки, у нашій другій розглянутій простій платіжній транзакції (з одним входом і 2 виходами) показник повідомляє нам, що є 2 детерміновані зв'язки, і співвідношення досягає 100%. Таким чином, нульовий показник сигналізує про відмінну приватність завдяки відсутності прямих і беззаперечних зв'язків між входами та виходами.

### Як розрахувати ці показники?
Розрахунок цих показників вручну за допомогою наданих мною рівнянь є відносно простим. Основна складність полягає у визначенні кількості можливих інтерпретацій транзакції. Для стандартної транзакції цей розрахунок можна виконати вручну. Однак, для coinjoin завдання значно складніше.

Раніше існував інструмент Python під назвою _Boltzmann Calculator_, розроблений командами OXT та Samourai, який дозволяв автоматично розраховувати всі ці показники для транзакції Bitcoin:

![BTC204](assets/notext/56/05.webp)

Також можна було використовувати вебсайт KYCP.org для цих аналізів:

![BTC204](assets/notext/56/06.webp)
На жаль, після арешту засновників Samourai ці інструменти наразі не функціонують.
Тепер, коли ми детально обговорили coinjoins, ми розглянемо інші техніки забезпечення приватності, доступні в Bitcoin, у останньому розділі нашого навчання. Ми розглянемо payjoins, специфічні типи транзакцій pseudo-coinjoins, протоколи зі статичними адресами, а також заходи, спрямовані на підвищення приватності не на рівні транзакцій, а на рівні мережі вузлів.

https://planb.network/tutorials/privacy/boltzmann-entropy

# Розуміння значення інших передових технік забезпечення приватності
<partId>19989ae6-d608-4acf-b698-2cf1e7e5e6ae</partId>

## Транзакції Payjoin
<chapterId>c1e90b95-f709-4574-837b-2ec26b11286f</chapterId>

Наразі coinjoin представляє найефективніший метод внесення невизначеності у відстеження монет під час аналізу ланцюга. Як ми бачили в попередніх розділах, для досягнення ефективного змішування необхідно, щоб вхідні та вихідні дані були якомога більш однорідними. Більше того, критично важливо, щоб монети були інтегровані в якомога більшу групу, щоб максимізувати anonsets. Таким чином, для ефективності coinjoins вони повинні включати велику кількість однорідних монет. Ця множина вимог означає, що транзакції coinjoin мають дуже жорстку структуру: суми визначені заздалегідь, і всі учасники повинні дотримуватися їх, щоб забезпечити однорідність процесу. Крім того, coinjoins вимагають синхронізації між усіма учасниками та координатором під час побудови транзакції.
Ці вимоги роблять coinjoin непридатними для прямих платежів. Наприклад, якщо ви володієте 1M sats часткою в пулі coinjoin, використання її безпосередньо як платіж було б складним. Це вимагало б синхронізації з іншими учасниками та координатором для точної побудови спільної транзакції саме в момент, коли вам потрібно здійснити платіж, і сума покупки повинна була б точно відповідати вартості вашої частки, що практично неможливо. Таким чином, транзакція coinjoin за своєю суттю є спільною транзакцією на вибирання, що означає, що зазвичай ті самі власники входів знаходяться в виходах.
Однак було б цікаво мати структури транзакцій, які дозволяли б практичні платежі, водночас вносячи сумнів у аналіз ланцюга. Саме це ми і дослідимо в цьому та наступному розділах.

### Що таке транзакція Payjoin?

Payjoin - це специфічна структура транзакції Bitcoin, яка підвищує приватність користувача під час витрати шляхом співпраці з одержувачем платежу.

Цей метод вперше був згаданий LaurentMT у 2015 році під назвою "*стеганографічні транзакції*", згідно з документом, доступним [тут](https://gist.githubusercontent.com/LaurentMT/e758767ca4038ac40aaf/raw/c8125f6a3c3d0e90246dc96d3b603690ab6f1dcc/gistfile1.txt). Ця техніка пізніше була прийнята гаманцем Samourai, який у 2018 році став першим клієнтом, що реалізував її за допомогою інструменту Stowaway. Концепція payjoin також знайдена в [BIP79](https://github.com/bitcoin/bips/blob/master/bip-0079.mediawiki) та [BIP78](https://github.com/bitcoin/bips/blob/master/bip-0078.mediawiki). Таким чином, кілька термінів використовуються для позначення payjoin:
- Payjoin;
- Stowaway;
- P2EP (*Pay-to-End-Point*);
- Стеганографічна транзакція.
Особливість payjoin полягає в його здатності генерувати транзакцію, яка на перший погляд виглядає звичайною, але насправді є міні Coinjoin між двома людьми. Для цього структура транзакції залучає одержувача платежу до входів поряд з фактичним відправником. Таким чином, одержувач включає платіж собі в середину транзакції, що дозволяє йому отримати оплату.
Давайте розглянемо приклад, щоб краще зрозуміти цей процес. Аліса купує багет за 4,000 sats, використовуючи UTXO на 10,000 sats і обирає payjoin. Її пекар, Боб, додає UTXO на 15,000 sats, яке належить йому на вхід, яке він повністю отримує на виході, додатково до 4,000 sats Аліси.

![BTC204](assets/notext/61/01.webp)
У цьому прикладі Боб-пекар вносить 15,000 sats і виходить з 19,000 sats, різниця точно становить 4,000 sats, що є ціною багета. З боку Аліси, вона входить з 10,000 sats і закінчує з 6,000 sats на виході, що представляє баланс -4,000 sats, а саме ціну багета. Для спрощення прикладу я навмисно опустив комісію за майнінг у цій транзакції.

### Яка мета payjoin?

Транзакція payjoin досягає двох цілей, які дозволяють користувачам покращити приватність своїх платежів.

По-перше, payjoin має на меті ввести в оману зовнішнього спостерігача, створюючи відволікаючий маневр у аналізі ланцюга. Це стає можливим завдяки евристиці CIOH (*Common Input Ownership Heuristic*). Як ми бачили в частині 3, зазвичай, коли транзакція в блокчейні має кілька входів, припускається, що всі ці входи належать одній особі або користувачу.

Таким чином, коли аналітик розглядає транзакцію payjoin, він приходить до висновку, що всі входи походять від однієї особи. Однак, це сприйняття є неправильним, оскільки одержувач платежу також вносить свій вклад у входи поряд з фактичним платником. Таким чином, аналіз ланцюга відхиляється до інтерпретації, яка виявляється хибною.

Повернімося до нашого прикладу транзакції payjoin за оплату багета:

![BTC204](assets/notext/61/02.webp)

Бачачи цю транзакцію в блокчейні, зовнішній спостерігач, який слідує звичайним евристикам аналізу ланцюга, інтерпретував би її так: "*Аліса об'єднала 2 UTXOs на входах транзакції, щоб заплатити 19,000 sats Бобу*".

![BTC204](assets/en/61/03.webp)

Ця інтерпретація, очевидно, неправильна, як ви вже знаєте, два UTXOs на входах не належать одній особі. Один походить від Аліси, покупця багета, а інший від Боба, пекаря.

![BTC204](assets/notext/61/04.webp)

Таким чином, аналіз зовнішнього спостерігача спрямований до неправильного висновку, що забезпечує збереження конфіденційності учасників.

### Стеганографічна транзакція

Друга мета payjoin - обдурити зовнішнього спостерігача щодо фактичної суми платежу, який був здійснений. Аналізуючи структуру транзакції, аналітик може вважати, що платіж еквівалентний сумі одного з виходів.
Якщо ми повернемося до нашого прикладу з купівлею багета, аналітик подумає, що сума платежу відповідає або UTXO в 6,000 сатоші, або UTXO в 19,000 сатоші. У цьому випадку аналітик, швидше за все, подумає, що сума платежу становить 19,000 сатоші, оскільки в виходах є 2 UTXO, принаймні один з яких більший за 6,000 сатоші (немає логічної причини використовувати 2 UTXO для оплати 6,000 сатоші, коли одного UTXO було б достатньо для цього платежу). ![BTC204](assets/en/61/05.webp)

Але насправді цей аналіз невірний. Сума платежу не відповідає жодному з виходів. Насправді це різниця між UTXO одержувача у виході та UTXO одержувача на вході.

![BTC204](assets/en/61/06.webp)

У цьому випадку транзакція payjoin потрапляє в сферу стеганографії. Вона дозволяє приховувати реальну суму транзакції в межах фальшивої транзакції, яка виступає як відволікаючий маневр.

Стеганографія - це техніка приховування інформації в інших даних або об'єктах таким чином, що присутність прихованої інформації не є помітною. Наприклад, секретне повідомлення може бути приховане всередині крапки в тексті, який не пов'язаний, роблячи його невиявним для неозброєного ока (це техніка [micropoint](https://fr.wikipedia.org/wiki/Micropoint)).

На відміну від шифрування, яке робить інформацію незрозумілою без ключа дешифрування, стеганографія не змінює інформацію. Вона залишається на виду. Її мета - приховати сам факт існування секретного повідомлення, тоді як шифрування явно вказує на присутність прихованої інформації, хоча і недоступної без ключа. Саме тому початкова назва для payjoin була "*стеганографічні транзакції*".

Аналогію можна провести між криптографією та coinjoin, а також між стеганографією та payjoin. Дійсно, coinjoin має атрибути, схожі на ті, що має шифрування: метод розпізнаваний, але інформація нерозбірлива. Навпаки, payjoin схожий на стеганографію: інформація теоретично доступна, але оскільки її метод приховування не розпізнаваний, вона стає недоступною.

### Як користуватися payjoin?

Серед відомого програмного забезпечення, яке підтримує payjoin, є Sparrow Wallet, Wasabi Wallet, Mutiny, BitMask, BlueWallet та JoinMarket, а також платіжний процесор BTCPay.

![BTC204](assets/notext/61/07.webp)
Найбільш розвиненою реалізацією payjoin був лише Stowaway на Samourai Wallet. Однак, після арешту засновників програмного забезпечення, цей інструмент зараз працює лише частково. Перевага Stowaway полягає в тому, що це повний і дуже простий у використанні протокол, який підтримує як отримання, так і відправлення payjoins. Частково підписані транзакції можуть бути обмінені вручну шляхом сканування кількох QR-кодів або автоматично через Tor за допомогою Soroban. Саме цей останній варіант зв'язку зараз не працює.
![BTC204](assets/notext/61/08.webp)

Складність використання payjoin полягає в її залежності від участі продавця. Як покупець, використання payjoin неможливе, якщо продавець його не підтримує. Це додає додаткову складність під час покупки: не тільки складно знайти продавців, які приймають біткойни, але якщо шукати тих, хто підтримує payjoins, це стає ще складніше.
Рішенням може бути використання транзакційних структур, які вносять невизначеність у аналіз ланцюга без необхідності співпраці з одержувачем. Це дозволить нам покращити конфіденційність наших платежів без залежності від активної участі торговців. Саме це ми й вивчатимемо в наступному розділі.
https://planb.network/tutorials/privacy/payjoin-sparrow-wallet

https://planb.network/tutorials/privacy/payjoin-samourai-wallet

## Міні-Койнджойни Платежів
<chapterId>300777ee-30ae-43d7-ab00-479dac3522c1</chapterId>

Коли ви шукаєте спосіб здійснити платіжну транзакцію, зберігаючи певний ступінь конфіденційності, payjoin є хорошим варіантом. Але, як ми вже бачили, payjoin вимагає участі одержувача. Що робити, якщо останній відмовляється брати участь у payjoin, або якщо ви просто віддаєте перевагу не залучати його? Альтернативою може бути використання транзакції Stonewall або Stonewall x2. Давайте детальніше розглянемо ці два типи транзакцій.

### Транзакція Stonewall

Stonewall - це специфічна форма транзакції Bitcoin, спрямована на збільшення конфіденційності користувача під час витрати, імітуючи псевдо-койнджойн між двома людьми, не будучи насправді таким. Дійсно, ця транзакція не є співпрацюючою. Користувач може сконструювати її самостійно, використовуючи лише UTXO, які належать йому, як входи. Таким чином, ви можете створити транзакцію Stonewall для будь-якої події, не потребуючи синхронізації з іншим користувачем або одержувачем.

Принцип дії транзакції Stonewall наступний: на вході транзакції відправник використовує 2 UTXO, які належать йому. На виході транзакція створює 4 UTXO, 2 з яких будуть точно однакового розміру. Інші 2 UTXO будуть являти собою решту. Серед 2 виходів однакового розміру лише один насправді піде одержувачу платежу.
У транзакції Stonewall є лише 2 ролі:
- Відправник, який здійснює платіж;
- Одержувач, який може не знати про специфічну природу транзакції і просто чекає на платіж від відправника.

Давайте розглянемо приклад, щоб зрозуміти цю структуру транзакції. Аліса прийшла до Боба-пекаря купити свою багету, яка коштує 4,000 сатоші. Вона хоче заплатити біткоїнами, зберігаючи певний рівень конфіденційності щодо свого платежу. Тому вона вирішує сконструювати транзакцію Stonewall для платежу.

![BTC204](assets/notext/62/01.webp)

Аналізуючи цю транзакцію, ми можемо побачити, що Боб-пекар дійсно отримав 4,000 сатоші в оплату за багету. Аліса використала 2 UTXO як входи: один на 10,000 сатоші та один на 15,000 сатоші. На виході вона отримала 3 UTXO: один на 4,000 сатоші, один на 6,000 сатоші та один на 11,000 сатоші. Таким чином, Аліса має чистий баланс -4,000 сатоші на цій транзакції, що відповідає точно ціні багети.

У цьому прикладі я навмисно не врахував комісію за майнінг для спрощення розуміння. Насправді, комісія за транзакцію повністю лягає на плечі відправника.

### Які цілі транзакції Stonewall?
Структура Stonewall додає багато ентропії до транзакції та затуманює сліди аналізу ланцюга. Ззовні таку транзакцію можна інтерпретувати як міні-coinjoin між двома людьми. Але насправді це платіж. Таким чином, цей метод створює невизначеності в аналізі ланцюга, або навіть призводить до помилкових слідів.
Повернімося до прикладу з Алісою у пекарні Боба. Транзакція в блокчейні виглядала б так:

![BTC204](assets/notext/62/02.webp)

Зовнішній спостерігач, який покладається на загальноприйняті евристики аналізу ланцюга, може помилково зробити висновок, що "*дві людини зробили маленький coinjoin, з одним UTXO кожен на вході та двома UTXO кожен на виході*". Аналіз цієї транзакції ззовні не призводить до застосування евристики спільного володіння входами (CIOH), тому що наявність двох виходів однакової суми вказує на схему coinjoin. З зовнішньої точки зору, CIOH тому не застосовується в цьому конкретному випадку.

![BTC204](assets/notext/62/03.webp)

Ця інтерпретація неправильна, тому що, як ви знаєте, один UTXO було відправлено Бобу-пекарю, 2 UTXO на входах прийшли від Аліси, і вона отримала 3 виходи з рештою.

![BTC204](assets/notext/62/04.webp)
І що особливо цікаво в структурі транзакції Stonewall, так це те, що з точки зору зовнішнього спостерігача, вона виглядає точно так само, як транзакція Stonewall x2.

### Транзакція Stonewall x2

Stonewall x2 - це інша конкретна форма транзакції Bitcoin, яка також має на меті збільшення конфіденційності користувача під час витрати, але цього разу шляхом співпраці з третьою стороною, яка не бере участі у витраті. Цей метод працює як псевдо-coinjoin між двома учасниками, одночасно роблячи платіж третій особі.

Робота транзакції Stonewall x2 відносно проста: один використовує UTXO у своєму володінні для здійснення платежу та звертається по допомогу до третьої сторони, яка також вносить UTXO, яким володіє. Транзакція закінчується чотирма виходами: два з них однакових сум, один призначений для адреси одержувача платежу, інший - для адреси співпрацівника. Третій UTXO відправляється на іншу адресу співпрацівника, дозволяючи їм відновити початкову суму (нейтральна дія для них, мінус комісія за майнінг), і останній UTXO повертається на адресу, що належить нам, що становить решту платежу.

Таким чином, у транзакціях Stonewall x2 визначаються три різні ролі:
- Відправник, який робить фактичний платіж;
- Одержувач, який може не знати про конкретну природу транзакції і просто чекає платежу від відправника;
- Співпрацівник, який надає біткоїни для внесення сумнівів у аналіз транзакції, одночасно повністю відновлюючи свої кошти в кінці (нейтральна дія для них, мінус комісія за майнінг).

Повернімося до нашого прикладу з Алісою, яка перебуває у пекарні Боба, щоб купити свою багету, яка коштує 4,000 сатоші. Вона хоче заплатити біткоїнами, зберігаючи певний рівень конфіденційності свого платежу. Тож вона звертається до свого друга Чарльза, який допоможе їй у цьому процесі.

![BTC204](assets/notext/62/05.webp)
Аналізуючи цю транзакцію, ми можемо побачити, що Боб-пекар дійсно отримав 4,000 сатоші в якості оплати за багет. Аліса використала 10,000 сатоші на вхід і отримала 6,000 сатоші на виході, що призвело до чистого балансу -4,000 сатоші, що відповідає ціні багета. Що стосується Чарльза, то він надав 15,000 сатоші на вхід і отримав два виходи: один по 4,000 сатоші та інший по 11,000 сатоші, що дає баланс 0.
У цьому прикладі я навмисно не врахував комісії, щоб полегшити розуміння. Насправді, комісії за майнінг, як правило, діляться порівну між відправником платежу та співпрацівником.

### Які цілі транзакції Stonewall x2?
Як і структура Stonewall, структура Stonewall x2 додає значну кількість ентропії до транзакції та затемнює сліди аналізу ланцюга. З зовнішньої точки зору, таку транзакцію можна інтерпретувати як невеликий coinjoin між двома людьми. Але насправді це платіж. Таким чином, цей метод створює невизначеності в аналізі ланцюга, навіть призводячи до помилкових слідів.

Давайте повернемося до прикладу з Алісою, Бобом-пекарем та Чарльзом. Транзакція в блокчейні виглядала б так:

![BTC204](assets/notext/62/06.webp)

Зовнішній спостерігач, який покладається на загальноприйняті евристики аналізу ланцюга, може помилково зробити висновок, що "*Аліса та Чарльз провели невеликий coinjoin, з одним UTXO кожен на вході та двома UTXO кожен на виході*". Знову ж таки, аналіз цієї транзакції ззовні не призводить до застосування евристики спільного володіння входом (CIOH), оскільки наявність двох виходів однакової суми вказує на схему coinjoin. Таким чином, з зовнішньої точки зору, CIOH не застосовується в цьому конкретному випадку.

![BTC204](assets/notext/62/07.webp)

Ця інтерпретація є неточною, оскільки, як ви знаєте, один UTXO було відправлено Бобу-пекарю, Аліса має лише один вихідний залишок, а Чарльз має два.

![BTC204](assets/notext/62/08.webp)

І знову ж таки, особливо цікаво, що структура транзакції Stonewall x2 з точки зору зовнішнього спостерігача виглядає точно так само, як і структура транзакції Stonewall.

### У чому різниця між Stonewall та Stonewall x2?

Транзакція StonewallX2 працює точно так само, як і транзакція Stonewall, за винятком того, що перша є колаборативною, тоді як друга - ні. Як ми бачили, транзакція Stonewall x2 передбачає участь третьої сторони (Чарльза), яка є зовнішньою по відношенню до платежу, і яка надає свої біткоїни для підвищення конфіденційності транзакції. У класичній транзакції Stonewall роль співпрацівника виконує відправник.

![BTC204](assets/notext/62/09.webp)

З зовнішньої точки зору, схема транзакції, отже, абсолютно та сама.

![BTC204](assets/notext/62/10.webp)

Той факт, що ці дві структури транзакцій мають абсолютно однакову схему, означає, що навіть якщо зовнішній спостерігач зможе ідентифікувати "Stonewall(x2)" схему, вони не матимуть всієї інформації. Вони не зможуть визначити, який з двох UTXO однакових сум відповідає платежу. Більше того, вони не зможуть визначити, чи два UTXO на входах походять від двох різних людей (Stonewall x2) чи належать одній особі, яка їх об'єднала (Stonewall).
Ця остання точка пов'язана з тим, що транзакції Stonewall x2 слідують точно такому ж шаблону, як і транзакції Stonewall. Ззовні і без додаткової інформації про контекст неможливо відрізнити транзакцію Stonewall від транзакції Stonewall x2. Однак, перші не є співпрацюючими транзакціями, тоді як останні є такими. Це додає ще більше сумнівів у аналіз однієї з цих транзакцій.
### Коли використовувати транзакції Stonewall і Stonewall x2?

Логіка повинна бути такою, коли ви хочете використати інструмент конфіденційності для транзакції:
- Як пріоритет, можна вибрати здійснення payjoin;
- Якщо продавець не підтримує payjoins, можна зробити співпрацюючу транзакцію з іншою особою поза платежем, використовуючи структуру Stonewall x2;
- Якщо нікого не знайдено для здійснення транзакції Stonewall x2, можна зробити транзакцію Stonewall самостійно, яка імітуватиме поведінку транзакції Stonewall x2.

### Як використовувати транзакції Stonewall і Stonewall x2?

Транзакції Stonewall і Stonewall x2 доступні як у додатку Samourai Wallet, так і в програмному забезпеченні Sparrow Wallet.

![BTC204](assets/notext/62/11.webp)

Однак, як і у випадку з payjoins, після арешту засновників Samourai, транзакції Stonewall x2 тепер працюють лише шляхом ручного обміну PSBT між залученими сторонами. Автоматичний обмін через Soroban, на жаль, наразі недоступний.

Також можливо вручну виконати цей тип транзакції з будь-якого програмного забезпечення для Bitcoin гаманця.

У наступному розділі ми вивчимо іншу техніку конфіденційності, яка відносно невідома, але дуже корисна на додаток до того, що ми вже вивчили.

https://planb.network/tutorials/privacy/stonewall

https://planb.network/tutorials/privacy/stonewall-x2

## Рикошети

<chapterId>db9a20ac-a149-443d-884b-ea6c03f28499</chapterId>

Використання структур Bitcoin транзакцій, які додають невизначеність у аналізі ланцюга, таких як coinjoin, є особливо корисним для захисту конфіденційності. Однак, як ми обговорювали в розділі про payjoins, транзакції coinjoin природно ідентифікуються в ланцюгу. Пам'ятайте аналогію, яку ми встановили між шифруванням і coinjoins: коли хтось шифрує файл, третя сторона, виявивши цей зашифрований файл, не може отримати доступ до його вмісту, але може чітко ідентифікувати, що була змінена форма файлу, щоб приховати його вміст. Те ж саме стосується coinjoin: коли аналітик розглядає транзакцію coinjoin, хоча вони не можуть встановити прямі зв'язки між входами та виходами (і навпаки), вони все ж можуть визнати, що спостережувана транзакція є coinjoin.
Залежно від призначення вашої монети після проходження циклів coinjoin, факт проходження цього процесу може бути проблематичним. Наприклад, якщо ви плануєте продати свою монету на регульованій платформі обміну, але вона нещодавно пройшла через coinjoin, інструмент аналізу ланцюга платформи виявить цей факт. Платформа може тоді відмовити прийняти ваш UTXO, який пройшов через coinjoin, або навіть вимагати пояснень від вас, з ризиком мати ваш обліковий запис призупинений або ваші кошти заморожені. У деяких випадках платформа також може повідомити про вашу поведінку державним органам (наприклад, це те, що TRACFIN вимагає від Постачальників Послуг Цифрових Активів (PSAN) у Франції).
![BTC204](assets/notext/63/01.webp)
Щоб уникнути цього, нам потрібен інструмент, здатний замаскувати сліди минулого біткойна, щоб відновити певну форму фунгібільності. Саме це і є метою рикошету.
![BTC204](assets/notext/63/02.webp)

### Що таке рикошет?

Рикошет - це техніка, яка передбачає проведення кількох фіктивних транзакцій на самого себе (переміщення) для імітації передачі власності на біткойни. Цей інструмент відрізняється від інших структур транзакцій, про які ми говорили, тим, що він не забезпечує потенційну анонімність, а скоріше форму ретроспективної анонімності. Дійсно, рикошет дозволяє замаскувати специфіку, яка могла б скомпрометувати фунгібільність біткойна через його минуле.

Щоб замаскувати відбиток, залишений минулою подією на монеті, наприклад, циклами coinjoin, рикошет виконує чотири послідовні транзакції, де користувач переводить кошти сам на себе на різні адреси.

![BTC204](assets/en/63/03.webp)

Після цієї послідовності транзакцій інструмент рикошету нарешті направляє біткойни до їх кінцевого пункту призначення, наприклад, на платформу обміну.

![BTC204](assets/en/63/04.webp)

Мета полягає в створенні дистанції, яка впливає на фунгібільність монети, такої як транзакція coinjoin, і кінцевий акт витрати, який міг би відхилити цю монету через її минуле. Таким чином, інструменти аналізу ланцюгів можуть зробити висновок, що, ймовірно, сталася зміна власності після події, і вважати, що ця монета є фунгібільною. У випадку з coinjoin інструменти аналізу ланцюгів можуть тоді припустити, що це не та сама особа, яка відправила біткойни і виконала coinjoin, і тому немає необхідності ініціювати дії проти відправника.

![BTC204](assets/notext/63/05.webp)

### Чому це працює?
Зіткнувшись з цим методом рикошету, можна уявити, що програмне забезпечення для аналізу ланцюгів могло б поглибити своє дослідження за межі чотирьох стрибків. Однак ці платформи стикаються з дилемою оптимізації порогу виявлення. Вони повинні встановити ліміт кількості стрибків, після яких вони визнають, що, ймовірно, сталася зміна власності, і зв'язок з попередньою подією (такою як coinjoin) слід ігнорувати.
![BTC204](assets/en/63/06.webp)

Однак визначення цього порогу є ризикованим: кожне розширення спостережуваної кількості стрибків експоненційно збільшує обсяг хибнопозитивних результатів, тобто осіб, помилково позначених як учасників події, коли операцію проводив хтось інший. Цей сценарій становить великий ризик для цих компаній, оскільки хибнопозитивні результати призводять до незадоволення, яке може спонукати постраждалих клієнтів перейти до конкуренції. У довгостроковій перспективі занадто широкий поріг виявлення призводить до того, що платформа втрачає більше клієнтів, ніж її конкуренти, що може загрожувати її життєздатності. Тому для цих платформ складно збільшити кількість спостережуваних стрибків, і чотири часто є достатньою кількістю для протидії їх аналізам.

Спостережуване тут явище дещо аналогічне теорії шести ступенів відокремлення.

Теорія шести ступенів відокремлення припускає, що будь-яка людина на Землі пов'язана з будь-якою іншою через ланцюг знайомств, який включає не більше шести посередників. Було б достатньо пройти через серію шести людей, кожен з яких особисто знає наступного, щоб досягти будь-якої особи у світі.

Для біткойн-транзакцій спостерігається подібне явище. Простеживши достатню кількість біткойн-транзакцій, неминуче натрапляєш на coinjoin. Метод рикошету використовує цей принцип, використовуючи кількість стрибків, більшу, ніж платформи обміну можуть розумно відстежити. Якщо платформи вирішать відстежувати більше транзакцій, тоді можна просто додати додатковий стрибок, щоб обійти цей захід.

### Коли і як використовувати рикошет?
Найпоширенішим випадком використання ricochet є необхідність приховати попередню участь у coinjoin на UTXO, яке ви володієте. Ідеально краще уникати передачі біткойнів, які брали участь у coinjoin, регульованим суб'єктам. Проте, у випадку, коли іншого вибору немає, особливо у терміновій потребі конвертувати біткойни в фіатну валюту, ricochet пропонує ефективне рішення.
Цей метод ефективний не тільки для coinjoins, але й для будь-якої іншої мітки, яка може порушити функціональність монети.
Ідея цього методу ricochet спочатку виникла у команд Samourai Wallet, які інтегрували його у свій додаток для автоматизації процесу. Сервіс є платним на Samourai, оскільки ricochet передбачає плату за послугу у розмірі 100,000 sats, на додаток до плати за майнінг. Таким чином, його використання рекомендується скоріше для переказів значних сум.

![BTC204](assets/notext/63/07.webp)

Додаток Samourai пропонує два варіанти ricochet:
- Покращений ricochet, або "послідовна доставка", який має перевагу розподілу плати за послуги Samourai на п'ять послідовних транзакцій. Цей варіант також забезпечує, що кожна транзакція транслюється в різний час і записується в різний блок, що дозволяє максимально точно імітувати поведінку зміни власності. Хоча цей метод і повільніший, він кращий для тих, хто не поспішає, оскільки максимізує ефективність ricochet, посилюючи його стійкість до аналізу ланцюга;

![BTC204](assets/notext/63/08.webp)

- Класичний ricochet, який призначений для швидкого виконання операції шляхом трансляції всіх транзакцій у короткий проміжок часу. Таким чином, цей метод пропонує меншу конфіденційність і нижчу стійкість до аналізу, ніж покращений метод. Його слід використовувати лише для термінових відправлень.

![BTC204](assets/notext/63/09.webp)

Ricochet просто передбачає відправлення біткойнів самому собі. Цілком можливо виконати ricochet вручну на будь-якому програмному гаманці, не використовуючи спеціалізований інструмент. Просто перекажіть ту саму монету самому собі послідовно, використовуючи нову порожню адресу кожного разу.

У наступному розділі ми досліджуємо різні техніки таємних передач власності. Ці методи кардинально відрізняються від тих, які ми розглядали до цього, як з точки зору роботи, так і результатів.

https://planb.network/tutorials/privacy/ricochet
 
## Таємні передачі власності
<chapterId>a2067036-849c-4d6b-87d2-44235cfae7a1</chapterId>

Серед технік конфіденційності в Bitcoin також існує таємна передача власності. Цей метод має на меті передати власність на біткойни від однієї особи до іншої, і навпаки, без того, щоб ця транзакція була явно видима на блокчейні. Давайте разом вивчимо різні доступні техніки, а також їхні переваги та недоліки.

### CoinSwap

CoinSwap базується на відносно простій концепції: він використовує смарт-контракти для сприяння передачі власності на біткойни між двома користувачами, без необхідності довіри та без того, щоб ця передача була явно видима на блокчейні.

![BTC204](assets/notext/64/01.webp)
Уявімо спрощений приклад з Алісою та Бобом. Аліса володіє 1 BTC, захищеним приватним ключем $A$, а Боб також володіє 1, захищеним приватним ключем $B$. Теоретично, вони могли б обмінятися своїми приватними ключами через зовнішній канал зв'язку для здійснення таємної передачі.
![BTC204](assets/notext/64/02.webp)
Проте, цей наївний метод представляє високий ризик з точки зору довіри. Ніщо не заважає Алісі зберегти копію приватного ключа $A$ після обміну та використати його пізніше для крадіжки біткойнів, як тільки ключ опиниться у володінні Боба.
![BTC204](assets/notext/64/03.webp)

Більше того, немає гарантії, що запобігає Алісі отримати приватний ключ Боба $B$ і ніколи не надіслати свій приватний ключ $A$ у відповідь. Таким чином, цей обмін покладається на надмірну довіру між сторонами і виявляється неефективним у забезпеченні безпечної таємної передачі власності.

![BTC204](assets/notext/64/04.webp)

Для вирішення цих проблем і дозволу обмінів між сторонами, які не довіряють одна одній, ми можемо використовувати системи розумних контрактів. Розумний контракт - це програма, яка автоматично виконується, коли визначені умови виконані, що, у нашому випадку, забезпечує, що обмін власності відбувається автоматично без потреби у взаємній довірі.

Для цього ми можемо використовувати HTLC (*Hash Time-Locked Contracts*) або PTLC (*Point Time-Locked Contracts*). Ці два протоколи функціонують подібно, використовуючи систему з часовим блокуванням, яка гарантує, що обмін або успішно завершується, або повністю скасовується, таким чином захищаючи цілісність коштів обох сторін. Основна відмінність між HTLC та PTLC полягає в тому, що HTLC використовують хеші та попередні зображення для забезпечення транзакції, тоді як PTLC використовують Adaptor Signatures.

У сценарії coinswap, використовуючи HTLC або PTLC між Алісою та Бобом, обмін відбувається безпечно: або він успішний, і кожен отримує BTC іншого, або він провалюється, і кожен зберігає свої BTC. Таким чином, неможливо для однієї зі сторін обдурити або вкрасти BTC іншої.

> *HTLC також є механізмом, який використовується для безпечного маршрутизування платежів через двонаправлені канали Lightning Network.*

Використання Adaptor Signatures є особливо цікавим у цьому контексті, оскільки це дозволяє обійти традиційні скрипти (це механізм, який іноді називають "_scriptless scripts_"). Ця особливість допомагає знизити комісії, пов'язані з обміном. Ще одна велика перевага Adaptor Signatures полягає в тому, що вони не вимагають використання спільного хешу для обох сторін транзакції, таким чином уникаючи розкриття прямого зв'язку між ними у певних типах обмінів.
### Adaptor Signatures

Adaptor Signatures - це криптографічний метод, який інтегрує дійсний підпис з додатковим підписом, названим "_adaptor signature_", для розкриття таємної частини даних. Цей механізм розроблений таким чином, що знання 2 з наступних 3 елементів: дійсний підпис, адаптерний підпис і таємниця, дозволяє вивести відсутній третій елемент. Цікавою властивістю цього методу є те, що, якщо ми знаємо адаптерний підпис нашого контрагента і конкретну точку на еліптичній кривій, асоційовану з таємницею, використаною для розрахунку цього адаптерного підпису, ми можемо вивести наш власний адаптерний підпис, який буде сумісний з тією ж таємницею, не маючи прямого доступу до самої таємниці.

У сценарії coinswap використання Adaptor Signatures дозволяє одночасно розкрити дві чутливі частини інформації між учасниками, таким чином уникаючи потреби у взаємній довірі. Давайте розглянемо приклад цього процесу з Алісою та Бобом, які бажають обміняти власність на 1 BTC кожен, але не довіряють один одному. Вони використовують Adaptor Signatures, щоб усунути потребу в довірі в цьому обміні. Ось як вони процедують:
* Аліса ініціює обмін, створюючи транзакцію $m_A$, яка відправляє 1 BTC Бобу. Вона генерує підпис $s_A$, який валідує цю транзакцію, використовуючи свій приватний ключ $p_A$ ($P_A = p_A \cdot G$), nonce $n_A$ ($N_A = n_A \cdot G$) та секрет $t$ ($T = t \cdot G$):
$$s_A = n_A + t + H(N_A + T \parallel P_A \parallel m_A) \cdot p_A$$

* Аліса розраховує адаптерний підпис $s_A'$, віднімаючи секрет $t$ від свого справжнього підпису $s_A$:

$$s_A' = s_A - t$$

* Аліса відправляє Бобу свій адаптерний підпис $s'_A$, її непідписану транзакцію $m_A$, точку, що відповідає секрету ($T$), та точку, що відповідає nonce ($N_A$). Ці елементи становлять те, що називається "*адаптером*". Важливо зауважити, що, маючи лише цю інформацію, Боб не може відновити BTC Аліси.
* Однак, Боб має можливість перевірити, що Аліса не намагається його обікрасти. Для цього він перевіряє, чи адаптерний підпис Аліси $s_A'$ дійсно відповідає запропонованій транзакції $m_A$. Якщо наступне рівняння вірне, він може бути впевненим, що адаптерний підпис Аліси є дійсним:
$$s_A' \cdot G = N_A + H(N_A + T \parallel P_A \parallel m_A) \cdot P_A$$

* Ця перевірка надає Бобу достатні гарантії для впевненого продовження обміну. Потім він створює свою власну транзакцію $m_B$, призначену для відправлення 1 BTC Алісі, та генерує свій адаптерний підпис $s_B'$, який також буде пов'язаний з тим самим секретом $t$. На цьому етапі лише Аліса знає значення $t$; Боб знає лише відповідну точку $T$, яку Аліса передала йому:

$$s_B' = n_B + H(N_B + T \parallel P_B \parallel m_B) \cdot p_B$$

* Боб передає Алісі свій адаптерний підпис $s_B'$, його непідписану транзакцію $m_B$, а також точку, що відповідає секрету ($T$) та точку, що відповідає nonce ($N_B$). Аліса, яка знає секрет $t$, тепер може поєднати адаптерний підпис Боба $s_B'$ з цим секретом, щоб згенерувати дійсний підпис $s_B$ для транзакції $m_B$, яка передасть BTC Боба їй:

$$s_B = s_B' + t$$

$$(s_B' + t) \cdot G = N_B + T + H(N_B + T \parallel P_B \parallel m_B) \cdot P_B$$

* Аліса транслює цю підписану транзакцію $m_B$ в блокчейні Bitcoin, щоб відновити BTC, обіцяні Бобом. Коли Боб бачить цю транзакцію в блокчейні, він може витягти підпис $s_B = s_B' + t$. З цією інформацією Боб тоді може ізолювати знаменитий секрет $t$, який йому був потрібен:

$$t = (s_B' + t) - s_B' = s_B - s_B'$$

* І справді, цей секрет $t$ був єдиним відсутнім елементом для Боба, щоб згенерувати дійсний підпис $s_A$ з адаптерного підпису Аліси $s_A'$. Цей підпис дозволяє валідувати транзакцію $m_A$, яка відправляє BTC від Аліси до Боба. Боб тоді розраховує $s_A$ і, в свою чергу, транслює транзакцію $m_A$ в блокчейні: 

$$s_A = s_A' + t$$
$$(s_A' + t) \cdot G = N_A + T + H(N_A + T \parallel P_A \parallel m_A) \cdot P_A$$
Давайте підсумуємо, як працює Адаптерний Підпис у монетному обміні. Спочатку Аліса надсилає Бобу непідписану транзакцію разом з адаптером, який дозволяє Бобу перевірити, що секрет, розкритий пізніше, дасть йому доступ до біткойнів. У відповідь Боб надсилає Алісі свою власну непідписану транзакцію та свій адаптер. Потім Аліса може завершити транзакцію Боба та відновити біткойни, опублікувавши дійсну транзакцію, використовуючи секрет. Коли ця транзакція публікується в блокчейні, Боб має можливість витягти секрет і таким чином розблокувати транзакцію Аліси. Таким чином, якщо Аліса ініціює переказ біткойнів Боба, він, у свою чергу, може отримати доступ до біткойнів Аліси без необхідності взаємної довіри.
Варто зазначити, що монетні обміни були вперше запропоновані [Грегорі Максвеллом у жовтні 2013 року на BitcoinTalk](https://bitcointalk.org/index.php?topic=321228.0).

### Атомарний Обмін

Подібно до монетного обміну та використовуючи ті ж типи смарт-контрактів, також можливо виконати атомарні обміни. Атомарний обмін дозволяє безпосередньо обмінювати різні криптовалюти, такі як BTC та XMR, між двома користувачами без необхідності довіри або втручання посередника. Ці обміни називаються "атомарними", тому що вони мають лише два можливі результати: або обмін успішний і обидві сторони задоволені, або він зазнає невдачі, і кожен зберігає свої вихідні криптовалюти, таким чином усуваючи необхідність довіряти іншій стороні.

![BTC204](assets/notext/64/05.webp)

Атомарний обмін та монетний обмін мають схожий метод роботи та пропонують ті ж переваги та недоліки з точки зору конфіденційності. Дійсно, з точки зору Bitcoin, атомарний обмін порівнянний з монетним обміном, виконаним у два кроки. Спочатку ми обмінюємо наші BTC на іншу криптовалюту, а потім цю криптовалюту можна обміняти на інші BTC. В результаті ми відновлюємо BTC іншого користувача. Саме тому, в аналізі питань конфіденційності, я групую ці два протоколи під категорією секретних обмінів власності.

![BTC204](assets/notext/64/06.webp)

Однак, на відміну від монетного обміну, атомарний обмін може мати нерівності з точки зору доступної ліквідності, особливо в обмінах BTC/XMR. Зазвичай легше обміняти біткойни на альткойни, оскільки існує високий попит на біткойни, що утримує премії низькими для цього напрямку конвертації. Однак, обмін альткойнів на отримання BTC може бути складнішим через нижчий попит, що часто призводить до дуже високих премій.

Нарешті, коли атомарний обмін включає біткойни в ланцюжку та біткойни в мережі Lightning, ми тоді називаємо його "*субмаринний обмін*".

### Чи Дійсно Це Корисно?
Секретні передачі власності, такі як монетні обміни та атомарні обміни, мають перевагу в обмані евристик аналізу ланцюжка. Ці методи можуть створити враження, що транзакції здійснюються тим самим користувачем, хоча фактична власність змінилася. Однак, основним недоліком цих методів є те, що вони дуже ризиковані без використання додаткової техніки для розриву історії монети.

Дійсно, коли Аліса виконує монетний обмін або атомарний обмін з Бобом, вона обмінює власність своїх біткойнів на біткойни Боба. У випадку атомарного обміну обмін включає альткойн, але принцип залишається тим самим. Таким чином, Аліса отримує монету $B$, а Боб - монету $A$. Це додає сумнівів у аналіз ланцюжка, але історія монет залишається простежуваною. Якщо аналітик розглядає монету $A$, він може прослідкувати до попередніх дій Аліси, і навпаки для монети $B$.
![BTC204](assets/en/64/07.webp)
З точки зору Аліси, ризик полягає в тому, що історія монети $B$ може бути визнана підозрілою певними організаціями. Якщо, наприклад, Боб отримав монету $B$ в результаті злочинної діяльності, такої як хакінг, ця монета залишиться пов'язаною з його незаконними діями. Тоді Аліса може опинитися в положенні, коли вона не може перевести монету на регульовані біржові платформи без ризику заморозки своїх коштів, або навіть звинувачення в злочинах Боба, хоча вона не мала до них ніякого відношення.

![BTC204](assets/en/64/08.webp)

І, звичайно, методи конфіденційності, такі як coinswap або atomic swap, віддають перевагу злочинцям, чиї кошти перебувають під наглядом влади. Ці протоколи надають їм можливість позбутися від своїх контрольованих біткойнів в обмін на абсолютно фунгібельні біткойни. Це також дозволяє їм створити відволікання, спрямовуючи владу на інших користувачів. Таким чином, для цих осіб існує подвійна користь.

З coinjoin, навіть якщо ваша монета змішана з контрольованими біткойнами, історія монети переривається, що надає форму правдоподібного заперечення, якого немає в протоколах таємної передачі власності, таких як coinswap або atomic swap.

![BTC204](assets/notext/64/09.webp)
Якщо Аліса хоче уникнути будь-якого ризику, їй обов'язково потрібно використовувати метод для переривання історії монети $B$, наприклад, пропускаючи її через coinjoins. Це порушує питання про користь поєднання таємної передачі власності та coinjoin. Coinjoin, перериваючи історію монети, вже забезпечує достатній рівень конфіденційності для Аліси. Таким чином, на мою думку, якщо Аліса прагне захистити свою конфіденційність, було б більш обережно прямо приступити до coinjoin, а не займатися coinswap, за яким слідує coinjoin.
Для того, щоб методи таємної передачі власності були дійсно ефективними та уникнули ризику пов'язування історії користувача $A$ з користувачем $B$, пародоксально необхідно, щоб їх використання було широко відомим. Якщо coinswap використовується масово і влада знає про цю загальну практику, тоді може бути встановлено правдоподібне заперечення. Однак, доки використання цих передач залишається маргінальним, я вважаю, що ці методи залишатимуться занадто ризикованими для користувачів.

До цього моменту ми переважно вивчали методи конфіденційності на рівні самих транзакцій. У наступному розділі ми розглянемо проблеми на рівні мережі та поширення транзакцій.

## Конфіденційність у P2P мережі
<chapterId>04a2467b-db84-4076-a9ff-919be5135106</chapterId>

У частині 4 ми обговорювали важливість використання повного вузла для захисту конфіденційності ваших транзакцій. Однак важливо розуміти, що сам ваш вузол може бути підданий атакам, які прагнуть витягнути інформацію про вашу діяльність. У цьому розділі ми тому розглянемо різні заходи захисту конфіденційності, не на рівні самих транзакцій або потоків біткойнів, а на рівні мережі.

### Осминіг

Один із способів уникнути різних атак деанонімізації - використовувати пропозицію Осминіг. Цей протокол розсилки був формалізований у BIP156, але він ніколи не був реалізований у Bitcoin.

Ідея Осминіга полягає в покращенні конфіденційності маршрутизації транзакцій у мережі Bitcoin для протидії різним формам атак. Його основна мета - приховати вихідний вузол, який спочатку транслює транзакцію в мережі. Розкриття цього вузла може пов'язати транзакцію Bitcoin з конкретною IP-адресою (якщо вузол працює в чистому інтернеті), що може надати точку входу для аналізу ланцюга.
Ця асоціація між активністю на Bitcoin та IP-адресою становить значний ризик для приватності користувача. Дійсно, численні суб'єкти можуть легко пов'язати IP-адресу з особистою ідентичністю. Це, зокрема, включає уряди та провайдерів Інтернет-послуг. Більше того, ця інформація може стати публічно доступною, наприклад, якщо вашу IP-адресу та особисті дані буде викрито через витік під час злому бази даних вебсайту. Під час стандартної роботи Bitcoin транзакції, створені користувачем у їхньому програмному забезпеченні гаманця, передаються до їхнього особистого вузла. Цей вузол негайно транслює нову транзакцію всім пірам, до яких він підключений.

![BTC204](assets/notext/65/01.webp)

Ці піри потім перевіряють транзакцію, щоб переконатися, що вона відповідає правилам консенсусу та місцевим стандартам. Після валідації кожен пір по черзі передає транзакцію своїм пірам, і так далі.

![BTC204](assets/notext/65/02.webp)

Розподіл транзакцій, що очікують інтеграції в блок, відбувається досить збалансовано та статистично передбачувано. Цю вразливість можуть використовувати змовницькі шпигунські вузли, які співпрацюють для моніторингу та аналізу мережі, щоб ідентифікувати перший вузол, який транслював транзакцію. Якщо спостерігачу вдається знайти вихідний вузол, він може припустити, що транзакція походить від оператора цього вузла. Такий тип спостереження може пов'язати транзакції, зазвичай анонімні, з конкретними IP-адресами.

![BTC204](assets/notext/65/03.webp)

Метою BIP156 є вирішення цієї проблеми. Для цього він вводить додаткову фазу в трансляцію нової транзакції для збереження анонімності перед широким публічним розповсюдженням. Спочатку Dandelion використовує фазу "стебло", де транзакція передається через випадковий шлях вузлів.

![BTC204](assets/notext/65/04.webp)

Потім транзакція транслюється всій мережі у фазі "пух".

![BTC204](assets/notext/65/05.webp)

Стебло та пух є посиланнями на поведінку розповсюдження транзакції через мережу, що нагадує форму кульбаби.

Таким чином, шпигунські вузли потенційно можуть відстежити транзакцію до вузла, який ініціював фазу пуху (масову трансляцію), але цей вузол не є тим, який спочатку транслював транзакцію, оскільки він отримав її від останнього вузла у стеблі. Якщо шпигунським вузлам не вдається прослідкувати шлях вгору по стеблу, вони також не можуть ідентифікувати вихідний вузол.

![BTC204](assets/notext/65/06.webp)
Навіть у присутності шпигунських вузлів під час фази стебла, сумнів завжди залишається, оскільки як тільки вони зустрічають чесний вузол у графі розповсюдження, шпигуни не можуть визначити, чи цей вузол є оригінальним джерелом чи просто посередником.
![BTC204](assets/notext/65/07.webp)

Цей метод маршрутизації розмиває слід, що веде до вихідного вузла, ускладнюючи відстеження транзакції через мережу до її походження. Таким чином, Dandelion покращує приватність, обмежуючи здатність противників деанонімізувати мережу. Цей метод є ще більш ефективним, коли транзакція перетинає під час фази "стебла" вузол, який шифрує свої мережеві комунікації, як з Tor або P2P Transport V2.
BIP156 не було інтегровано до Bitcoin Core і наразі класифікується як "відхилено". Однією з основних проблем цього протоколу є те, що під час фази стебла транзакції мають бути передані через посередницькі вузли до їх перевірки. Як ми бачили, у звичайній моделі Bitcoin кожен вузол спочатку перевіряє транзакцію перед тим, як транслювати її своїм пірам. Якщо транзакція не відповідає правилам консенсусу або локальним правилам стандартизації вузла, він ігнорує її і не транслює. Цей процес важливий для протидії атакам DoS, оскільки транслюються лише дійсні транзакції. Недійсні транзакції, потенційно генеровані масово для перевантаження мережі, зупиняються на першому зустрічному вузлі і не поширюються. Основний ризик з Dandelion полягає в тому, що цей новий протокол може ввести нові вектори для атак DoS, дозволяючи трансляцію недійсних транзакцій через частину мережі.

### P2P Transport V2

P2P Transport V2 - це інший мережевий протокол, представлений у BIP324. Це нова версія протоколу транспортування P2P Bitcoin, яка включає опортуністичне шифрування для покращення конфіденційності та безпеки комунікацій між вузлами.

Це покращення має на меті вирішити кілька проблем з базовою версією протоколу P2P. З одного боку, воно робить обмін даними нерозрізненним від інших типів даних, що циркулюють в Інтернеті для пасивного спостерігача. Основна мета - запобігти масовому моніторингу користувачів Bitcoin з боку урядів, інтернет-провайдерів або провайдерів VPN. Це також ускладнює завдання для цих суб'єктів визначити, чи є інтернет-користувач також користувачем Bitcoin, тобто чи він використовує повний вузол.
P2P V2 також сприяє зменшенню ризиків цензури та атак через виявлення специфічних шаблонів у пакетах даних. Воно ускладнює та робить виконання різних типів атак Sybil дорожчими на рівні мережі. Атака Sybil відбувається, коли актор створює кілька фальшивих ідентичностей для отримання невиправданої переваги. У контексті мережі Bitcoin це часто проявляється як актор, який контролює велику кількість повних вузлів і агресивно використовує їх для множення з'єднань. Атаки Sybil можуть бути пасивними, маючи на меті збір інформації та порушення конфіденційності користувача, або активними, у формі атак Eclipse. Останні ізолюють певний вузол від решти мережі, дозволяючи або цензурувати користувача, або змінювати дані, які він отримує. Нарешті, P2P V2 також робить атаки *Man-In-The-Middle* (MITM) дорожчими та легшими для виявлення.
Шифрування, реалізоване P2P V2, не включає аутентифікацію, щоб не додавати непотрібної складності та не порушувати бездозвільну природу мережевого з'єднання. Цей новий протокол транспортування P2P, тим не менш, пропонує кращу безпеку проти пасивних атак і робить активні атаки значно дорожчими та виявними. Введення псевдовипадкового потоку даних у мережеві повідомлення ускладнює завдання для атакуючих, які бажають цензурувати або маніпулювати комунікаціями.

Транспорт P2P V2 було включено як опцію (вимкнено за замовчуванням) у версії 26.0 Bitcoin Core, розгорнутої у грудні 2023 року. Потім він був увімкнений за замовчуванням у версії 27.0 у квітні 2024 року. Його можна змінити за допомогою опції `v2transport=` у файлі конфігурації.

### Tor

Іншим відносно простим рішенням для уникнення ризиків втрати конфіденційності для вузла на рівні мережі є його повна робота під Tor.
Tor - це мережа ретрансляційних серверів (вузлів), яка анонімізує походження TCP-з'єднань в інтернеті. Вона працює шляхом інкапсуляції даних у кілька шарів шифрування. Кожен ретрансляційний вузол видаляє один шар, щоб відкрити адресу наступного вузла, доки не досягне кінцевого пункту призначення. Мережа Tor забезпечує анонімність, запобігаючи тому, щоб проміжні вузли знали як походження, так і пункт призначення даних, що робить дуже складним для спостерігача відстеження активності користувача.
![BTC204](assets/notext/65/08.webp)
Таким чином, Tor не лише шифрує передані дані, але й дозволяє маскувати походження та пункт призначення комунікацій. Використовуючи Tor для комунікацій особистого вузла, ми підвищуємо конфіденційність наших транзакцій: провайдер інтернет-послуг (ISP) не може розшифрувати комунікації, а інші вузли в мережі Bitcoin не можуть ідентифікувати IP-адресу джерельного вузла. Більше того, Tor також приховує ваше використання Bitcoin від вашого ISP.

Основний ризик, пов'язаний з цим методом, полягає в тому, що Tor є протоколом, незалежним від Bitcoin. Якщо у вас є Bitcoin вузол під Tor і Tor перестає працювати, то ваш Bitcoin вузол більше не зможе комунікувати.

Також важливо зазначити, що комунікації через Tor є повільнішими. Ця затримка особливо докучлива під час початкового запуску вузла, оскільки початкове завантаження блоку (IBD) вимагає багато комунікацій. В результаті, ваша початкова синхронізація з мережею Bitcoin може бути значно довшою, використовуючи Tor. Також можливо виконати IBD на чистому інтернеті, а потім активувати Tor пізніше. Хоча цей метод розкриває існування вашого Bitcoin вузла вашому ISP, він захищає інформацію, пов'язану з вашими особистими транзакціями, коли ви переходите на Tor.

Після дослідження різних методів конфіденційності на рівні мережі, я також хочу представити в наступних розділах два елегантні рішення для уникнення повторного використання адрес: BIP47 та Silent Payments.

## BIP47 та Повторно Використовувані Коди Оплати
<chapterId>ad88e076-a04b-4aec-b3b2-7b4760175504</chapterId>

Як ми бачили в частині 3, повторне використання адрес становить серйозну перешкоду для конфіденційності користувачів у протоколі Bitcoin. Для зменшення цих ризиків настійно рекомендується генерувати нову адресу для отримання для кожної нової оплати, отриманої в гаманці. Хоча генерація нової адреси сьогодні спрощена за допомогою сучасного програмного забезпечення та ієрархічних детермінованих гаманців, ця практика може здатися контрінтуїтивною.

![BTC204](assets/notext/66/1.webp)

Наприклад, у традиційній банківській системі ми звикли ділитися нашим IBAN, який завжди залишається незмінним. Одного разу повідомивши його комусь, вони можуть надсилати нам кілька платежів без необхідності знову взаємодіяти з нами. Нео-банки також пропонують більш сучасні можливості, як використання унікальних електронних адрес на PayPal або RevTags на Revolut. Навіть за межами фінансової сфери, наші щоденні ідентифікатори, такі як наша поштова адреса, номер телефону та електронна адреса, також є унікальними та постійними. Нам не потрібно оновлювати їх з кожною новою взаємодією.

![BTC204](assets/notext/66/2.webp)
Однак, робота Bitcoin відрізняється: необхідно генерувати нову адресу для отримання для кожної вхідної транзакції. Цей компроміс між зручністю використання та конфіденційністю сягає корінням до самого початку Bitcoin White Paper. З публікації першої версії його документа наприкінці 2008 року, Сатоші Накамото вже попереджав нас про цей ризик:
**"*Як додатковий захисний бар'єр, для кожної транзакції могла б бути використана нова пара ключів, щоб уникнути їх пов'язування з одним власником.*"**
Існує безліч методів отримання кількох платежів на один ідентифікатор без повторного використання адреси. Кожен з них має свої компроміси та недоліки. Серед цих методів є BIP47, пропозиція, розроблена Justus Ranvier та опублікована у 2015 році. Ця пропозиція має на меті створити повторно використовувані коди платежів, які дозволяють здійснювати кілька транзакцій одній і тій же особі, уникаючи повторного використання адреси. По суті, BIP47 прагне запропонувати систему платежів настільки інтуїтивно зрозумілу, як унікальний ідентифікатор, зберігаючи при цьому приватність транзакцій.
![BTC204](assets/notext/66/3.webp)

BIP47 не покращує приватність користувача безпосередньо, оскільки платіж BIP47 пропонує той самий рівень приватності, що й класична транзакція Bitcoin з використанням нових адрес. Однак, він робить використання Bitcoin більш зручним та інтуїтивно зрозумілим, зручність, яка, зазвичай, повинна бути компромісом для приватності. Завдяки BIP47, ця зручність досягає того ж рівня приватності, що й класична транзакція. Саме тому BIP47 є цінним інструментом для збереження приватності.

Спочатку BIP47 був пропозицією, сформульованою для інтеграції в Bitcoin Core, але вона ніколи не була прийнята. Деяке програмне забезпечення все ще вирішило реалізувати його на власному рівні застосунку. Таким чином, команди Samourai Wallet розробили власну реалізацію BIP47 під назвою "PayNym".

### Загальний принцип BIP47 та PayNym

Мета BIP47 полягає в тому, щоб дозволити отримання численних платежів без повторного використання адреси. Він покладається на використання повторно використовуваного коду платежу, який дозволяє різним відправникам надсилати кілька платежів на один код, що належить іншому користувачеві. Таким чином, одержувач не має надавати нову свіжу адресу для кожної транзакції, що значно полегшує їх обміни, зберігаючи їхню приватність.

![BTC204](assets/en/66/4.webp)

Користувач може вільно ділитися своїм кодом платежу, чи то в соціальних мережах, чи на своєму вебсайті, не ризикуючи втратити приватність, на відміну від того, що сталося б з класичною адресою отримання або публічним ключем.
Для проведення транзакції обидві сторони повинні мати гаманець Bitcoin з реалізацією BIP47, такий як PayNym у Samourai Wallet або Sparrow Wallet. Спільне використання їхніх кодів платежів створює таємний канал між ними. Для ефективного встановлення цього каналу відправник повинен виконати специфічну транзакцію на блокчейні Bitcoin, відому як "транзакція повідомлення" (я дам вам більше деталей про це пізніше).

Комбінація кодів платежів обох користувачів генерує спільні секрети, які, в свою чергу, дозволяють створення великої кількості унікальних адрес отримання Bitcoin (точно 2^32, або близько 4 мільярдів). Таким чином, платежі, здійснені через BIP47, насправді не адресовані самому коду платежу, а скоріше класичним адресам отримання, похідним від кодів платежів залучених користувачів.

Таким чином, код платежу служить віртуальним ідентифікатором, похідним від насіння гаманця. У ієрархічній структурі похідності гаманця, код платежу розташований на рівні 3, тобто на рівні рахунку.

![BTC204](assets/en/66/5.webp)

Мета похідності для BIP47 визначена індексом `47'` (`0x8000002F`), що відсилає до BIP47. Приклад шляху похідності для повторно використовуваного коду платежу був би таким:
```plaintext
m/47'/0'/0'/
```

Щоб дати вам уявлення про те, як виглядає код платежу, ось мій:
```plaintext
Цей код також може бути закодований у QR-код, щоб полегшити його передачу, як і класична адреса отримувача.

Що стосується PayNym Bots, ці роботи, які іноді можна побачити на Twitter, є візуальними представленнями платіжного коду, створені Samourai Wallet. Вони генеруються за допомогою хеш-функції, що надає їм майже унікальність. Вони з'являються у вигляді невеликої послідовності символів, що починається з `+`:
```plaintext
+throbbingpond8B1
+twilightresonance487
+billowingfire340
```

Ці аватари також можуть бути представлені у вигляді зображень:

![BTC204](assets/notext/66/6.webp)

Хоча ці роботи не мають специфічної технічної функціональності в рамках BIP47, вони відіграють роль у полегшенні взаємодії між користувачами, пропонуючи легко впізнавану візуальну ідентичність.
У наступних розділах цього розділу, присвяченого BIP47, ми детально розглянемо, як це працює, з особливим акцентом на використовувані криптографічні методи. Щоб повністю зрозуміти ці дещо технічні пояснення, важливо спочатку зрозуміти структуру HD гаманців, процеси похідної ключів та основні принципи криптографії на основі еліптичних кривих. Якщо ви бажаєте глибше зануритися в ці концепції, інший безкоштовний курс доступний на PlanB Network: [CRYPTO 301](https://planb.network/en/courses/crypto301). Я все ж раджу вам слідувати їм, оскільки розуміння технічних аспектів BIP47 значно полегшить вам розуміння інших подібних пропозицій, які ми обговоримо в наступних розділах.
### Повторно використовуваний платіжний код

Як зазначалося раніше, повторно використовуваний платіжний код розташований на глибині 3 HD гаманця, що робить його порівнянним з `xpub`, як у його позиції в структурі гаманця, так і в його ролі.

80-байтовий платіжний код розбивається наступним чином:
- **Байт `0`: Версія**. Для першої версії BIP47, цей байт встановлюється як `0x01`;
- **Байт `1`: Бітове поле**. Цей простір зарезервований для інтеграції додаткових вказівок під час специфічних використань. Для стандартного використання з PayNym, цей байт визначений як `0x00`;
- **Байт `2`: Парність `y`**. Цей байт є `0x02` або `0x03`, вказуючи, чи є ордината публічного ключа парною чи непарною, оскільки використовується стиснутий публічний ключ;
- **Від байта `3` до байта `34`: Значення `x`**. Ці байти представляють абсцису публічного ключа. Конкатенація `x` та парності `y` формує повний стиснутий публічний ключ;
- **Від байта `35` до байта `66`: Код ланцюга**. Цей простір містить код ланцюга, асоційований з публічним ключем;
- **Від байта `67` до байта `79`: Заповнення**. Цей простір призначений для можливих майбутніх розробок. Для поточної версії сюди просто розміщуються нулі, щоб досягти необхідного розміру в 80 байтів для виходу `OP_RETURN`.

Ось шістнадцяткове представлення мого повторно використовуваного платіжного коду, вже представленого в попередньому розділі:
```plaintext
0x010002a0716529bae6b36c5c9aa518a52f9c828b46ad8d907747f0d09dcd4d9a39e97c3c5f37c470c390d842f364086362f6122f412e2b0c7e7fc6e32287e364a7a36a00000000000000000000000000

![BTC204](assets/en/66/7.webp)

Спочатку необхідно додати префіксний байт `P` на початку, щоб чітко вказати, що це код платежу. Цей байт представлено як `0x47`:
```plaintext
0x47010002a0716529bae6b36c5c9aa518a52f9c828b46ad8d907747f0d09dcd4d9a39e97c3c5f37c470c390d842f364086362f6122f412e2b0c7e7fc6e32287e364a7a36a00000000000000000000000000
```

Нарешті, для забезпечення цілісності коду платежу виконується розрахунок контрольної суми за допомогою `HASH256`, який складається з подвійного хешування за допомогою функції `SHA256`. Перші чотири байти, отримані з цього хешу, потім конкатенуються до кінця коду платежу:
```plaintext
0x47010002a0716529bae6b36c5c9aa518a52f9c828b46ad8d907747f0d09dcd4d9a39e97c3c5f37c470c390d842f364086362f6122f412e2b0c7e7fc6e32287e364a7a36a00000000000000000000000000567080c4
```

![BTC204](assets/en/66/8.webp)

Після завершення цих кроків код платежу готовий. Останнє, що залишається зробити, - це конвертувати його в base 58, щоб отримати його остаточну версію:
```plaintext
PM8TJSBiQmNQDwTogMAbyqJe2PE2kQXjtgh88MRTxsrnHC8zpEtJ8j7Aj628oUFk8X6P5rJ7P5qDudE4Hwq9JXSRzGcZJbdJAjM9oVQ1UKU5j2nr7VR5
```

Під час цього процесу створення коду платежу ми використовуємо стиснутий публічний ключ та код ланцюга. Обидва виводяться з детермінованої та ієрархічної похідної від насіння гаманця. Шлях похідної, який використовується для досягнення цього, є:
```plaintext
m/47'/0'/0'/
```
Щоб згенерувати стиснутий публічний ключ та асоційований код ланцюга для повторно використовуваного коду платежу, ми починаємо з розрахунку майстер-приватного ключа з насіння гаманця. Потім ми продовжуємо виводити пару дочірніх ключів, використовуючи індекс `47 + 2^31` (посилена похідна). Цей крок слідує за ще двома послідовними похідними дочірніх пар, кожна з яких використовує індекс `2^31` (посилена похідна).
![BTC204](assets/notext/66/9.webp)

### Обмін ключами Elliptic-Curve Diffie-Hellman (ECDH)
Криптографічний протокол, який лежить в основі BIP47, називається абревіатурою ECDH, що означає *Еліптична крива Діффі-Геллмана*. Цей метод є варіантом оригінального обміну ключами Діффі-Геллмана.
Введений у 1976 році, Діффі-Геллман є протоколом узгодження ключів, який дозволяє двом сторонам, кожна з яких оснащена парою ключів (публічним і приватним), домовитися про спільний секрет, навіть спілкуючись виключно через публічний і незахищений канал.

![BTC204](assets/en/66/10.webp)

Цей спільний секрет (тут, синій ключ) може бути використаний для інших операцій. Зазвичай цей спільний секрет може бути використаний для шифрування та розшифрування комунікації через незахищену мережу:

![BTC204](assets/notext/66/11.webp)

Для досягнення цього обміну, Діффі-Геллман використовує модульну арифметику для розрахунку спільного секрету. Ось спрощене пояснення того, як це працює:
- Аліса та Боб домовляються про спільний колір, тут жовтий, який є публічними даними (атакуючі знають цей колір);
- Аліса вибирає секретний колір, тут червоний, і змішує два кольори, отримуючи оранжевий;
- Боб також вибирає секретний колір, тут синій, і змішує його з жовтим, отримуючи зелений;
- Потім вони обмінюються отриманими кольорами, оранжевим і зеленим. Цей обмін може відбуватися через незахищену та спостережувану мережу;
- Змішуючи зелений колір Боба зі своїм секретним кольором, Аліса отримує коричневий;
- Боб, роблячи те саме з оранжевим Аліси та його секретним синім, також отримує коричневий.

![BTC204](assets/en/66/12.webp)

У цьому спрощенні коричневий колір представляє спільний секрет між Алісою та Бобом. Важливо розуміти, що насправді неможливо розділити оранжевий та зелений кольори, щоб відкрити секретні кольори Аліси або Боба.

Тепер давайте розглянемо, як цей протокол насправді працює, не з аналогіями кольорів, а використовуючи реальні числа та модульну арифметику!
Перед обговоренням механізмів Діффі-Геллмана, дозвольте мені коротко нагадати вам два основні математичні поняття, які нам знадобляться:

- **Просте число** - це натуральне число, яке має лише два дільники: $1$ і саме себе. Наприклад, $7$ є простим числом, тому що його можна поділити лише на $1$ і $7$. З іншого боку, $8$ не є простим числом, оскільки його можна поділити на $1$, $2$, $4$ і $8$. Отже, воно має чотири додатні цілі дільники замість двох;
- **Модуль** (позначається $mod$ або $\%$) - це математична операція, яка між двома цілими числами повертає залишок від Евклідового ділення першого на друге. Наприклад, $16 \bmod 5 = 1$.

**Обмін ключами Діффі-Геллмана між Алісою та Бобом відбувається наступним чином:**

- Аліса та Боб домовляються про два спільні числа: $p$ і $g$. $p$ є простим числом, і чим більше це число, тим безпечніший буде Діффі-Геллман. $g$ є первісним коренем $p$. Ці два числа можуть бути відкрито передані через незахищену мережу. Вони представляють еквівалент **жовтого кольору** у попередньому спрощенні. Тому важливо, щоб Аліса та Боб використовували точно ті ж значення для $p$ і $g$.
- Як тільки ці параметри визначені, Аліса та Боб кожен обирає своє секретне випадкове число. Аліса називає своє секретне випадкове число $a$ (еквівалентно **червоному кольору**) та Боб називає своє $b$ (еквівалентно **синьому кольору**). Ці числа мають залишатися строго конфіденційними.
- Замість прямого обміну числами $a$ та $b$, кожна сторона розраховує $A$ та $B$ наступним чином:

$A$ дорівнює $g$ піднесеному до степеня $a$ по модулю $p$:

$$
A = g^a \bmod p
$$

$B$ дорівнює $g$ піднесеному до степеня $b$ по модулю $p$:

$$
B = g^b \bmod p
$$

- Значення $A$ (еквівалентно **помаранчевому кольору**) та $B$ (еквівалентно **зеленому кольору**) обмінюються між двома сторонами. Цей обмін може відбуватися відкрито через незахищену мережу;

- Аліса, отримавши $B$, розраховує значення $z$ наступним чином:

$z$ дорівнює $B$ піднесеному до степеня $a$ по модулю $p$:

$$
z = B^a \bmod p
$$

Щоб пригадати:

$$
B = g^b \bmod p
$$

Таким чином, ми отримуємо:

$$
z = B^a \bmod p
$$

$$
z = (g^b)^a \bmod p
$$

Застосовуючи правила степенів:
$$
(x^n)^m = x^{nm}
$$

Тоді отримуємо:

$$
z = g^{ba} \bmod p
$$

- Зі свого боку, Боб, отримавши $A$, також розраховує значення $z$ наступним чином:

$z$ дорівнює $A$ піднесеному до степеня $b$ по модулю $p$:

$$
z = A^b \bmod p
$$

Таким чином, ми отримуємо:

$$
z = (g^a)^b \bmod p
$$

$$
z = g^{ab} \bmod p
$$

$$
z = g^{ba} \bmod p
$$

Завдяки дистрибутивності оператора модуля, Аліса та Боб отримують абсолютно однакове значення $z$. Це число представляє їх спільну таємницю, еквівалентну **коричневому кольору** у попередньому спрощенні з фарбами. Тепер вони можуть використовувати цю спільну таємницю для симетричного шифрування своїх комунікацій через незахищену мережу.

![BTC204](assets/notext/66/13.webp)

Атакуючий, навіть володіючи $p$, $g$, $A$ та $B$ (публічними значеннями), не зможе розрахувати $a$, $b$ або $z$ (приватні значення). Для цього потрібно було б здійснити обернену експонентацію, операцію, неможливу без спроби всіх можливостей одну за одною, оскільки це зводиться до розрахунку дискретного логарифму, тобто оберненого до експоненціального в кінцевій циклічній групі.

Таким чином, доки значення $a$, $b$ та $p$ достатньо великі, протокол Діффі-Хеллмана є безпечним. Зазвичай, з 2048-бітними параметрами (число з 600 цифрами в десятковому форматі), тестування всіх можливостей для $a$ та $b$ було б непрактичним. До цього дня, з такими числами, цей алгоритм вважається безпечним.
Саме тут і криється основний недолік протоколу Діффі-Хеллмана. Для забезпечення безпеки алгоритм має використовувати великі числа. Саме тому, на сьогодні, віддається перевага алгоритму ECDH (*Еліптичні Криві Діффі-Хеллмана*), варіанту Діффі-Хеллмана, який базується на алгебраїчній кривій, більш точно на еліптичній кривій. Цей підхід дозволяє працювати з набагато меншими числами, зберігаючи при цьому еквівалентний рівень безпеки, тим самим зменшуючи необхідні ресурси для обчислень та зберігання.

Загальний принцип алгоритму залишається тим самим. Однак, замість використання випадкового числа $a$ та числа $A$, обчисленого з $a$ за допомогою модульного піднесення до степеня, ми використовуємо пару ключів, встановлених на еліптичній кривій. Замість покладання на дистрибутивність оператора модуля, ми використовуємо груповий закон на еліптичних кривих, і більш конкретно асоціативність цього закону.

Щоб коротко пояснити принцип криптографії на еліптичних кривих, приватний ключ представляється випадковим числом між $1$ та $n-1$, де $n$ представляє порядок кривої. З іншого боку, публічний ключ - це специфічна точка на цій кривій, отримана з приватного ключа через операції додавання точок та подвоєння, починаючи з генераторної точки, згідно з рівнянням:
$$
K = k \cdot G
$$

У цій формулі, $K$ позначає публічний ключ, $k$ приватний ключ, а $G$ генераторну точку.

Однією з основних характеристик цих ключів є легкість обчислення $K$ з $k$ та $G$, тоді як практично неможливо знайти $k$ з $K$ та $G$. Ця асиметрія створює односторонню функцію. Іншими словами, легко обчислити публічний ключ, якщо відомий приватний ключ, але знайти приватний ключ з публічного ключа неможливо. Ця безпека все ще базується на обчислювальній складності дискретного логарифму.

Ми використаємо цю властивість для адаптації нашого алгоритму Діффі-Хеллмана. **Принцип роботи ECDH наступний:**

- Аліса та Боб разом домовляються про криптографічно безпечну еліптичну криву та її параметри. Ця інформація є публічною;

- Аліса генерує випадкове число $ka$, яке буде її приватним ключем. Цей приватний ключ має залишатися в таємниці. Вона визначає свій публічний ключ $Ka$ шляхом додавання та подвоєння точок на обраній еліптичній кривій:

$$
K_a = k_a \cdot G
$$

- Боб також генерує випадкове число $kb$, яке буде його приватним ключем. Він обчислює асоційований публічний ключ $Kb$:

$$
K_b = k_b \cdot G
$$

- Аліса та Боб обмінюються своїми публічними ключами $Ka$ та $Kb$ через незахищену публічну мережу.

- Аліса обчислює точку $(x,y)$ на кривій, застосовуючи свій приватний ключ $ka$ до публічного ключа Боба $Kb$:

$$
(x,y) = k_a \cdot K_b
$$

- Боб обчислює точку $(x,y)$ на кривій, застосовуючи свій приватний ключ $kb$ до публічного ключа Аліси $Ka$:

$$
(x,y) = k_b \cdot K_a
$$

- Аліса та Боб отримують однакову точку на еліптичній кривій. Спільною таємницею буде x-координата $x$ цієї точки.

Вони дійсно отримують однакову спільну таємницю, тому що:
(x,y) = k_a \cdot K_b = k_a \cdot (k_b \cdot G) = (k_a \cdot k_b) \cdot G = (k_b \cdot k_a) \cdot G = k_b \cdot (k_a \cdot G) = k_b \cdot K_a$$
Спостерігач, який має доступ до незахищеної публічної мережі, може отримати лише публічні ключі кожної сторони та параметри обраної еліптичної кривої. Як було пояснено раніше, цієї інформації недостатньо для визначення приватних ключів. Таким чином, нападник не може знайти спільний секрет між Алісою та Бобом.

Таким чином, ECDH є алгоритмом, який дозволяє обмін ключами. Він часто використовується разом з іншими криптографічними методами для створення повного протоколу. Наприклад, ECDH інтегрований в ядро TLS (*Transport Layer Security*), протоколу шифрування та аутентифікації, який використовується для транспортного шару Інтернету. TLS використовує ECDHE для обміну ключами, варіант ECDH, де ключі є ефемерними, для забезпечення постійної конфіденційності. Крім того, TLS використовує алгоритми аутентифікації, такі як ECDSA, алгоритми шифрування, такі як AES, та хеш-функції, такі як SHA256.

TLS відповідає за `s` у `https`, а також за замок, видимий у адресному рядку вашого браузера, символи зашифрованих комунікацій. Таким чином, слідуючи цьому курсу, ви використовуєте ECDH, і дуже ймовірно, що ви використовуєте його щодня, навіть не знаючи про це.

### Транзакція сповіщення

Як ми бачили в попередньому розділі, ECDH є варіантом обміну Діффі-Хеллмана, який використовує пари ключів, створені на еліптичній кривій. Зручно, що ми вже маємо багато пар ключів, які відповідають цьому стандарту, у наших Bitcoin гаманцях! Ідея BIP47 полягає в тому, щоб використовувати пари ключів з детермінованих ієрархічних гаманців Bitcoin обох сторін для створення спільних і ефемерних секретів між ними. У контексті BIP47 замість цього використовується ECDHE (*Еліптична крива Діффі-Хеллмана Ефемерна*).

![BTC204](assets/notext/66/14.webp)

ECDHE використовується вперше в BIP47 для передачі платіжного коду від відправника до отримувача. Це відома **транзакція сповіщення**. Цей крок є важливим, оскільки для ефективної роботи BIP47 обидві сторони, що беруть участь (відправник і отримувач), повинні знати платіжний код один одного. Це знання дозволяє виводити ефемерні публічні ключі та, відповідно, асоційовані порожні адреси для отримання.
Перед цим обміном відправник логічно вже знає платіжний код отримувача, оскільки він отримав його поза мережею, наприклад, з їхнього вебсайту, рахунку-фактури або соціальних мереж. Однак, отримувач не обов'язково може знати платіжний код відправника. Тим не менш, цей код має бути переданий їм; інакше вони не зможуть вивести ефемерні ключі, необхідні для ідентифікації адрес, де зберігаються їхні біткоїни, ані отримати доступ до своїх коштів. Хоча ця передача коду відправника технічно може бути здійснена поза мережею через інші засоби комунікації, це створює проблему, якщо гаманець потрібно відновити лише з сіда.
Справді, на відміну від звичайних адрес, адреси BIP47 не походять безпосередньо від початкового коду одержувача — використання `xpub` було б простішим у цьому випадку — але є результатом обчислення, що поєднує обидва платіжні коди: відправника та одержувача. Таким чином, якщо одержувач втрачає свій гаманець і намагається відновити його зі свого початкового коду, він відновить свій власний платіжний код, який безпосередньо походить від його початкового коду. Однак, для знаходження ефемерних адрес, буде важливо, щоб вони також мали платіжні коди всіх, хто надсилав їм біткоїни через BIP47. Отже, важливість нотифікаційної транзакції, яка дозволяє зберігати цю інформацію на блокчейні Bitcoin, будучи здатною знайти її дуже легко без необхідності переглядати мільярд транзакцій, виконаних з моменту його запуску в 2009 році.
![BTC204](assets/en/66/15.webp)

Отже, було б можливо реалізувати BIP47 без використання нотифікаційної транзакції, за умови, що кожен користувач зберігає резервну копію платіжних кодів своїх колег. Однак, цей метод виявляється складним для управління, доки не буде розроблено простого, надійного та ефективного рішення для створення, зберігання та оновлення цих резервних копій. У поточному стані справ, нотифікаційна транзакція стає майже незамінною.

У наступних розділах ми вивчимо інші протоколи з цілями, схожими на BIP47, але які не вимагають нотифікаційної транзакції. Ці альтернативи, однак, вводять свої власні компроміси.

Крім своєї ролі у резервному копіюванні платіжних кодів, нотифікаційна транзакція також виконує функцію повідомлення для одержувача, як це випливає з її назви. Вона сигналізує клієнту одержувача, що новий платіжний канал був встановлений, і таким чином пропонує моніторинг результуючих ефемерних адрес.

### Модель конфіденційності BIP47

Перед детальним розглядом технічної роботи нотифікаційної транзакції, важливо обговорити модель конфіденційності, пов'язану з BIP47, яка виправдовує певні заходи, вжиті під час створення цієї початкової транзакції.
Платіжний код сам по собі не становить прямої загрози для конфіденційності. На відміну від традиційної моделі Bitcoin, яка прагне розірвати зв'язок між ідентичністю користувача та його транзакціями (які є публічними), зберігаючи анонімність ключів та адрес, платіжний код може бути відкрито асоційований з ідентичністю без створення загрози.
Дійсно, платіжний код не використовується для безпосереднього отримання адрес, які отримують платежі BIP47. Ці адреси замість цього генеруються за допомогою застосування ECDH між похідними ключами платіжних кодів двох залучених сторін.

Таким чином, сам по собі платіжний код не призводить безпосередньо до втрати конфіденційності, оскільки лише нотифікаційна адреса походить від нього. Хоча ця адреса може розкрити деяку інформацію, зазвичай вона не дозволяє виявити сторони, з якими ви проводите транзакції, якщо не через ретельний аналіз ланцюга. Дійсно, якщо відправник використовує UTXO, які можуть бути пов'язані з їхньою ідентичністю для виконання нотифікаційної транзакції, тоді стає можливим зробити висновок, що їхня ідентичність, ймовірно, пов'язана з платежами BIP47 на ваш платіжний код. Це не розкриє основних транзакцій, але вкаже на їх імовірне існування.

Тому важливо підтримувати цю строгу відокремленість платіжних кодів користувачів. Для досягнення цієї мети, початковий етап комунікації коду є критичним моментом для конфіденційності платежу, але обов'язковим для належного функціонування протоколу. Якщо один з платіжних кодів можна отримати публічно (наприклад, на вебсайті), другий код, той, що належить відправнику, не повинен бути пов'язаний з першим ні в якому разі.

Давайте розглянемо конкретний приклад: я хочу зробити пожертву політичному руху через BIP47:
- Організація зробила свій платіжний код публічним на своєму вебсайті або через свої соціальні мережі;
- Цей код таким чином пов'язаний з політичним рухом;
- Я отримую цей платіжний код;
- Перед тим, як приступити до відправлення, я повинен переконатися, що вони знають мій власний платіжний код, який також пов'язаний з моєю особистістю, оскільки я використовую його для отримання транзакцій у моїх соціальних мережах.

Як безризиково передати мій код? Використання звичайних засобів комунікації може призвести до витоку інформації, і, як наслідок, асоціювати мене з цим політичним рухом. Транзакція сповіщення пропонує рішення завдяки шару шифрування, який саме й запобігає цьому асоціюванню між двома кодами. Хоча це не єдиний метод таємної передачі платіжного коду відправника, він виявляється дуже ефективним.

На діаграмі нижче помаранчеві лінії вказують точки, де потік інформації має бути перерваний, а чорні стрілки показують з'єднання, які потенційно можуть бути спостережені третіми сторонами:
![BTC204](assets/en/66/16.webp)
На практиці, у традиційній моделі конфіденційності Bitcoin, часто складно повністю роз'єднати потік інформації між парою ключів і користувачем, особливо під час віддалених транзакцій. Наприклад, у контексті кампанії збору пожертв, одержувач неодмінно має розкрити адресу або публічний ключ через свій вебсайт або соціальні мережі. Правильне використання BIP47, зокрема з транзакцією сповіщення, дозволяє обійти цю проблему завдяки ECDHE і шару шифрування, який ми детальніше розглянемо.

Звичайно, класична модель конфіденційності Bitcoin все ще застосовується до ефемерних публічних ключів, які походять з комбінації двох платіжних кодів. Обидві моделі насправді доповнюють одна одну. Те, що я хочу тут підкреслити, це те, що на відміну від звичайного використання публічного ключа для отримання біткойнів, платіжний код може бути пов'язаний з певною особистістю, оскільки інформація "_Аліса здійснює транзакцію з Бобом_" переривається на іншому етапі. Платіжний код використовується для генерації платіжних адрес, але лише на основі спостереження за блокчейном неможливо пов'язати транзакцію платежу BIP47 з використаними платіжними кодами, якщо тільки UTXO, що беруть участь, вже не були пов'язані з особистістю раніше і користувачі не асоціювали свої платіжні коди зі своїми особистостями.

Підсумовуючи, модель конфіденційності, яку пропонує платежі BIP47, можна вважати кращою, ніж базова модель Bitcoin, хоча вона й не є чарівною.

### Конструкція транзакції сповіщення

Тепер давайте подивимося, як працює ця транзакція сповіщення. Уявімо, що Аліса хоче відправити кошти Бобу з BIP47. У моєму прикладі, Аліса виступає як відправник, а Боб - як одержувач. Останній опублікував свій платіжний код на своєму вебсайті. Тому Аліса вже знає платіжний код Боба.

**1- Аліса розраховує спільний секрет за допомогою ECDH:**

- Вона вибирає пару ключів зі свого HD гаманця, розташовану на іншій гілці від її платіжного коду. Зауважте, ця пара не повинна бути легко асоційована з адресою сповіщення Аліси, ні з особистістю Аліси (див. попередній розділ);

- Аліса вибирає приватний ключ з цієї пари. Ми називаємо його $a$ (маленька літера);

$$
a
$$
- Аліса отримує публічний ключ, асоційований з адресою сповіщення Боба. Цей ключ є першою похідною від платіжного коду Боба (індекс $/0$). Ми називаємо цей публічний ключ $B$ (велика літера). Приватний ключ, асоційований з цим публічним ключем, називається $b$ (маленька літера). $B$ визначається шляхом додавання і подвоєння точок на еліптичній кривій від $G$ (точка генератора) з $b$ (приватний ключ):
$$ B = b \cdot G $$
- Аліса обчислює секретну точку $S$ (з великої літери) на еліптичній кривій шляхом додавання та подвоєння точок, застосовуючи свій приватний ключ $a$ до публічного ключа Боба $B$.
$$ S = a \cdot B $$

- Аліса обчислює коефіцієнт засліплення $f$, який дозволить їй зашифрувати свій код платежу. Для цього вона визначає псевдовипадкове число за допомогою функції HMAC-SHA512. У другому вході цієї функції вона використовує значення, яке зможе отримати лише Боб: $x$, яке є абсцисою раніше обчисленої секретної точки. Перший вхід - це $o$, яке є UTXO, споживаним на вході цієї транзакції (outpoint).

$$ f = \text{HMAC-SHA512}(o, x) $$

**2- Аліса перетворює свій особистий код платежу в двійкову систему (бінарний формат).**

**3- Вона використовує цей коефіцієнт засліплення як ключ для виконання симетричного шифрування вантажу свого коду платежу.** Алгоритм шифрування, який використовується, просто `XOR`. Операція, яка виконується, порівнянна з шифром Вернама, також названим "Одноразовий блокнот".

- Аліса спочатку розділяє свій коефіцієнт засліплення на дві частини: перші 32 байти називаються $f1$, а останні 32 байти називаються $f2$. Таким чином, ми маємо:

$$ f = f1 || f2 $$

- Аліса обчислює зашифровану $x'$ абсцису публічного ключа $x$ свого коду платежу, та зашифровану $c'$ свого ланцюгового коду $c$ окремо. $f1$ та $f2$ діють відповідно як ключі шифрування. Використовувана операція - це `XOR` (виключне або).

$$ x' = x \oplus f1 $$
$$ c' = c \oplus f2 $$

- Аліса замінює реальні значення абсциси публічного ключа $x$ та ланцюгового коду $c$ у своєму коді платежу на зашифровані значення $x'$ та $c'$.
**4-** Наразі Аліса має свій код платежу з зашифрованим вантажем. Вона буде створювати та транслювати транзакцію, яка включає її публічний ключ $A$ як вхід, вихід на адресу повідомлень Боба, та вихід `OP_RETURN`, що містить її код платежу з зашифрованим вантажем. **Ця транзакція є транзакцією повідомлення**.
`OP_RETURN` - це опкод, який позначає вихід транзакції Bitcoin як недійсний. Сьогодні він використовується для трансляції або закріплення інформації на блокчейні Bitcoin. Можна зберегти до 80 байтів даних, які записуються на ланцюг і таким чином видимі для всіх інших користувачів.

Як ми бачили в попередніх розділах, ECDH використовується для генерації спільного секрету між двома користувачами, які спілкуються через незахищену мережу, потенційно спостережувану нападниками. У BIP47 ECDH використовується для комунікації через мережу Bitcoin, яка за своєю природою є прозорою комунікаційною мережею, спостережуваною багатьма нападниками. Спільний секрет, обчислений через обмін ключами ECDH, потім використовується для шифрування секретної інформації, яка має бути передана: код платежу відправника (Аліси).

Давайте повторимо кроки, які ми щойно розглянули разом, щоб виконати транзакцію повідомлення:
- Аліса отримує код платежу Боба та адресу повідомлень;
- Аліса вибирає UTXO, яким вона володіє у своєму HD гаманці з відповідною парою ключів;
- Вона обчислює секретну точку на еліптичній кривій, використовуючи ECDH;
- Вона використовує цю секретну точку для обчислення HMAC, який є коефіцієнтом засліплення;
- Вона використовує цей коефіцієнт засліплення для шифрування вантажу свого особистого коду платежу.
- Вона використовує вихід транзакції `OP_RETURN`, щоб передати Бобу замаскований платіжний код.
![BTC204](assets/en/66/17.webp)

### Транзакція сповіщення: Конкретне дослідження

Щоб краще зрозуміти її функціонування, особливо використання `OP_RETURN`, давайте разом розглянемо реальну транзакцію сповіщення. Я виконав таку транзакцію на тестнеті, яку ви можете знайти [натиснувши тут](https://mempool.space/fr/testnet/tx/0e2e4695a3c49272ef631426a9fd2dae6ec3a469e3a39a3db51aa476cd09de2e).

![BTC204](assets/notext/66/18.webp)

Спостерігаючи за цією транзакцією, ми можемо побачити, що вона має один вхід і 4 виходи:
- Перший вихід - це `OP_RETURN`, що містить мій замаскований платіжний код;
- Другий вихід у 546 сатоші вказує на адресу сповіщення мого отримувача;
- Третій вихід у 15,000 сатоші представляє собою плату за послуги, оскільки я використовував Samourai Wallet для створення цієї транзакції;
- Четвертий вихід у 2 мільйони сатоші представляє решту, тобто різницю з мого входу, яка повертається на іншу адресу, що належить мені.
Найцікавіше для вивчення, безумовно, вихід 0, який використовує `OP_RETURN`. Давайте уважніше подивимося, що він містить. Ось `scriptPubKey` у шістнадцятковому форматі:

```text
6a4c50010002b13b2911719409d704ecc69f74fa315a6cb20fdd6ee39bc9874667703d67b164927b0e88f89f3f8b963549eab2533b5d7ed481a3bea7e953b546b4e91b6f50d800000000000000000000000000
```

У цьому скрипті ми можемо розібрати кілька частин. Перш за все, опкоди:

```text
6a4c
```

Серед опкодів ми можемо розпізнати `0x6a`, який позначає `OP_RETURN` і `0x4c`, який позначає `OP_PUSHDATA1`.

Байт, що слідує за цим останнім опкодом, вказує розмір наступного вантажу. Він вказує `0x50`, або 80 байтів:

```text
6a4c50
```

Далі ми маємо метадані мого платіжного коду у відкритому тексті:

```text
010002
```

Зашифрована x-координата публічного ключа мого платіжного коду:

```text
b13b2911719409d704ecc69f74fa315a6cb20fdd6ee39bc9874667703d67b164
```

Зашифрований ланцюговий код мого платіжного коду:

```text
927b0e88f89f3f8b963549eab2533b5d7ed481a3bea7e953b546b4e91b6f50d8
```

І, нарешті, заповнення до досягнення 80 байтів, стандартного розміру `OP_RETURN`:

```text
00000000000000000000000000
```

Щоб краще зрозуміти, ось мій платіжний код у відкритому тексті у форматі base 58:

```text
Порівнюючи мій відкритий код платежу з `OP_RETURN`, помітно, що HRP (`0x47`) та контрольна сума (`0x8604e4db`) не передаються. Це очікувано, оскільки ця інформація призначена для людей.
Далі ми можемо ідентифікувати версію (`0x01`), бітове поле (`0x00`) та парність публічного ключа (`0x02`). І, в кінці коду платежу, порожні байти (`0x00000000000000000000000000`) використовуються для доповнення коду до загальної кількості 80 байтів. Всі ці метадані передаються в незашифрованому вигляді (відкритому).

Нарешті, можна спостерігати, що x-координата публічного ключа (`0x77507c9c17a89cfca2d3af554745d6c2db0e7f6b2721a3941a504933103cc42a`) та ланцюговий код (`0xdd94881210d6e752a9abc8a9fa0070e85184993c4f643f1121dd807dd556d1dc`) були зашифровані. Це становить вантаж коду платежу.

### Що таке XOR?

У попередніх розділах ми бачили, що код платежу передавався в зашифрованому вигляді, використовуючи операцію XOR. Давайте зупинимося, щоб зрозуміти, як працює цей оператор, оскільки він широко використовується в криптографії.

XOR - це побітовий логічний оператор, заснований на булевій алгебрі. З двома бітовими операндами він повертає `1`, якщо біти одного рангу різні, і повертає `0`, якщо біти одного рангу однакові. Ось таблиця істинності XOR на основі значень операндів `D` та `E`:

| D   | E   | D XOR E |
| --- | --- | ------- |
| 0   | 0   | 0       |
| 0   | 1   | 1       |
| 1   | 0   | 1       |
| 1   | 1   | 0       |

Наприклад:

$$
0110 \oplus 1110 = 1000
$$

Або:

$$
010011 \oplus 110110 = 100101
$$

З використанням ECDH, використання XOR як шару шифрування є особливо відповідним. По-перше, через цей оператор, шифрування є симетричним. Це дозволяє одержувачу розшифрувати код платежу за допомогою того ж ключа, що використовувався для шифрування. Ключ шифрування та розшифрування розраховується з спільного секрету завдяки ECDH. Ця симетрія забезпечується завдяки комутативним та асоціативним властивостям оператора XOR:

- Інші властивості:

$$
D \oplus D = 0
$$
D ⊕ 0 = D
- Комутативність:

$$
D \oplus E = E \oplus D
$$

- Асоціативність:

$$
D \oplus (E \oplus Z) = (D \oplus E) \oplus Z = D \oplus E \oplus Z
$$

Якщо:

$$
D \oplus E = L
$$

Тоді:

$$
D \oplus L = D \oplus (D \oplus E) = D \oplus D \oplus E = 0 \oplus E = E \\
\therefore D \oplus L = E
$$

Далі, цей метод шифрування дуже нагадує шифр Вернама (One-Time Pad), єдиний алгоритм шифрування, відомий на сьогодні, який має безумовну (або абсолютну) безпеку. Для того, щоб шифр Вернама мав цю характеристику, ключ шифрування повинен бути абсолютно випадковим, він повинен бути такого ж розміру, як і повідомлення, і він повинен використовуватися лише один раз. У методі шифрування, що використовується тут для BIP47, ключ дійсно має такий самий розмір, як і повідомлення, фактор засліплення точно такого ж розміру, як і конкатенація x-координати публічного ключа з кодом ланцюга коду платежу. Цей ключ шифрування дійсно використовується лише один раз. Однак, цей ключ не є результатом абсолютної випадковості, оскільки він є HMAC. Він скоріше псевдовипадковий. Тому, це не шифр Вернама, але метод схожий.

### Отримання транзакції повідомлення

Тепер, коли Аліса відправила транзакцію повідомлення Бобу, давайте подивимося, як він її інтерпретує. Нагадаємо, Боб повинен мати можливість доступу до платіжного коду Аліси. Без цієї інформації, як ми побачимо в наступному розділі, він не зможе вивести пари ключів, створені Алісою, і тому не зможе отримати доступ до своїх біткойнів, отриманих через BIP47. Наразі вміст платіжного коду Аліси зашифровано. Давайте подивимося, як Боб його розшифровує.

**1-** Боб моніторить транзакції, які створюють виходи на його адресу повідомлень.

**2-** Коли транзакція має вихід на його адресу повідомлень, Боб аналізує її, щоб побачити, чи містить вона вихід OP_RETURN, який відповідає стандарту BIP47.

**3-** Якщо перший байт вмісту OP_RETURN є `0x01`, Боб починає пошук можливого спільного секрету з ECDH:
- Боб вибирає публічний ключ у вході транзакції. Тобто, публічний ключ Аліси позначений $A$ з:

$$ A = a \cdot G $$

- Боб вибирає приватний ключ $b$, асоційований з його особистою адресою повідомлень:

$$ b $$
- Боб розраховує секретну точку $S$ (спільний секрет ECDH) на еліптичній кривій, додаючи та подвоюючи точки, застосовуючи свій приватний ключ $b$ до публічного ключа Аліси $A$:
$$ S = b \cdot A $$

- Боб визначає фактор засліплення $f$, який дозволить йому розшифрувати вміст платіжного коду Аліси. Так само, як Аліса раніше розрахувала, Боб знайде $f$, застосувавши HMAC-SHA512 на $x$ x-координату секретної точки $S$, і на $o$ UTXO, використане як вхід у цій транзакції повідомлення:

$$ f = \text{HMAC-SHA512}(o, x) $$

**4-** Боб інтерпретує дані в OP_RETURN транзакції повідомлення як платіжний код. Він просто розшифровує вміст цього потенційного платіжного коду, використовуючи фактор засліплення $f$:
- Боб ділить фактор засліплення $f$ на 2 частини: перші 32 байти $f$ будуть $f1$, а останні 32 байти будуть $f2$;
- Боб розшифровує зашифровану x-координату $x'$ публічного ключа з платіжного коду Аліси:

$$ x = x' \oplus f1 $$

- Боб розшифровує зашифроване значення ланцюгового коду $c'$ з платіжного коду Аліси:

$$ c = c' \oplus f2 $$

**5-** Боб перевіряє, чи дійсно значення публічного ключа з платіжного коду Аліси є частиною групи secp256k1. Якщо це так, він інтерпретує це як дійсний платіжний код. В іншому випадку, він ігнорує цю транзакцію.

Тепер, коли Боб знає платіжний код Аліси, вона може надіслати йому до `2^32` платежів, не потребуючи знову робити іншу повідомляючу транзакцію цього типу.

Чому це працює? Як Боб може визначити той самий фактор засліплення, що й Аліса, і таким чином розшифрувати її платіжний код? Давайте детальніше розглянемо роль ECDH у тому, що ми щойно описали.

Перш за все, ми маємо справу з симетричним шифруванням. Це означає, що ключ шифрування та ключ розшифрування є однаковими значеннями. Цей ключ у повідомляючій транзакції є фактором засліплення:

$$ f = f1 || f2 $$

Таким чином, Аліса та Боб повинні отримати однакове значення для $f$, не передаючи його безпосередньо, оскільки атакуючий міг би вкрасти його та розшифрувати секретну інформацію. Цей фактор засліплення отримується застосуванням HMAC-SHA512 до 2 значень:
- x-координати секретної точки;
- та UTXO, використаного як вхід у транзакції.
Отже, Бобу потрібні ці дві інформації, щоб розшифрувати вміст платіжного коду Аліси. Для UTXO як входу, Боб може просто отримати його, спостерігаючи за повідомляючою транзакцією. Для секретної точки, Бобу доведеться використати ECDH. Як було показано в попередньому розділі про Diffie-Hellman, просто обмінюючись відповідними публічними ключами та таємно застосовуючи свої приватні ключі до публічного ключа іншого, Аліса та Боб можуть знайти конкретну та секретну точку на еліптичній кривій. Повідомляюча транзакція покладається на цей механізм:
- Пара ключів Боба:

$$ B = b \cdot G $$

- Пара ключів Аліси:

$$ A = a \cdot G $$

- Для секрету $S (x, y)$:

$$ S = a \cdot B = a \cdot (b \cdot G) = (b \cdot a) \cdot G = b \cdot A $$

![BTC204](assets/en/66/19.webp)

Тепер, коли Боб знає платіжний код Аліси, він зможе виявляти її BIP47 платежі, і він може виводити приватні ключі, які блокують отримані біткоїни.

Давайте підсумуємо кроки, через які ми щойно пройшли, щоб отримати та інтерпретувати повідомляючу транзакцію:
- Боб моніторить вихідні транзакції на свою повідомляючу адресу;
- Коли він виявляє одну, він отримує інформацію, міститься в OP_RETURN;
- Боб вибирає публічний ключ на вході та розраховує секретну точку, використовуючи ECDH;
- Він використовує цю секретну точку для розрахунку HMAC, який є фактором засліплення;
- Він використовує цей фактор засліплення, щоб розшифрувати вміст платіжного коду Аліси, міститься в OP_RETURN.

![BTC204](assets/en/66/20.webp)

### Транзакція платежу BIP47

Давайте тепер разом розглянемо процес платежу з BIP47. Щоб нагадати вам поточний стан справ:
- Аліса знає платіжний код Боба, який вона просто отримала з його вебсайту;
- Боб знає платіжний код Аліси завдяки транзакції-сповіщенню;
- Аліса здійснить перший платіж Бобу. Вона зможе зробити багато інших таким же чином.

Перед тим, як пояснити цей процес, я вважаю важливим нагадати про індекси, над якими ми зараз працюємо. Шлях похідності платіжного коду описується так: `m/47'/0'/0'`. Наступний рівень розподіляє індекси таким чином:
- Перша звичайна (не посилена) пара дочірніх ключів використовується для генерації адреси сповіщення, про яку ми говорили в попередній частині: `m/47'/0'/0'/0`;
- Звичайні дочірні пари ключів використовуються в ECDH для генерації адрес прийому платежів BIP47, як ми побачимо в цьому розділі: від `m/47'/0'/0'/0` до `m/47'/0'/0'/2 147 483 647`;
- Посилені дочірні пари ключів - це ефемерні платіжні коди: від `m/47'/0'/0'/0'` до `m/47'/0'/0'/2 147 483 647'`.

Коли Аліса бажає надіслати платіж Бобу, вона виводить нову унікальну невикористану адресу, знову ж таки завдяки протоколу ECDH:
- Аліса вибирає перший приватний ключ, похідний від її особистого багаторазового платіжного коду:

$$ a $$

- Аліса вибирає перший невикористаний публічний ключ, похідний від платіжного коду Боба. Цей публічний ключ, ми назвемо його $B$. Він асоційований з приватним ключем $b$, який знає лише Боб:

$$ B = b \cdot G $$

- Аліса розраховує секретну точку $S$ на еліптичній кривій, застосовуючи додавання та подвоєння точок, використовуючи свій приватний ключ $a$ до публічного ключа Боба $B$:

$$ S = a \cdot B $$

- З цієї секретної точки Аліса розраховує спільний секрет $s$ (маленька літера). Для цього вона вибирає x-координату секретної точки $S$, названу $Sx$, і пропускає це значення через функцію хешування SHA256:

$$ S = (Sx, Sy) $$
$$ s = \text{SHA256}(Sx) $$

- Аліса використовує цей спільний секрет $s$ для розрахунку адреси прийому платежів Bitcoin. Спочатку вона перевіряє, чи міститься $s$ в межах порядку кривої secp256k1. Якщо ні, вона збільшує індекс публічного ключа Боба для виведення іншого спільного секрету;
- По-друге, вона розраховує публічний ключ $K0$, додаючи на еліптичній кривій точки $B$ та $s·G$. Іншими словами, Аліса додає публічний ключ, похідний від платіжного коду Боба $B$, з іншою точкою, розрахованою на еліптичній кривій за допомогою додавання та подвоєння точок зі спільним секретом $s$ від точки генерації кривої secp256k1 $G$. Ця нова точка представляє публічний ключ, і ми називаємо її $K0$:

$$ K0 = B + s \cdot G $$

- З цим публічним ключем $K0$ Аліса може вивести стандартну невикористану адресу прийому (наприклад, SegWit V0 у форматі bech32).
Як тільки Аліса отримає адресу прийому Боба $K0$, вона може здійснити транзакцію Bitcoin стандартним способом. Для цього вона вибирає UTXO, яким володіє, захищений парою ключів з іншої гілки її HD-гаманця, і витрачає його, щоб задовольнити вихід на адресу Боба $K0$. Важливо зазначити, що цей платіж, як тільки адреса виведена, слідує звичайному процесу і більше не залежить від ключів, асоційованих з BIP47.
Давайте підсумуємо кроки, які ми щойно пройшли разом, щоб здійснити платіж BIP47:
- Аліса вибирає перший похідний дочірній приватний ключ зі свого особистого платіжного коду;
- Вона розраховує секретну точку на еліптичній кривій, використовуючи ECDH з першого невикористаного похідного дочірнього публічного ключа з платіжного коду Боба;
- Вона використовує цю секретну точку для розрахунку спільного секрету за допомогою SHA256;
- Вона використовує цей спільний секрет для розрахунку нової секретної точки на еліптичній кривій;
- Вона додає цю нову секретну точку до публічного ключа Боба;
- Вона отримує новий ефемерний публічний ключ, для якого тільки Боб має асоційований приватний ключ;
- Аліса може зробити стандартну транзакцію Бобу з похідною ефемерною адресою отримання.

![BTC204](assets/en/66/21.webp)

Якщо Аліса хоче зробити другий платіж, вона слідуватиме тим самим крокам, як і раніше, за винятком того, що цього разу вона вибере другий похідний публічний ключ з платіжного коду Боба. Зокрема, вона використовуватиме наступний невикористаний ключ. Таким чином, вона отримає нову адресу отримання, яка належить Бобу, позначену $K1$:

![BTC204](assets/en/66/22.webp)

Вона може продовжувати в цьому дусі та отримати до `2^32` невикористаних адрес, які належать Бобу.

З зовнішньої точки зору, спостерігаючи за блокчейном, теоретично неможливо відрізнити платіж BIP47 від стандартного платежу. Ось приклад транзакції платежу BIP47 на Testnet:

```text
94b2e59510f2e1fa78411634c98a77bbb638e28fb2da00c9f359cd5fc8f87254
```

Це виглядає як стандартна транзакція з використаним входом, вихідним платежем і рештою:

![BTC204](assets/notext/66/23.webp)

### Отримання платежу BIP47 та похідний приватний ключ

Аліса щойно здійснила свій перший платіж на нову адресу BIP47, яка належить Бобу. Тепер давайте подивимося, як Боб отримує цей платіж. Ми також побачимо, чому Аліса не має доступу до приватного ключа адреси, яку вона щойно згенерувала сама, і як Боб отримує цей ключ, щоб витратити біткойни, які він щойно отримав.
Як тільки Боб отримує транзакцію-сповіщення від Аліси, він похідно отримує публічний ключ BIP47 $K0$ ще до того, як вона відправила будь-який платіж. Потім він стежить за будь-якими платежами на асоційовану адресу. Насправді, він одразу похідно отримує кілька адрес, за якими він буде стежити ($K0$, $K1$, $K2$, $K3$...). Ось як він отримує цей публічний ключ $K0$:
- Боб вибирає перший похідний дочірній приватний ключ зі свого платіжного коду. Цей приватний ключ називається $b$. Він асоційований з публічним ключем $B$, з яким Аліса проводила свої розрахунки на попередньому кроці:

$$ b $$

- Боб вибирає перший публічний ключ Аліси, похідний з її платіжного коду. Цей ключ називається $A$. Він асоційований з приватним ключем $a$, з яким Аліса проводила свої розрахунки, і про який тільки Аліса знає. Боб може провести цей процес, оскільки він знає платіжний код Аліси, який був переданий йому з транзакцією-сповіщенням:

$$ A = a \cdot G $$

- Боб розраховує секретну точку $S$, за допомогою додавання та подвоєння точок на еліптичній кривій, застосовуючи свій приватний ключ $b$ до публічного ключа Аліси $A$. Тут ми знаходимо використання ECDH, яке гарантує, що ця точка $S$ буде однаковою як для Боба, так і для Аліси:

$$ S = b \cdot A $$
- Так само, як і Аліса, Боб ізолює x-координату цієї точки $S$. Ми назвали це значення $Sx$. Він пропускає це значення через функцію SHA256, щоб знайти спільний секрет $s$ (маленькими літерами):
$$ s = \text{SHA256}(Sx) $$

- Так само, як і Аліса, Боб розраховує точку $s·G$ на еліптичній кривій. Потім він додає цю секретну точку до свого публічного ключа $B$. Після цього він отримує нову точку на еліптичній кривій, яку він інтерпретує як публічний ключ $K0$:

$$ K0 = B + s \cdot G $$

Як тільки Боб має цей публічний ключ $K0$, він може вивести відповідний приватний ключ, щоб мати можливість витрачати свої біткоїни. Він єдиний, хто може згенерувати цей приватний ключ:

- Боб додає свій дочірній приватний ключ $b$, отриманий з його особистого платіжного коду. Він єдиний, хто може отримати значення $b$. Потім він додає $b$ зі спільним секретом $s$, щоб отримати $k0$, приватний ключ $K0$:

$$ k0 = b + s $$

Завдяки закону групи еліптичної кривої, Боб отримує точно той приватний ключ, який відповідає публічному ключу, який використовувала Аліса. Таким чином, ми маємо:

$$ K0 = k0 \cdot G $$
Я підсумую кроки, які ми щойно пройшли разом, щоб отримати платіж BIP47 і розрахувати відповідний приватний ключ:
- Боб вибирає перший похідний дочірній приватний ключ зі свого особистого платіжного коду;
- Він розраховує секретну точку на еліптичній кривій, використовуючи ECDH з першого похідного дочірнього публічного ключа з ланцюга кодів Аліси;
- Він використовує цю секретну точку, щоб розрахувати спільний секрет за допомогою SHA256;
- Він використовує цей спільний секрет, щоб розрахувати нову секретну точку на еліптичній кривій;
- Він додає цю нову секретну точку до свого особистого публічного ключа;
- Він отримує новий ефемерний публічний ключ, на який Аліса надішле свій перший платіж;
- Боб розраховує приватний ключ, асоційований з цим ефемерним публічним ключем, додаючи свій похідний дочірній приватний ключ зі свого платіжного коду та спільний секрет.

![BTC204](assets/en/66/24.webp)

Оскільки Аліса не може отримати $b$ (приватний ключ Боба), вона не може визначити $k0$ (приватний ключ, асоційований з адресою отримання BIP47 Боба). Схематично ми можемо представити розрахунок спільного секрету $S$ так:

![BTC204](assets/en/66/19.webp)

Як тільки спільний секрет знайдено за допомогою ECDH, Аліса та Боб розраховують публічний ключ платежу BIP47 $K0$, а Боб також розраховує асоційований приватний ключ $k0$:

![BTC204](assets/en/66/25.webp)

### Повернення платежу BIP47

Оскільки Боб знає повторно використовуваний платіжний код Аліси, він вже має всю необхідну інформацію, щоб надіслати їй повернення коштів. Йому не потрібно буде знову зв'язуватися з Алісою, щоб запитати будь-яку інформацію. Йому просто потрібно буде повідомити її за допомогою транзакції повідомлення, особливо, щоб вона могла отримати свої адреси BIP47 за допомогою свого seed, а потім він також може надіслати їй до `2^32` платежів.

Функціонал повернення коштів є специфічним для BIP47 і є однією з його переваг порівняно з іншими методами, які ми вивчатимемо в наступних розділах, такими як Silent Payments.

Боб може потім повернути Алісі кошти таким же чином, як вона надсилала йому платежі. Ролі обертаються:

![BTC204](assets/en/66/26.webp)
*Велике спасибі [Фанісу Міхалакісу](https://x.com/FanisMichalakis) за його рецензію та цінні професійні поради щодо статті, яка надихнула на написання цього розділу!*
https://planb.network/tutorials/privacy/paynym-bip47

## Тихі Платежі
<chapterId>2871d594-414e-4598-a830-91c9eb84dfb8</chapterId>
BIP47 критикували за його неефективність в блокчейні. Як пояснено в попередньому розділі, він вимагає повідомлення транзакції для кожного нового одержувача. Це обмеження стає незначним, якщо планується встановити тривалий платіжний канал з цим одержувачем. Дійсно, одна транзакція повідомлення відкриває шлях для майже нескінченної кількості наступних платежів BIP47.

Однак, у певних ситуаціях, транзакція повідомлення може стати перешкодою для користувача. Візьміть, наприклад, одноразовий донат одержувачу: з класичною адресою Bitcoin достатньо однієї транзакції, щоб зробити донат. Але з BIP47 необхідні дві транзакції: одна для повідомлення та інша для самого платежу. Коли попит на блок-простір низький і комісії за транзакції мінімальні, цей додатковий крок, як правило, не є проблемою. Однак, під час періодів конгестії, комісії за транзакції можуть стати величезними для одного платежу, потенційно подвоюючи вартість для користувача порівняно зі стандартною транзакцією Bitcoin, що може бути неприйнятним для користувача.

Для ситуацій, коли користувач планує зробити лише кілька платежів на статичний ідентифікатор, були розроблені інші рішення. Серед них - Тихі Платежі, описані в [BIP352](https://github.com/bitcoin/bips/blob/master/bip-0352.mediawiki). Цей протокол дозволяє використовувати статичний ідентифікатор для отримання платежів без генерації повторного використання адреси та без необхідності використання транзакцій повідомлень. Давайте розглянемо, як працює цей протокол.

---

*Для повного розуміння цього розділу необхідно бути знайомим з принципами роботи ECDH (Еліптична крива Діффі-Хеллмана) та криптографічного похідного ключа в HD гаманці. Ці концепції були детально описані в попередньому розділі про BIP47. Я не буду повторювати їх тут знову. Якщо ви ще не знайомі з цими поняттями, я рекомендую ознайомитися з попереднім розділом перед продовженням читання цього. Я також не буду повторювати ризики, пов'язані з повторним використанням адрес отримувачів, ані важливість мати унікальний ідентифікатор для отримання платежів.*

---

### Чому б не перемістити повідомлення?

Як обговорювалося в розділі про BIP47, транзакція повідомлення виконує переважно дві функції:
- Вона повідомляє одержувача;
- Вона передає платіжний код відправника.

Можна наївно подумати, що цей процес повідомлення міг би бути здійснений поза ланцюгом. Теоретично, це цілком здійсненно: достатньо було б для одержувача вказати засіб комунікації для отримання платіжних кодів BIP47 від відправників. Однак, цей підхід представляє дві основні проблеми:
- По-перше, це перенесло б процес передачі коду на інший протокол комунікації. Проблеми, пов'язані з витратами та конфіденційністю обміну, залишалися б, але просто були б перенесені на цей новий протокол. З точки зору конфіденційності, це також могло б створити зв'язок між ідентичністю користувача та діяльністю в ланцюгу, чого ми прагнемо уникнути, виконуючи повідомлення безпосередньо в блокчейні. Більше того, виконання повідомлення поза блокчейном вводило б ризики цензури (такі як блокування коштів), які не існують в Bitcoin;
- Далі, це створює проблему відновлення. З BIP47, одержувач абсолютно повинен знати платіжні коди відправників, щоб отримати доступ до коштів. Це актуально в момент отримання, але також у випадку відновлення коштів через seed у разі втрати гаманця. З onchain повідомленнями, цей ризик уникається, оскільки користувач може знайти та розшифрувати транзакції повідомлень, просто знаючи свій seed. Однак, якщо повідомлення виконується поза блокчейном, користувачеві потрібно буде підтримувати динамічний бекап усіх отриманих платіжних кодів, що є непрактичним для середнього користувача.
Усі ці обмеження роблять використання onchain повідомлень незамінним у контексті BIP47. Проте, Silent Payments спеціально прагнуть уникнути цього кроку onchain повідомлення через його вартість. Тому, прийняте рішення не переміщати повідомлення, а повністю його усунути. Для досягнення цього, має бути прийнятий компроміс: сканування. На відміну від BIP47, де користувач точно знає, де знайти свої кошти завдяки транзакціям повідомлень, у контексті Silent Payments, користувач мусить перевіряти всі існуючі Bitcoin транзакції, щоб виявити будь-які платежі, які могли бути призначені для нього. Для зменшення цього оперативного навантаження, пошук Silent Payments обмежується лише транзакціями, які ймовірно містять такі платежі, а саме тими, що включають принаймні один Taproot P2TR вихід. Сканування також зосереджується виключно на транзакціях з дати створення гаманця (немає потреби сканувати транзакції, що йдуть назад до 2009 року, якщо гаманець був створений у 2024 році).

Тому, ви можете бачити, чому BIP47 і Silent Payments, хоча й прагнуть до схожої мети, передбачають різні компроміси і **таким чином, насправді, задовольняють різні випадки використання**. Для одноразових платежів, таких як випадкові донати, Silent Payments більш підходящі через їхню нижчу вартість. Навпаки, для регулярних транзакцій до одного й того ж одержувача, як у випадку з біржами або майнінговими пулами, BIP47 може бути більш переважним.
Давайте разом дослідимо технічні аспекти Silent Payments, щоб краще зрозуміти їхні наслідки. Для цього я пропоную взяти той самий підхід, як і в пояснювальному документі BIP352. Ми поступово розберемо розрахунки, які потрібно виконати, елемент за елементом, обґрунтовуючи кожне нове додавання.
### Деякі концепції для розуміння

Перед тим як ми почнемо, важливо уточнити, що Silent Payments спираються виключно на використання типів скриптів P2TR (*Pay to Taproot*). На відміну від BIP47, не потрібно виводити адреси отримання з дочірніх публічних ключів шляхом їх хешування. Дійсно, у стандарті P2TR, модифікований публічний ключ використовується безпосередньо та відкрито в адресі. Таким чином, Taproot адреса отримання є по суті публічним ключем, доповненим деякими метаданими. Цей модифікований публічний ключ є агрегацією двох інших публічних ключів: один дозволяє пряме та традиційне витрачання через простий підпис, а інший представляє корінь Merkle MAST, який дозволяє витрачання за умови задоволення однієї з потенційно записаних у Merkle дереві умов.

![BTC204](assets/en/67/01.webp)

Рішення обмежити Silent Payments виключно Taproot мотивоване двома основними причинами:
- Перше, це значно полегшує імплементацію та майбутні оновлення в програмному забезпеченні гаманців, оскільки потрібно дотримуватися лише одного стандарту;
- Друге, цей підхід допомагає покращити анонімний набір користувачів, заохочуючи їх не розпорошуватися серед різних типів скриптів, які генерують різні відбитки гаманців у аналізі ланцюга (для більшої інформації про цю концепцію, я запрошую вас ознайомитися з главою 4 частини 2).

### Наївне виведення публічного ключа Silent Payments
Давайте почнемо з простого прикладу, який допоможе вам зрозуміти основні принципи роботи SP (Silent Payments, Тихі Платежі). Візьмемо Алісу та Боба, двох користувачів Bitcoin. Аліса хоче відправити біткоїни Бобу на нову адресу отримання. У цьому процесі мають бути досягнуті три цілі:
- Аліса має змогу генерувати нову адресу;
- Боб має змогу ідентифікувати платіж, відправлений на цю конкретну адресу;
- Боб має змогу отримати приватний ключ, асоційований з цією адресою, щоб мати можливість витрачати свої кошти.

У гаманці Аліси є UTXO, захищений наступною парою ключів:
- $a$: приватний ключ;
- $A$: публічний ключ ($A = a \cdot G$)

У Боба є SP адреса, яку він опублікував в інтернеті з:
- $b$: приватний ключ;
- $B$: публічний ключ ($B = b \cdot G$)
Отримавши адресу Боба, Аліса може розрахувати нову порожню адресу, яка належить Бобу, використовуючи ECDH. Назвемо цю адресу $P$:
$$  P = B + \text{hash}(a \cdot B) \cdot G  $$

У цьому рівнянні Аліса просто розрахувала скалярний добуток свого приватного ключа $a$ та публічного ключа Боба $B$. Вона передала цей результат через хеш-функцію, відому всім. Отримане значення потім множиться на скаляр з генераторною точкою $G$ еліптичної кривої `secp256k1`. Нарешті, Аліса додає отриману точку до публічного ключа Боба $B$. Отримавши цю адресу $P$, вона використовує її як вихід у транзакції, тобто відправляє біткоїни на неї.

> *У контексті Silent Payments, функція "hash" відповідає хеш-функції SHA256, спеціально позначеної як `BIP0352/SharedSecret`, що забезпечує унікальність генерованих хешів для цього протоколу і не дозволяє їх повторне використання в інших контекстах, а також надає додатковий захист від повторного використання nonce у підписах. Цей стандарт відповідає тому, [що вказано в BIP340 для Schnorr підписів](https://github.com/bitcoin/bips/blob/master/bip-0340.mediawiki) на `secp256k1`.*

Завдяки властивостям еліптичної кривої, на якій базується ECDH, ми знаємо, що:

$$  a \cdot B = b \cdot A  $$

Таким чином, Боб зможе розрахувати адресу отримання, на яку Аліса відправила біткоїни. Для цього він моніторить усі транзакції Bitcoin, які відповідають критеріям Silent Payments, і застосовує наступний розрахунок до кожної з них, щоб побачити, чи адресований платіж йому (*сканування*):

$$  P' = B + \text{hash}(b \cdot A) \cdot G  $$

Коли він сканує транзакцію Аліси, він усвідомлює, що $P'$ дорівнює $P$. Таким чином, він знає, що цей платіж адресований йому:

$$  P' = B + \text{hash}(b \cdot A) \cdot G = B + \text{hash}(a \cdot B) \cdot G = P   $$

Звідси Боб зможе розрахувати приватний ключ $p$, який дозволяє витрачати кошти з адреси $P$:

$$  p = (b + \text{hash}(b \cdot A)) \bmod n  $$

Як ви можете бачити, для розрахунку цього приватного ключа $p$ обов'язково має бути приватний ключ $b$. Тільки Боб має цей приватний ключ $b$. Таким чином, він дійсно буде єдиним, хто зможе витрачати біткоїни, відправлені на його адресу Silent Payments.

![BTC204](assets/notext/67/02.webp)
*Підпис:*
- $B$: Публічний ключ / статична адреса, опублікована Бобом
- $b$: Приватний ключ Боба
- $A$: Публічний ключ UTXO Аліси, що використовується як вхід для транзакції
- $a$: Приватний ключ Аліси
- $G$: Точка генерації еліптичної кривої `secp256k1`
- $\text{SHA256}$: Функція хешування SHA256 з тегом `BIP0352/SharedSecret`
- $s$: Спільний секрет ECDH
- $P$: Публічний ключ / унікальна адреса для оплати Бобу

Ось спочатку досить наївний підхід до використання статичної адреси Боба, позначеної як $B$, для отримання унікальної адреси $P$ для відправлення біткойнів. Однак, цей метод занадто спрощений і має кілька недоліків, які потребують виправлення. Перша проблема полягає в тому, що в цій схемі Аліса не може створити кілька виходів для Боба в рамках однієї транзакції.

### Як створити кілька виходів?

У прикладі з попереднього розділу Аліса створює один вихід, який піде Бобу на його унікальну адресу $P$. З тим самим вибраним входом неможливо для Аліси створити дві окремі первинні адреси для Боба, оскільки використаний метод завжди призводить до одного й того ж результату для $P$, отже, до тієї ж адреси. Однак, може бути багато ситуацій, коли Аліса бажає розділити свій платіж Бобу на кілька менших сум, таким чином створюючи кілька UTXO. Тому необхідно знайти метод, який дозволить це зробити.

Для досягнення цього ми трохи змінимо розрахунок, який виконує Аліса для отримання $P$, так щоб вона могла генерувати дві різні адреси для Боба, а саме $P_0$ і $P_1$.

Щоб змінити розрахунок і отримати 2 різні адреси, достатньо додати ціле число, яке змінює результат. Таким чином, Аліса додасть $0$ у свій розрахунок, щоб отримати адресу $P_0$ і $1$, щоб отримати адресу $P_1$. Назвемо це ціле число $i$:

$$  P_i = B + \text{hash}(a \cdot B \text{ ‖ } i) \cdot G  $$

Процес розрахунку залишається незмінним з попереднього методу, за винятком того, що цього разу Аліса конкатенує $a \cdot B$ з $i$ перед тим, як приступити до хешування. Потім достатньо змінити $i$, щоб мати нову адресу, що належить Бобу. Наприклад:

$$  P_0 = B + \text{hash}(a \cdot B \text{ ‖ } 0) \cdot G  $$

$$  P_1 = B + \text{hash}(a \cdot B \text{ ‖ } 1) \cdot G  $$
Коли Боб сканує блокчейн на предмет Silent Payments, призначених для нього, він починає з використання $i = 0$ для адреси $P_0$. Якщо він не знаходить платежу на $P_0$, він робить висновок, що ця транзакція не містить жодних Silent Payments для нього і припиняє її аналіз. Однак, якщо $P_0$ є дійсним і містить платіж для нього, він продовжує з $P_1$ в тій же транзакції, щоб перевірити, чи зробила Аліса другий платіж. Якщо $P_1$ виявляється недійсним, він припиняє свій пошук цієї транзакції; в іншому випадку, він продовжує тестувати послідовні значення $i$.
$$  P_1 = B + \text{hash}(b \cdot A \text{ ‖ } 1) \cdot G  $$
Оскільки Боб негайно зупиняється на $i = 0$, якщо $P_0$ не дає результату, використання цього цілого числа майже не додає додаткового оперативного навантаження на Боба для етапу сканування транзакцій.

Потім Боб може розрахувати приватні ключі таким самим чином:

$$ 
p_0 = (b + \text{hash}(b \cdot A \text{ ‖ } 0)) \bmod n
 $$

$$ 
p_1 = (b + \text{hash}(b \cdot A \text{ ‖ } 1)) \bmod n 
 $$

![BTC204](assets/notext/67/03.webp)

*Підпис:*
- $B$: Публічний ключ / статична адреса, опублікована Бобом
- $b$: Приватний ключ Боба
- $A$: Публічний ключ UTXO Аліси, який використовується як вхід для транзакції
- $a$: Приватний ключ Аліси
- $G$: Точка генератора еліптичної кривої `secp256k1`
- $\text{SHA256}$: Хеш-функція SHA256 з тегом `BIP0352/SharedSecret`
- $s_0$: Перший спільний секрет ECDH
- $s_1$: Другий спільний секрет ECDH
- $P_0$: Перший публічний ключ / унікальна адреса для платежу Бобу
- $P_1$: Другий публічний ключ / унікальна адреса для платежу Бобу

За допомогою цього методу ми починаємо мати гарний протокол, але все ще існують деякі виклики, які потрібно подолати, зокрема, запобігання повторному використанню адрес.

### Як уникнути повторного використання адрес?
Як ми бачили в попередніх розділах, Аліса використовує пару ключів, які захищають її UTXO, який вона витратить, щоб розрахувати спільний секрет ECDH з Бобом. Цей секрет дозволяє їй отримати унікальну адресу $P_0$. Однак, пара ключів ($a$, $A$), яку використовує Аліса, може захищати кілька UTXO, якщо вона кілька разів використовувала цю адресу. У випадку, якщо Аліса робить два платежі на статичну адресу Боба $B$, використовуючи два UTXO, захищені тим самим ключем $A$, це призведе до повторного використання адреси для Боба.
> *Повторне використання адреси є дуже поганою практикою для конфіденційності користувача. Щоб зрозуміти чому, я раджу вам переглянути перші частини цього навчання.*

Дійсно, оскільки унікальна адреса $P_0$ походить від $A$ і $B$, якщо Аліса отримує другу адресу для другого платежу до $B$ з тим самим ключем $A$, вона отримає ту саму адресу $P_0$. Щоб уникнути цього ризику та запобігти повторному використанню адрес у рамках Silent Payments, нам потрібно трохи змінити наші розрахунки.

Те, що ми хочемо, це для кожного UTXO, витраченого Алісою як вхід платежу, давати унікальну адресу з боку Боба, навіть якщо кілька UTXO захищені тією самою парою ключів. Тому достатньо додати посилання на UTXO у розрахунок унікальної адреси $P_0$. Це посилання просто буде хешем UTXO, використаного як вхід:

$$  \text{inputHash} = \text{hash}(\text{outpoint} \text{ ‖ } A)  $$

І це посилання на вхід, Аліса додасть у свій розрахунок унікальної адреси $P_0$:
$$  P_0 = B + \text{hash}(\text{inputHash} \cdot a \cdot B \text{ ‖ } 0) \cdot G  $$
Під час свого сканування Боб також може додати $\text{inputHash}$, оскільки все, що йому потрібно зробити, це спостерігати за транзакцією, щоб вивести $\text{outpoint}$:

$$  P_0 = B + \text{hash}(\text{inputHash} \cdot b \cdot A \text{ ‖ } 0) \cdot G  $$

Коли він знаходить дійсний $P_0$, він може розрахувати відповідний приватний ключ $p_0$:

$$ 
p_0 = (b + \text{hash}(\text{inputHash} \cdot b \cdot A \text{ ‖ } 0)) \bmod n
 $$

![BTC204](assets/notext/67/04.webp)

*Легенда:*
- $B$: Публічний ключ / статична адреса, опублікована Бобом
- $b$: Приватний ключ Боба
- $A$: Публічний ключ UTXO Аліси, який використовується як вхід для транзакції
- $a$: Приватний ключ Аліси
- $H$: Хеш UTXO, який використовується як вхід
- $G$: Точка генератора еліптичної кривої `secp256k1`
- $\text{SHA256}$: Функція хешування SHA256 з тегом `BIP0352/SharedSecret`
- $s_0$: Перший спільний секрет ECDH
- $P_0$: Перший публічний ключ / унікальна адреса для платежу Бобу

Наразі наші розрахунки передбачають, що Аліса використовує один вхід для своєї транзакції. Однак, вона повинна мати можливість використовувати кілька входів. Відповідно, з боку Боба, для кожної транзакції, що містить кілька входів, йому теоретично потрібно було б розрахувати ECDH для кожного входу, щоб визначити, чи призначений платіж для нього. Цей метод не задовольняє, тому нам потрібно знайти рішення, щоб зменшити робоче навантаження!

### Модифікація публічних ключів у входах

Щоб вирішити цю проблему, замість використання пари ключів, які забезпечують конкретний вхід з боку Аліси, ми будемо використовувати суму всіх пар ключів, використаних у входах транзакції. Ця сума потім буде розглядатися як нова пара ключів. Ця техніка відома як "модифікація".

Наприклад, уявімо, що транзакція Аліси має 3 входи, кожен з яких забезпечений різною парою ключів:
- $a_0$ забезпечує вхід №0;
- $a_1$ забезпечує вхід №1;
- $a_2$ забезпечує вхід №2.

![BTC204](assets/notext/67/05.webp)

Слідуючи вищеописаному методу, Алісі довелося б вибрати одну пару ключів серед $a_0$, $a_1$ та $a_2$, щоб розрахувати секрет ECDH і генерувати унікальну адресу платежу $P$ зі статичної адреси Боба $B$. Однак, цей підхід вимагає від Боба послідовно тестувати кожну можливість, починаючи з $a_0$, потім $a_1$, і так далі, до ідентифікації пари, яка генерує дійсну адресу $P$. Цей процес вимагає від Боба виконання розрахунку ECDH на всіх входах усіх транзакцій, значно збільшуючи робоче навантаження при скануванні.

Щоб уникнути цього, ми попросимо Алісу виконати свій розрахунок $P$, використовуючи суму всіх ключів на вході. Взявши наш приклад, модифікований приватний ключ $a$ буде розраховано так:

$$  a = a_0 + a_1 + a_2  $$
Аналогічно, Аліса та Боб зможуть розрахувати модифікований публічний ключ:
$$  A = A_0 + A_1 + A_2  $$
Завдяки цьому методу, Бобу потрібно лише розрахувати суму публічних ключів транзакції, а потім обчислити секрет ECDH з $A$, що значно зменшує кількість обчислень, необхідних для етапу сканування. Однак, пам'ятайте з попереднього розділу. Ми включили в наші розрахунки хеш $\text{inputHash}$, який використовується як nonce для запобігання повторному використанню адреси:

$$  \text{inputHash} = \text{hash}(\text{outpoint} \text{ ‖ } A)  $$

Але якщо в транзакції є кілька входів, необхідно визначити, який $\text{outpoint}$ вибирається в цьому розрахунку. Згідно з BIP352, критерій вибору $\text{outpoint}$ для використання полягає у виборі найменшого лексикографічно, що означає вибір UTXO, який з'являється першим в алфавітному порядку. Цей метод стандартизує вибір UTXO в кожній транзакції. Наприклад, якщо цей найменший $\text{outpoint}$ лексикографічно є $\text{outpoint}_L$, розрахунок $\text{inputHash}$ буде:

$$  \text{inputHash} = \text{hash}(\text{outpoint}_L \text{ ‖ } A)  $$

Розрахунки залишаються ідентичними до тих, що були представлені в попередньому розділі, за винятком того, що приватний ключ $a$ та відповідний йому публічний ключ $A$ більше не є парою, що забезпечує захист одного входу, а тепер представляють модифікацію всіх пар ключів на входах.

### Розділення ключів для витрат та сканування

Досі ми обговорювали статичну адресу Silent Payment $B$ як унікальний публічний ключ. Пам'ятайте, саме цей публічний ключ $B$ використовується Алісою для створення спільного секрету ECDH, який, в свою чергу, використовується для обчислення унікальної адреси платежу $P$. Боб використовує цей публічний ключ $B$ та відповідний приватний ключ $b$ для етапу сканування. Але він також використовуватиме приватний ключ $b$ для обчислення приватного ключа $p$, який дозволяє здійснювати витрати з адреси $P$.

Недоліком цього методу є те, що приватний ключ $b$, який використовується для обчислення всіх приватних ключів для адрес, що отримують Silent Payments, також використовується Бобом для сканування транзакцій. Цей етап вимагає, щоб ключ $b$ був доступний у програмному забезпеченні гаманця, підключеному до інтернету, що піддає його більшому ризику крадіжки порівняно з його зберіганням на холодному гаманці. Ідеально було б можливість використовувати переваги Silent Payments, зберігаючи приватний ключ $b$, який контролює доступ до всіх інших приватних ключів, захищеним на апаратному гаманці. На щастя, протокол було адаптовано для того, щоб дозволити саме це.
Для досягнення цього, BIP352 вказує, що одержувач використовує 2 різні пари ключів:
- $B_{\text{spend}}$: для обчислення приватних ключів унікальних адрес платежів;
- $B_{\text{scan}}$: для пошуку унікальних адрес платежів.

Таким чином, Боб може зберігати приватний ключ $b_{\text{spend}}$ на апаратному гаманці та використовувати приватний ключ $b_{\text{scan}}$ на програмному забезпеченні онлайн для пошуку своїх Silent Payments, не розкриваючи $b_{\text{spend}}$. Однак, публічні ключі $B_{\text{scan}}$ та $B_{\text{spend}}$ обидва публічно розкриваються, оскільки вони знаходяться в статичній адресі Боба $B$:
$$  B = B_{\text{scan}} \text{ ‖ } B_{\text{spend}} $$
Щоб розрахувати унікальну платіжну адресу $P_0$, яка належить Бобу, Аліса тепер виконає наступний розрахунок:

$$  P_0 = B_{\text{spend}} + \text{hash}(\text{inputHash} \cdot a \cdot B_{\text{scan}} \text{ ‖ } 0) \cdot G  $$

Щоб знайти платежі, адресовані йому, Боб виконає наступний розрахунок:

$$  P_0 = B_{\text{spend}} + \text{hash}(\text{inputHash} \cdot b_{\text{scan}} \cdot A \text{ ‖ } 0) \cdot G  $$

Як ви можете бачити, до цього моменту Бобу не потрібно було використовувати $b_{\text{spend}}$, який знаходиться на його апаратному гаманці. Коли він захоче витратити $P_0$, він може тоді виконати наступний розрахунок, щоб знайти приватний ключ $p_0$:

$$ p_0 = (b_{\text{spend}} + \text{hash}(\text{inputHash} \cdot b_{\text{scan}} \cdot A \text{ ‖ } 0)) \bmod n $$

![BTC204](assets/notext/67/06.webp)

*Підпис:*
- $B_{\text{scan}}$: Публічний ключ сканування Боба (статична адреса)
- $b_{\text{scan}}$: Приватний ключ сканування Боба
- $B_{\text{spend}}$: Публічний ключ витрат Боба (статична адреса)
- $b_{\text{spend}}$: Приватний ключ витрат Боба
- $A$: Сума публічних ключів на вході (корекція)
- $a$: Приватний ключ, що відповідає скоригованому публічному ключу
- $H$: Хеш найменшого UTXO (лексикографічно) використаного на вході
- $G$: Генераторна точка еліптичної кривої `secp256k1`
- $\text{SHA256}$: Функція хешування SHA256 з тегом `BIP0352/SharedSecret`
- $s_0$: Перший спільний секрет ECDH
- $P_0$: Перший публічний ключ / унікальна платіжна адреса для Боба

### Використання SP адрес з міткою

Таким чином, Боб має статичну адресу $B$ для Тихих Платежів наступним чином:

$$ B = B_{\text{scan}} \text{ ‖ } B_{\text{spend}} $$

Проблема з цим методом полягає в тому, що він не дозволяє сегрегувати різні платежі, надіслані на цю адресу. Наприклад, якщо у Боба є 2 різних клієнти для його бізнесу і він хоче чітко розрізняти платежі від кожного, йому знадобиться 2 різні статичні адреси. Наївне рішення, з поточним підходом, було б для Боба створити два окремі гаманці, кожен зі своєю статичною адресою, або навіть встановити дві різні статичні адреси в межах одного гаманця. Однак, це рішення вимагає сканування всього блокчейну двічі (один раз для кожної адреси), щоб відповідно виявити платежі, призначені для кожної адреси. Це подвійне сканування нераціонально збільшує оперативне навантаження на Боба.
Щоб вирішити цю проблему, BIP352 використовує систему маркування, яка дозволяє мати різні статичні адреси без нераціонального збільшення робочого навантаження для пошуку Тихих Платежів у блокчейні. Для цього, до публічного ключа витрат $B_{\text{spend}}$ додається ціле число $m$. Це число може приймати значення $1$ для першої статичної адреси, потім $2$ для другої, і так далі. Ключі витрат $B_{\text{spend}}$ відтепер будуть називатися $B_m$ і будуть конструйовані таким чином:
$$  B_m = B_{\text{spend}} + \text{hash}(b_{\text{scan}} \text{ ‖ } m) \cdot G  $$

Наприклад, для першого ключа витрат з маркуванням $1$:

$$  B_1 = B_{\text{spend}} + \text{hash}(b_{\text{scan}} \text{ ‖ } 1) \cdot G  $$

Статична адреса, опублікована Бобом, тепер складатиметься з $B_{\text{scan}}$ та $B_m$. Наприклад, перша статична адреса з маркуванням $1$ буде:

$$ B = B_{\text{scan}} \text{ ‖ } B_1 $$

> *Ми починаємо лише з маркування 1, оскільки маркування 0 зарезервоване для решти.*

Зі свого боку, Аліса виведе унікальну адресу платежу $P$ таким же чином, як і раніше, але використовуючи новий $B_1$ замість $B_{\text{spend}}$.
$$  P_0 = B_1 + \text{hash}(\text{inputHash} \cdot a \cdot B_{\text{scan}} \text{ ‖ } 0) \cdot G  $$

На практиці, Аліса може навіть не знати, що у Боба є маркована адреса, оскільки вона просто використовує другу частину статичної адреси, яку він їй надав, яка в цьому випадку є значенням $B_1$, а не $B_{\text{spend}}$.

Для сканування платежів Боб завжди використовуватиме значення своєї початкової статичної адреси з $B_{\text{spend}}$ таким чином:

$$   P_0 = B_{\text{spend}} + \text{hash}(\text{inputHash} \cdot b_{\text{scan}} \cdot A \text{ ‖ } 0) \cdot G  $$

Потім він просто віднімає знайдене значення для $P_0$ від кожного виходу по черзі. Потім він перевіряє, чи один з результатів цих віднімань відповідає значенню одного з маркувань, які він використовує у своєму гаманці. Якщо воно відповідає, наприклад, для виходу №4 з маркуванням $1$, це означає, що цей вихід є Тихим Платежем, асоційованим з його маркованою статичною адресою $B_1$:

$$ Out_4 - P_0 = \text{hash}(b_{\text{scan}} \text{ ‖ } 1) \cdot G $$

Це працює тому, що:

$$  B_1 = B_{\text{spend}} + \text{hash}(b_{\text{scan}} \text{ ‖ } 1) \cdot G  $$
Завдяки цьому методу, Боб може використовувати безліч статичних адрес ($B_1$, $B_2$, $B_3$...), всі вони походять від його базової статичної адреси ($B = B_{\text{scan}} \text{ ‖ } B_{\text{spend}}$), щоб належним чином розділити використання.
Однак, це розділення статичних адрес є дійсним лише з точки зору управління особистим гаманцем і не дозволяє розділити ідентичності. Оскільки всі вони мають однаковий $B_{\text{scan}}$, дуже легко асоціювати всі статичні адреси разом і зробити висновок, що вони належать одній сутності.

![BTC204](assets/notext/67/07.webp)

*Підпис:*
- $B_{\text{scan}}$: публічний ключ сканування Боба (статична адреса)
- $b_{\text{scan}}$: приватний ключ сканування Боба
- $B_{\text{spend}}$: публічний ключ витрат Боба (початкова адреса)
- $B_m$: позначений публічний ключ витрат Боба (статична адреса)
- $b_m$: позначений приватний ключ витрат Боба
- $A$: сума вхідних публічних ключів (модифікація)
- $a$: приватний ключ, що відповідає модифікованому публічному ключу
- $H$: хеш найменшого UTXO (лексикографічно), використаного як вхід
- $G$: точка генерації еліптичної кривої `secp256k1`
- $\text{SHA256}$: функція хешування SHA256 з тегом `BIP0352/SharedSecret`
- $s_0$: перший спільний секрет ECDH
- $P_0$: перший публічний ключ / унікальна адреса для платежу Бобу
- $p_0$: приватний ключ першої унікальної платіжної адреси Бобу
- $X$: хеш приватного ключа сканування з міткою

### Як створити адресу для тихих платежів?

Щоб створити спеціалізовану адресу для тихих платежів, спочатку потрібно отримати 2 пари ключів у своєму Bitcoin HD гаманці:
- Пару $b_{\text{scan}}$, $B_{\text{scan}}$ для пошуку платежів, адресованих нам;
- Пару $b_{\text{spend}}$, $B_{\text{spend}}$ для витрачання отриманих нами біткойнів.

Ці пари отримують, слідуючи таким шляхам (*Bitcoin Mainnet*):

```text
scan: m / 352' / 0' / 0' / 1' / 0
spend: m / 352' / 0' / 0' / 0' / 0
```

Отримавши ці 2 пари ключів, їх просто конкатенують (кінець до кінця), щоб створити навантаження статичної адреси:

$$ B = B_{\text{scan}} \text{ ‖ } B_{\text{spend}} $$

Якщо хочеться використовувати мітки, $B_{\text{spend}}$ замінюється на $B_m$:

$$ B = B_{\text{scan}} \text{ ‖ } B_m $$

З міткою $m$:

$$  B_m = B_{\text{spend}} + \text{hash}(b_{\text{scan}} \text{ ‖ } m) \cdot G  $$

Отримавши це навантаження, додають HRP (*Human-Readable Part*) `sp` та версію `q` (= версія 0). Також додається контрольна сума, і адреса форматується у bech32m.
Наприклад, ось моя статична адреса Silent Payments:
```text
sp1qqvhjvsq2vz8zwrw372vuzle7472zup2ql3pz64yn5cpkw5ngv2n6jq4nl8cgm6zmu48yk3eq33ryc7aam6jrvrg0d0uuyzecfhx2wgsumcurv77e
```
Важливий момент щодо статичних адрес, про які ви могли ввести в попередніх розділах, полягає в тому, що ці адреси не видимі в транзакціях Bitcoin. На блокчейні в стандартному форматі Taproot з'являються лише адреси платежів $P$, які використовуються в виходах. Таким чином, ззовні неможливо відрізнити транзакцію з використанням Silent Payment від звичайної транзакції з використанням виходів P2TR.
Так само, як і з BIP47, неможливо встановити зв'язок між статичною адресою $B$ та адресою платежу $P$, отриманою з $B$. Дійсно, навіть якщо Єва, потенційний нападник, спробує сканувати блокчейн зі статичною адресою Боба $B$, вона не зможе виконати необхідні розрахунки, щоб визначити $P$. Для цього їй було б потрібно або приватний ключ сканування Боба $b_{\text{scan}}$, або приватні ключі відправника $a$, але обидва ці елементи, звичайно, є приватними. Тому можливо явно пов'язати свою статичну адресу з формою особистої ідентичності.

### Як користуватися Silent Payments?

Пропозиція щодо Silent Payments є відносно недавньою і поки що була реалізована лише обмеженою кількістю гаманців. На моє знання, існує лише 3 програми, які їх підтримують:
- [CakeWallet](https://cakewallet.com/)
- [Silentium](https://app.silentium.dev/)
- [DonationWallet](https://github.com/Sosthene00/donationwallet)

Незабаром ми запропонуємо детальний підручник з налаштування вашої власної статичної адреси Silent Payments.

Оскільки ця функція є недавньою, радимо бути обережними та уникати використання Silent Payments для великих сум на основній мережі.

*Для створення цього розділу про Silent Payments я використав [сайт пояснень Silent Payments](https://silentpayments.xyz/) та [документ пояснення BIP352](https://github.com/bitcoin/bips/blob/master/bip-0352.mediawiki).*

## Дайте нам зворотній зв'язок про цей курс
<chapterId>195d149f-80fa-5816-8b46-995a9226d082</chapterId>
<isCourseReview>true</isCourseReview>

## Висновок
<chapterId>cd8e5c67-50e4-4dcd-8e04-88ba5ec95305</chapterId>

Вітаємо з завершенням цього навчання про конфіденційність у Bitcoin!

Ми розглянули багато складних та технічних тем у цьому навчанні, але не обов'язково використовувати всі представлені інструменти. Основна мета полягала в тому, щоб надати вам можливість вибирати, яку інформацію ви хочете розкрити, а яку інформацію ви вважаєте за краще зберегти в таємниці при використанні Bitcoin. Це втілює саму суть захисту конфіденційності. Для того, щоб робити обізнані вибори щодо інформації, яку ділитися або приховувати, необхідно бути свідомим наслідків наших дій. Сподіваюся, це навчання допомогло вам отримати ці знання.
Якби мені довелося вибрати найважливішу частину цього навчання, я б вибрав розділ, присвячений аналізу ланцюгів. Розуміння технік, які використовують ваші потенційні нападники, є найкращим способом захистити себе. Тому моя порада була б ретельно переглянути цю частину та спробувати зрозуміти всі її деталі.
У цьому навчанні ми зосередилися виключно на приватності Bitcoin на основному ланцюзі. Проблеми приватності на системах другого рівня, таких як Lightning Network та бічні ланцюги, також є значними і мають дуже специфічні характеристики. Хоча використання транзакцій поза ланцюгом може бути ефективною стратегією для обходу багатьох ризиків відстеження на Bitcoin, які ми вивчили, це виставляє вас перед іншими ризиками, про які також важливо знати. Саме тому ці теми будуть розглянуті на майбутньому спеціалізованому навчанні на PlanB Network.
Якщо вам сподобалося це навчання, я був би дуже вдячний, якби ви могли поділитися ним зі своїми друзями та в соціальних мережах. Дякую! :)